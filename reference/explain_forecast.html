<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Explain a forecast from time series models with dependence-aware (conditional/observational) Shapley values — explain_forecast • shapr</title><script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Explain a forecast from time series models with dependence-aware (conditional/observational) Shapley values — explain_forecast"><meta name="description" content="Computes dependence-aware Shapley values for observations in explain_idx from the specified
model by using the method specified in approach to estimate the conditional expectation.
See
Aas, et. al (2021)
for a thorough introduction to dependence-aware prediction explanation with Shapley values."><meta property="og:description" content="Computes dependence-aware Shapley values for observations in explain_idx from the specified
model by using the method specified in approach to estimate the conditional expectation.
See
Aas, et. al (2021)
for a thorough introduction to dependence-aware prediction explanation with Shapley values."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">shapr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.2.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-vignettes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Vignettes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-vignettes"><li><a class="dropdown-item" href="../articles/general_usage.html">General usage of shapr</a></li>
    <li><a class="dropdown-item" href="../articles/vaeac.html">Advanced usage of the `vaeac` approach</a></li>
    <li><a class="dropdown-item" href="../articles/regression.html">The separate and surrogate regression approches</a></li>
    <li><a class="dropdown-item" href="../articles/asymmetric_causal.html">Asymmetric and Causal Shapley values</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Manual</a></li>
<li class="nav-item"><a class="nav-link" href="../shaprpy.html">Python</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/NorskRegnesentral/shapr/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch"><li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Explain a forecast from time series models with dependence-aware (conditional/observational) Shapley values</h1>
      <small class="dont-index">Source: <a href="https://github.com/NorskRegnesentral/shapr/blob/master/R/explain_forecast.R" class="external-link"><code>R/explain_forecast.R</code></a></small>
      <div class="d-none name"><code>explain_forecast.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Computes dependence-aware Shapley values for observations in <code>explain_idx</code> from the specified
<code>model</code> by using the method specified in <code>approach</code> to estimate the conditional expectation.
See
<a href="https://martinjullum.com/publication/aas-2021-explaining/aas-2021-explaining.pdf" class="external-link">Aas, et. al (2021)</a>
for a thorough introduction to dependence-aware prediction explanation with Shapley values.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">explain_forecast</span><span class="op">(</span></span>
<span>  <span class="va">model</span>,</span>
<span>  <span class="va">y</span>,</span>
<span>  xreg <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  train_idx <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">explain_idx</span>,</span>
<span>  <span class="va">explain_y_lags</span>,</span>
<span>  explain_xreg_lags <span class="op">=</span> <span class="va">explain_y_lags</span>,</span>
<span>  <span class="va">horizon</span>,</span>
<span>  <span class="va">approach</span>,</span>
<span>  <span class="va">phi0</span>,</span>
<span>  max_n_coalitions <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  iterative <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  group_lags <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  group <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  n_MC_samples <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  predict_model <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  get_model_specs <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  verbose <span class="op">=</span> <span class="st">"basic"</span>,</span>
<span>  extra_computation_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  iterative_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  output_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-model">model<a class="anchor" aria-label="anchor" href="#arg-model"></a></dt>
<dd><p>Model object.
Specifies the model whose predictions we want to explain.
Run <code><a href="get_supported_models.html">get_supported_models()</a></code>
for a table of which models <code>explain</code> supports natively. Unsupported models
can still be explained by passing <code>predict_model</code> and (optionally) <code>get_model_specs</code>,
see details for more information.</p></dd>


<dt id="arg-y">y<a class="anchor" aria-label="anchor" href="#arg-y"></a></dt>
<dd><p>Matrix, data.frame/data.table or a numeric vector.
Contains the endogenous variables used to estimate the (conditional) distributions
needed to properly estimate the conditional expectations in the Shapley formula
including the observations to be explained.</p></dd>


<dt id="arg-xreg">xreg<a class="anchor" aria-label="anchor" href="#arg-xreg"></a></dt>
<dd><p>Matrix, data.frame/data.table or a numeric vector.
Contains the exogenous variables used to estimate the (conditional) distributions
needed to properly estimate the conditional expectations in the Shapley formula
including the observations to be explained.
As exogenous variables are used contemporaneously when producing a forecast,
this item should contain nrow(y) + horizon rows.</p></dd>


<dt id="arg-train-idx">train_idx<a class="anchor" aria-label="anchor" href="#arg-train-idx"></a></dt>
<dd><p>Numeric vector.
The row indices in data and reg denoting points in time to use when estimating the conditional expectations in
the Shapley value formula.
If <code>train_idx = NULL</code> (default) all indices not selected to be explained will be used.</p></dd>


<dt id="arg-explain-idx">explain_idx<a class="anchor" aria-label="anchor" href="#arg-explain-idx"></a></dt>
<dd><p>Numeric vector.
The row indices in data and reg denoting points in time to explain.</p></dd>


<dt id="arg-explain-y-lags">explain_y_lags<a class="anchor" aria-label="anchor" href="#arg-explain-y-lags"></a></dt>
<dd><p>Numeric vector.
Denotes the number of lags that should be used for each variable in <code>y</code> when making a forecast.</p></dd>


<dt id="arg-explain-xreg-lags">explain_xreg_lags<a class="anchor" aria-label="anchor" href="#arg-explain-xreg-lags"></a></dt>
<dd><p>Numeric vector.
If <code>xreg != NULL</code>, denotes the number of lags that should be used for each variable in <code>xreg</code> when making a forecast.</p></dd>


<dt id="arg-horizon">horizon<a class="anchor" aria-label="anchor" href="#arg-horizon"></a></dt>
<dd><p>Numeric.
The forecast horizon to explain. Passed to the <code>predict_model</code> function.</p></dd>


<dt id="arg-approach">approach<a class="anchor" aria-label="anchor" href="#arg-approach"></a></dt>
<dd><p>Character vector of length <code>1</code> or one less than the number of features.
All elements should, either be <code>"gaussian"</code>, <code>"copula"</code>, <code>"empirical"</code>, <code>"ctree"</code>, <code>"vaeac"</code>,
<code>"categorical"</code>, <code>"timeseries"</code>, <code>"independence"</code>, <code>"regression_separate"</code>, or <code>"regression_surrogate"</code>.
The two regression approaches can not be combined with any other approach.
See details for more information.</p></dd>


<dt id="arg-phi-">phi0<a class="anchor" aria-label="anchor" href="#arg-phi-"></a></dt>
<dd><p>Numeric.
The prediction value for unseen data, i.e. an estimate of the expected prediction without conditioning on any
features.
Typically we set this value equal to the mean of the response variable in our training data, but other choices
such as the mean of the predictions in the training data are also reasonable.</p></dd>


<dt id="arg-max-n-coalitions">max_n_coalitions<a class="anchor" aria-label="anchor" href="#arg-max-n-coalitions"></a></dt>
<dd><p>Integer.
The upper limit on the number of unique feature/group coalitions to use in the iterative procedure
(if <code>iterative = TRUE</code>).
If <code>iterative = FALSE</code> it represents the number of feature/group coalitions to use directly.
The quantity refers to the number of unique feature coalitions if <code>group = NULL</code>,
and group coalitions if <code>group != NULL</code>.
<code>max_n_coalitions = NULL</code> corresponds to <code>max_n_coalitions=2^n_features</code>.</p></dd>


<dt id="arg-iterative">iterative<a class="anchor" aria-label="anchor" href="#arg-iterative"></a></dt>
<dd><p>Logical or NULL
If <code>NULL</code> (default), the argument is set to <code>TRUE</code> if there are more than 5 features/groups, and <code>FALSE</code> otherwise.
If eventually <code>TRUE</code>, the Shapley values are estimated iteratively in an iterative manner.
This provides sufficiently accurate Shapley value estimates faster.
First an initial number of coalitions is sampled, then bootsrapping is used to estimate the variance of the Shapley
values.
A convergence criterion is used to determine if the variances of the Shapley values are sufficiently small.
If the variances are too high, we estimate the number of required samples to reach convergence, and thereby add more
coalitions.
The process is repeated until the variances are below the threshold.
Specifics related to the iterative process and convergence criterion are set through <code>iterative_args</code>.</p></dd>


<dt id="arg-group-lags">group_lags<a class="anchor" aria-label="anchor" href="#arg-group-lags"></a></dt>
<dd><p>Logical.
If <code>TRUE</code> all lags of each variable are grouped together and explained as a group.
If <code>FALSE</code> all lags of each variable are explained individually.</p></dd>


<dt id="arg-group">group<a class="anchor" aria-label="anchor" href="#arg-group"></a></dt>
<dd><p>List.
If <code>NULL</code> regular feature wise Shapley values are computed.
If provided, group wise Shapley values are computed.
<code>group</code> then has length equal to the number of groups.
The list element contains character vectors with the features included in each of the different groups.
See
<a href="https://martinjullum.com/publication/jullum-2021-efficient/jullum-2021-efficient.pdf" class="external-link">Jullum et al. (2021)</a>
for more information on group wise Shapley values.</p></dd>


<dt id="arg-n-mc-samples">n_MC_samples<a class="anchor" aria-label="anchor" href="#arg-n-mc-samples"></a></dt>
<dd><p>Positive integer.
For most approaches, it indicates the maximum number of samples to use in the Monte Carlo integration
of every conditional expectation.
For <code>approach="ctree"</code>, <code>n_MC_samples</code> corresponds to the number of samples
from the leaf node (see an exception related to the <code>ctree.sample</code> argument <code><a href="setup_approach.html">setup_approach.ctree()</a></code>).
For <code>approach="empirical"</code>, <code>n_MC_samples</code> is  the \(K\) parameter in equations (14-15) of
Aas et al. (2021), i.e. the maximum number of observations (with largest weights) that is used, see also the
<code>empirical.eta</code> argument <code><a href="setup_approach.html">setup_approach.empirical()</a></code>.</p></dd>


<dt id="arg-seed">seed<a class="anchor" aria-label="anchor" href="#arg-seed"></a></dt>
<dd><p>Positive integer.
Specifies the seed before any randomness based code is being run.
If <code>NULL</code> no seed is set in the calling environment.</p></dd>


<dt id="arg-predict-model">predict_model<a class="anchor" aria-label="anchor" href="#arg-predict-model"></a></dt>
<dd><p>Function.
The prediction function used when <code>model</code> is not natively supported.
(Run <code><a href="get_supported_models.html">get_supported_models()</a></code> for a list of natively supported models.)
The function must have two arguments, <code>model</code> and <code>newdata</code> which specify, respectively, the model
and a data.frame/data.table to compute predictions for.
The function must give the prediction as a numeric vector.
<code>NULL</code> (the default) uses functions specified internally.
Can also be used to override the default function for natively supported model classes.</p></dd>


<dt id="arg-get-model-specs">get_model_specs<a class="anchor" aria-label="anchor" href="#arg-get-model-specs"></a></dt>
<dd><p>Function.
An optional function for checking model/data consistency when <code>model</code> is not natively supported.
(Run <code><a href="get_supported_models.html">get_supported_models()</a></code> for a list of natively supported models.)
The function takes <code>model</code> as argument and provides a list with 3 elements:</p><dl><dt>labels</dt>
<dd><p>Character vector with the names of each feature.</p></dd>

<dt>classes</dt>
<dd><p>Character vector with the classes of each features.</p></dd>

<dt>factor_levels</dt>
<dd><p>Character vector with the levels for any categorical features.</p></dd>


</dl><p>If <code>NULL</code> (the default) internal functions are used for natively supported model classes, and the checking is
disabled for unsupported model classes.
Can also be used to override the default function for natively supported model classes.</p></dd>


<dt id="arg-verbose">verbose<a class="anchor" aria-label="anchor" href="#arg-verbose"></a></dt>
<dd><p>String vector or NULL.
Specifies the verbosity (printout detail level) through one or more of strings <code>"basic"</code>, <code>"progress"</code>,
<code>"convergence"</code>, <code>"shapley"</code> and <code>"vS_details"</code>.
<code>"basic"</code> (default) displays basic information about the computation which is being performed.
<code>"progress</code> displays information about where in the calculation process the function currently is.
#' <code>"convergence"</code> displays information on how close to convergence the Shapley value estimates are
(only when <code>iterative = TRUE</code>) .
<code>"shapley"</code> displays intermediate Shapley value estimates and standard deviations (only when <code>iterative = TRUE</code>)</p><ul><li><p>the final estimates.
<code>"vS_details"</code> displays information about the v_S estimates.
This is most relevant for <code>approach %in% c("regression_separate", "regression_surrogate", "vaeac"</code>).
<code>NULL</code> means no printout.
Note that any combination of four strings can be used.
E.g. <code>verbose = c("basic", "vS_details")</code> will display basic information + details about the v(S)-estimation process.</p></li>
</ul></dd>


<dt id="arg-extra-computation-args">extra_computation_args<a class="anchor" aria-label="anchor" href="#arg-extra-computation-args"></a></dt>
<dd><p>Named list.
Specifies extra arguments related to the computation of the Shapley values.
See <code><a href="get_extra_comp_args_default.html">get_extra_comp_args_default()</a></code> for description of the arguments and their default values.</p></dd>


<dt id="arg-iterative-args">iterative_args<a class="anchor" aria-label="anchor" href="#arg-iterative-args"></a></dt>
<dd><p>Named list.
Specifies the arguments for the iterative procedure.
See <code><a href="get_iterative_args_default.html">get_iterative_args_default()</a></code> for description of the arguments and their default values.</p></dd>


<dt id="arg-output-args">output_args<a class="anchor" aria-label="anchor" href="#arg-output-args"></a></dt>
<dd><p>Named list.
Specifies certain arguments related to the output of the function.
See <code><a href="get_output_args_default.html">get_output_args_default()</a></code> for description of the arguments and their default values.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Arguments passed on to <code><a href="setup_approach.html">setup_approach.categorical</a></code>, <code><a href="setup_approach.html">setup_approach.copula</a></code>, <code><a href="setup_approach.html">setup_approach.ctree</a></code>, <code><a href="setup_approach.html">setup_approach.empirical</a></code>, <code><a href="setup_approach.html">setup_approach.gaussian</a></code>, <code><a href="setup_approach.html">setup_approach.independence</a></code>, <code><a href="setup_approach.html">setup_approach.timeseries</a></code>, <code><a href="setup_approach.html">setup_approach.vaeac</a></code></p><dl><dt><code>categorical.joint_prob_dt</code></dt>
<dd><p>Data.table. (Optional)
Containing the joint probability distribution for each combination of feature
values.
<code>NULL</code> means it is estimated from the <code>x_train</code> and <code>x_explain</code>.</p></dd>

    <dt><code>categorical.epsilon</code></dt>
<dd><p>Numeric value. (Optional)
If <code>categorical.joint_probability_dt</code> is not supplied, probabilities/frequencies are
estimated using <code>x_train</code>. If certain observations occur in <code>x_explain</code> and NOT in <code>x_train</code>,
then epsilon is used as the proportion of times that these observations occurs in the training data.
In theory, this proportion should be zero, but this causes an error later in the Shapley computation.</p></dd>

    <dt><code>internal</code></dt>
<dd><p>List.
Not used directly, but passed through from <code><a href="explain.html">explain()</a></code>.</p></dd>

    <dt><code>ctree.mincriterion</code></dt>
<dd><p>Numeric scalar or vector.
Either a scalar or vector of length equal to the number of features in the model.
The value is equal to 1 - \(\alpha\) where \(\alpha\) is the nominal level of the conditional independence tests.
If it is a vector, this indicates which value to use when conditioning on various numbers of features.
The default value is 0.95.</p></dd>

    <dt><code>ctree.minsplit</code></dt>
<dd><p>Numeric scalar.
Determines minimum value that the sum of the left and right daughter nodes required for a split.
The default value is 20.</p></dd>

    <dt><code>ctree.minbucket</code></dt>
<dd><p>Numeric scalar.
Determines the minimum sum of weights in a terminal node required for a split
The default value is 7.</p></dd>

    <dt><code>ctree.sample</code></dt>
<dd><p>Boolean.
If <code>TRUE</code> (default), then the method always samples <code>n_MC_samples</code> observations from the leaf nodes
(with replacement).
If <code>FALSE</code> and the number of observations in the leaf node is less than <code>n_MC_samples</code>,
the method will take all observations in the leaf.
If <code>FALSE</code> and the number of observations in the leaf node is more than <code>n_MC_samples</code>,
the method will sample <code>n_MC_samples</code> observations (with replacement).
This means that there will always be sampling in the leaf unless
<code>sample = FALSE</code> <em>and</em> the number of obs in the node is less than <code>n_MC_samples</code>.</p></dd>

    <dt><code>empirical.type</code></dt>
<dd><p>Character. (default = <code>"fixed_sigma"</code>)
Should be equal to either <code>"independence"</code>,<code>"fixed_sigma"</code>, <code>"AICc_each_k"</code> <code>"AICc_full"</code>.
<code>"independence"</code> is deprecated. Use <code>approach = "independence"</code> instead.
<code>"fixed_sigma"</code> uses a fixed bandwidth (set through <code>empirical.fixed_sigma</code>) in the kernel density estimation.
<code>"AICc_each_k"</code> and <code>"AICc_full"</code> optimize the bandwidth using the AICc criterion, with respectively
one bandwidth per coalition size and one bandwidth for all coalition sizes.</p></dd>

    <dt><code>empirical.eta</code></dt>
<dd><p>Numeric scalar.
Needs to be <code>0 &lt; eta &lt;= 1</code>.
The default value is 0.95.
Represents the minimum proportion of the total empirical weight that data samples should use.
If e.g. <code>eta = .8</code> we will choose the <code>K</code> samples with the largest weight so that the sum of the weights
accounts for 80\<!-- % of the total weight. -->
<code>eta</code> is the \(\eta\) parameter in equation (15) of
<a href="https://martinjullum.com/publication/aas-2021-explaining/aas-2021-explaining.pdf" class="external-link">Aas et al. (2021)</a>.</p></dd>

    <dt><code>empirical.fixed_sigma</code></dt>
<dd><p>Positive numeric scalar.
The default value is 0.1.
Represents the kernel bandwidth in the distance computation used when conditioning on all different coalitions.
Only used when <code>empirical.type = "fixed_sigma"</code></p></dd>

    <dt><code>empirical.n_samples_aicc</code></dt>
<dd><p>Positive integer.
Number of samples to consider in AICc optimization.
The default value is 1000.
Only used for <code>empirical.type</code> is either <code>"AICc_each_k"</code> or <code>"AICc_full"</code>.</p></dd>

    <dt><code>empirical.eval_max_aicc</code></dt>
<dd><p>Positive integer.
Maximum number of iterations when optimizing the AICc.
The default value is 20.
Only used for <code>empirical.type</code> is either <code>"AICc_each_k"</code> or <code>"AICc_full"</code>.</p></dd>

    <dt><code>empirical.start_aicc</code></dt>
<dd><p>Numeric.
Start value of the <code>sigma</code> parameter when optimizing the AICc.
The default value is 0.1.
Only used for <code>empirical.type</code> is either <code>"AICc_each_k"</code> or <code>"AICc_full"</code>.</p></dd>

    <dt><code>empirical.cov_mat</code></dt>
<dd><p>Numeric matrix. (Optional)
The covariance matrix of the data generating distribution used to define the Mahalanobis distance.
<code>NULL</code> means it is estimated from <code>x_train</code>.</p></dd>

    <dt><code>gaussian.mu</code></dt>
<dd><p>Numeric vector. (Optional)
Containing the mean of the data generating distribution.
<code>NULL</code> means it is estimated from the <code>x_train</code>.</p></dd>

    <dt><code>gaussian.cov_mat</code></dt>
<dd><p>Numeric matrix. (Optional)
Containing the covariance matrix of the data generating distribution.
<code>NULL</code> means it is estimated from the <code>x_train</code>.</p></dd>

    <dt><code>timeseries.fixed_sigma</code></dt>
<dd><p>Positive numeric scalar.
Represents the kernel bandwidth in the distance computation.
The default value is 2.</p></dd>

    <dt><code>timeseries.bounds</code></dt>
<dd><p>Numeric vector of length two.
Specifies the lower and upper bounds of the timeseries.
The default is <code>c(NULL, NULL)</code>, i.e. no bounds.
If one or both of these bounds are not <code>NULL</code>, we restrict the sampled time series to be between these bounds.
This is useful if the underlying time series are scaled between 0 and 1, for example.</p></dd>

    <dt><code>vaeac.depth</code></dt>
<dd><p>Positive integer (default is <code>3</code>). The number of hidden layers
in the neural networks of the masked encoder, full encoder, and decoder.</p></dd>

    <dt><code>vaeac.width</code></dt>
<dd><p>Positive integer (default is <code>32</code>). The number of neurons in each
hidden layer in the neural networks of the masked encoder, full encoder, and decoder.</p></dd>

    <dt><code>vaeac.latent_dim</code></dt>
<dd><p>Positive integer (default is <code>8</code>). The number of dimensions in the latent space.</p></dd>

    <dt><code>vaeac.lr</code></dt>
<dd><p>Positive numeric (default is <code>0.001</code>). The learning rate used in the <code><a href="https://torch.mlverse.org/docs/reference/optim_adam.html" class="external-link">torch::optim_adam()</a></code> optimizer.</p></dd>

    <dt><code>vaeac.activation_function</code></dt>
<dd><p>An <code><a href="https://torch.mlverse.org/docs/reference/nn_module.html" class="external-link">torch::nn_module()</a></code> representing an activation function such as, e.g.,
<code><a href="https://torch.mlverse.org/docs/reference/nn_relu.html" class="external-link">torch::nn_relu()</a></code> (default), <code><a href="https://torch.mlverse.org/docs/reference/nn_leaky_relu.html" class="external-link">torch::nn_leaky_relu()</a></code>, <code><a href="https://torch.mlverse.org/docs/reference/nn_selu.html" class="external-link">torch::nn_selu()</a></code>, or <code><a href="https://torch.mlverse.org/docs/reference/nn_sigmoid.html" class="external-link">torch::nn_sigmoid()</a></code>.</p></dd>

    <dt><code>vaeac.n_vaeacs_initialize</code></dt>
<dd><p>Positive integer (default is <code>4</code>). The number of different vaeac models to initiate
in the start. Pick the best performing one after <code>vaeac.extra_parameters$epochs_initiation_phase</code>
epochs (default is <code>2</code>) and continue training that one.</p></dd>

    <dt><code>vaeac.epochs</code></dt>
<dd><p>Positive integer (default is <code>100</code>). The number of epochs to train the final vaeac model.
This includes <code>vaeac.extra_parameters$epochs_initiation_phase</code>, where the default is <code>2</code>.</p></dd>

    <dt><code>vaeac.extra_parameters</code></dt>
<dd><p>Named list with extra parameters to the <code>vaeac</code> approach. See
<code><a href="vaeac_get_extra_para_default.html">vaeac_get_extra_para_default()</a></code> for description of possible additional parameters and their default values.</p></dd>


</dl></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>Object of class <code>c("shapr", "list")</code>. Contains the following items:</p><dl><dt><code>shapley_values_est</code></dt>
<dd><p>data.table with the estimated Shapley values with explained observation in the rows and
features along the columns.
The column <code>none</code> is the prediction not devoted to any of the features (given by the argument <code>phi0</code>)</p></dd>

<dt><code>shapley_values_sd</code></dt>
<dd><p>data.table with the standard deviation of the Shapley values reflecting the uncertainty.
Note that this only reflects the coalition sampling part of the kernelSHAP procedure, and is therefore by
definition 0 when all coalitions is used.
Only present when <code>extra_computation_args$compute_sd=TRUE</code>, which is the default when <code>iterative = TRUE</code></p></dd>

<dt><code>internal</code></dt>
<dd><p>List with the different parameters, data, functions and other output used internally.</p></dd>

<dt><code>pred_explain</code></dt>
<dd><p>Numeric vector with the predictions for the explained observations</p></dd>

<dt><code>MSEv</code></dt>
<dd><p>List with the values of the MSEv evaluation criterion for the approach. See the
<a href="https://norskregnesentral.github.io/shapr/articles/general_usage.html#msev-evaluation-criterion%0A">MSEv evaluation section in the general usage for details</a>.</p></dd>

<dt><code>timing</code></dt>
<dd><p>List containing timing information for the different parts of the computation.
<code>init_time</code> and <code>end_time</code> gives the time stamps for the start and end of the computation.
<code>total_time_secs</code> gives the total time in seconds for the complete execution of <code><a href="explain.html">explain()</a></code>.
<code>main_timing_secs</code> gives the time in seconds for the main computations.
<code>iter_timing_secs</code> gives for each iteration of the iterative estimation, the time spent on the different parts
iterative estimation routine.</p></dd>


</dl></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>This function explains a forecast of length <code>horizon</code>. The argument <code>train_idx</code>
is analogous to x_train in <code><a href="explain.html">explain()</a></code>, however, it just contains the time indices of where
in the data the forecast should start for each training sample. In the same way <code>explain_idx</code>
defines the time index (indices) which will precede a forecast to be explained.</p>
<p>As any autoregressive forecast model will require a set of lags to make a forecast at an
arbitrary point in time, <code>explain_y_lags</code> and <code>explain_xreg_lags</code> define how many lags
are required to "refit" the model at any given time index. This allows the different
approaches to work in the same way they do for time-invariant models.</p>
<p>See the <a href="https://norskregnesentral.github.io/shapr/articles/general_usage.html#forecasting">
forecasting section of the general usages</a> for further details.</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>

<ul><li><p><a href="https://martinjullum.com/publication/aas-2021-explaining/aas-2021-explaining.pdf" class="external-link">
Aas, K., Jullum, M., &amp; Løland, A. (2021). Explaining individual predictions when features are dependent:
More accurate approximations to Shapley values. Artificial Intelligence, 298, 103502</a></p></li>
<li><p><a href="https://proceedings.neurips.cc/paper_files/paper/2020/file/0d770c496aa3da6d2c3f2bd19e7b9d6b-Paper.pdf" class="external-link">
Frye, C., Rowat, C., &amp; Feige, I. (2020). Asymmetric Shapley values:
incorporating causal knowledge into model-agnostic explainability.
Advances in neural information processing systems, 33, 1229-1239</a></p></li>
<li><p><a href="https://proceedings.neurips.cc/paper/2020/file/32e54441e6382a7fbacbbbaf3c450059-Paper.pdf" class="external-link">
Heskes, T., Sijben, E., Bucur, I. G., &amp; Claassen, T. (2020). Causal shapley values:
Exploiting causal knowledge to explain individual predictions of complex models.
Advances in neural information processing systems, 33, 4778-4789</a></p></li>
<li><p><a href="https://martinjullum.com/publication/jullum-2021-efficient/jullum-2021-efficient.pdf" class="external-link">
Jullum, M., Redelmeier, A. &amp; Aas, K. (2021). Efficient and simple prediction explanations with
groupShapley: A practical perspective. Italian Workshop on Explainable Artificial Intelligence 2021.</a></p></li>
<li><p><a href="https://martinjullum.com/publication/redelmeier-2020-explaining/redelmeier-2020-explaining.pdf" class="external-link">
Redelmeier, A., Jullum, M., &amp; Aas, K. (2020). Explaining predictive models with mixed features using Shapley
values and conditional inference trees. In Machine Learning and Knowledge Extraction:
International Cross-Domain Conference, CD-MAKE 2020, Dublin, Ireland, August 25–28, 2020, Proceedings 4
(pp. 117-137). Springer International Publishing.</a></p></li>
<li><p><a href="https://www.theoj.org/joss-papers/joss.02027/10.21105.joss.02027.pdf" class="external-link">
Sellereite N., &amp; Jullum, M. (2019). shapr: An R-package for explaining machine learning models with
dependence-aware Shapley values. Journal of Open Source Software, 5(46), 2027</a></p></li>
<li><p><a href="https://www.jmlr.org/papers/volume23/21-1413/21-1413.pdf" class="external-link">
Olsen, L. H., Glad, I. K., Jullum, M., &amp; Aas, K. (2022). Using Shapley values and variational autoencoders to
explain predictive models with dependent mixed features. Journal of machine learning research, 23(213), 1-51</a></p></li>
<li><p><a href="https://link.springer.com/content/pdf/10.1007/s10618-024-01016-z.pdf" class="external-link">
Olsen, L. H. B., Glad, I. K., Jullum, M., &amp; Aas, K. (2024). A comparative study of methods for estimating
model-agnostic Shapley value explanations. Data Mining and Knowledge Discovery, 1-48</a></p></li>
<li><p><a href="https://arxiv.org/pdf/2410.04883" class="external-link">
Olsen, L. H. B., &amp; Jullum, M. (2024). Improving the Sampling Strategy in KernelSHAP. arXiv e-prints, arXiv-2410</a></p></li>
</ul></div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>Jon Lachmann, Martin Jullum</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="co"># Load example data</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"airquality"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Fit an AR(2) model.</span></span></span>
<span class="r-in"><span><span class="va">model_ar_temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/ar.html" class="external-link">ar</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Temp</span>, order <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Calculate the zero prediction values for a three step forecast.</span></span></span>
<span class="r-in"><span><span class="va">p0_ar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Temp</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Empirical approach, explaining forecasts starting at T = 152 and T = 153.</span></span></span>
<span class="r-in"><span><span class="fu">explain_forecast</span><span class="op">(</span></span></span>
<span class="r-in"><span>  model <span class="op">=</span> <span class="va">model_ar_temp</span>,</span></span>
<span class="r-in"><span>  y <span class="op">=</span> <span class="va">data</span><span class="op">[</span>, <span class="st">"Temp"</span><span class="op">]</span>,</span></span>
<span class="r-in"><span>  train_idx <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">151</span>,</span></span>
<span class="r-in"><span>  explain_idx <span class="op">=</span> <span class="fl">152</span><span class="op">:</span><span class="fl">153</span>,</span></span>
<span class="r-in"><span>  explain_y_lags <span class="op">=</span> <span class="fl">2</span>,</span></span>
<span class="r-in"><span>  horizon <span class="op">=</span> <span class="fl">3</span>,</span></span>
<span class="r-in"><span>  approach <span class="op">=</span> <span class="st">"empirical"</span>,</span></span>
<span class="r-in"><span>  phi0 <span class="op">=</span> <span class="va">p0_ar</span>,</span></span>
<span class="r-in"><span>  group_lags <span class="op">=</span> <span class="cn">FALSE</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Martin Jullum, Lars Henry Berge Olsen, Annabelle Redelmeier, Jon Lachmann, Nikolai Sellereite, Norsk Regnesentral.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

