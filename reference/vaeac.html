<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Initializing a vaeac model — vaeac • shapr</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Initializing a vaeac model — vaeac"><meta property="og:description" content="Class that represents a vaeac model, i.e., the class creates the neural networks in the vaeac
model and necessary training utilities.
For more details, see Olsen et al. (2022)."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">shapr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.2.3.9200</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/understanding_shapr.html">General usage of shapr</a>
    </li>
    <li>
      <a href="../articles/understanding_shapr_vaeac.html">Advanced usage of the `vaeac` approach</a>
    </li>
  </ul></li>
<li>
  <a href="../news/index.html">News</a>
</li>
<li>
  <a href="../reference/index.html">Manual</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/NorskRegnesentral/shapr/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Initializing a vaeac model</h1>
    <small class="dont-index">Source: <a href="https://github.com/NorskRegnesentral/shapr/blob/HEAD/R/approach_vaeac_torch_modules.R" class="external-link"><code>R/approach_vaeac_torch_modules.R</code></a></small>
    <div class="hidden name"><code>vaeac.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Class that represents a vaeac model, i.e., the class creates the neural networks in the vaeac
model and necessary training utilities.
For more details, see <a href="https://www.jmlr.org/papers/volume23/21-1413/21-1413.pdf" class="external-link">Olsen et al. (2022)</a>.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">vaeac</span><span class="op">(</span></span>
<span>  <span class="va">one_hot_max_sizes</span>,</span>
<span>  width <span class="op">=</span> <span class="fl">32</span>,</span>
<span>  depth <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  latent_dim <span class="op">=</span> <span class="fl">8</span>,</span>
<span>  activation_function <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/torch/man/nn_relu.html" class="external-link">nn_relu</a></span>,</span>
<span>  skip_conn_layer <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  skip_conn_masked_enc_dec <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  batch_normalization <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  paired_sampling <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  mask_generator_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mcar_mask_generator"</span>, <span class="st">"specified_prob_mask_generator"</span>,</span>
<span>    <span class="st">"specified_masks_mask_generator"</span><span class="op">)</span>,</span>
<span>  masking_ratio <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>  mask_gen_coalitions <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  mask_gen_coalitions_prob <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  sigma_mu <span class="op">=</span> <span class="fl">10000</span>,</span>
<span>  sigma_sigma <span class="op">=</span> <span class="fl">1e-04</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>one_hot_max_sizes</dt>
<dd><p>A torch tensor of dimension <code>n_features</code> containing the one hot sizes of the <code>n_features</code>
features. That is, if the <code>i</code>th feature is a categorical feature with 5 levels, then <code>one_hot_max_sizes[i] = 5</code>.
While the size for continuous features can either be <code>0</code> or <code>1</code>.</p></dd>


<dt>width</dt>
<dd><p>Integer. The number of neurons in each hidden layer in the neural networks
of the masked encoder, full encoder, and decoder.</p></dd>


<dt>depth</dt>
<dd><p>Integer. The number of hidden layers in the neural networks of the
masked encoder, full encoder, and decoder.</p></dd>


<dt>latent_dim</dt>
<dd><p>Integer. The number of dimensions in the latent space.</p></dd>


<dt>activation_function</dt>
<dd><p>A <code><a href="https://rdrr.io/pkg/torch/man/nn_module.html" class="external-link">torch::nn_module()</a></code> representing an activation function such as, e.g.,
<code><a href="https://rdrr.io/pkg/torch/man/nn_relu.html" class="external-link">torch::nn_relu()</a></code>, <code><a href="https://rdrr.io/pkg/torch/man/nn_leaky_relu.html" class="external-link">torch::nn_leaky_relu()</a></code>, <code><a href="https://rdrr.io/pkg/torch/man/nn_selu.html" class="external-link">torch::nn_selu()</a></code>,
<code><a href="https://rdrr.io/pkg/torch/man/nn_sigmoid.html" class="external-link">torch::nn_sigmoid()</a></code>.</p></dd>


<dt>skip_conn_layer</dt>
<dd><p>Boolean. If we are to use skip connections in each layer, see <code><a href="skip_connection.html">skip_connection()</a></code>.
If <code>TRUE</code>, then we add the input to the outcome of each hidden layer, so the output becomes
\(X + \operatorname{activation}(WX + b)\). I.e., the identity skip connection.</p></dd>


<dt>skip_conn_masked_enc_dec</dt>
<dd><p>Boolean. If we are to apply concatenating skip
connections between the layers in the masked encoder and decoder. The first layer of the masked encoder will be
linked to the last layer of the decoder. The second layer of the masked encoder will be
linked to the second to last layer of the decoder, and so on.</p></dd>


<dt>batch_normalization</dt>
<dd><p>Boolean. If we are to use batch normalization after the activation function.
Note that if <code>skip_conn_layer</code> is TRUE, then the normalization is
done after the adding from the skip connection. I.e, we batch normalize the whole quantity X + activation(WX + b).</p></dd>


<dt>paired_sampling</dt>
<dd><p>Boolean. If we are doing paired sampling. I.e., if we are to include both coalition S
and \(\bar{S}\) when we sample coalitions during training for each batch.</p></dd>


<dt>mask_generator_name</dt>
<dd><p>String specifying the type of mask generator to use. Need to be one of
'mcar_mask_generator', 'specified_prob_mask_generator', and 'specified_masks_mask_generator'.</p></dd>


<dt>masking_ratio</dt>
<dd><p>Scalar. The probability for an entry in the generated mask to be 1 (masked).
Not used if <code>mask_gen_coalitions</code> is given.</p></dd>


<dt>mask_gen_coalitions</dt>
<dd><p>Matrix containing the different coalitions to learn.
Must be given if <code>mask_generator_name = 'specified_masks_mask_generator'</code>.</p></dd>


<dt>mask_gen_coalitions_prob</dt>
<dd><p>Numerics containing the probabilities
for sampling each mask in <code>mask_gen_coalitions</code>.
Array containing the probabilities for sampling the coalitions in <code>mask_gen_coalitions</code>.</p></dd>


<dt>sigma_mu</dt>
<dd><p>Numeric representing a hyperparameter in the normal-gamma prior used on the masked encoder,
see Section 3.3.1 in <a href="https://www.jmlr.org/papers/volume23/21-1413/21-1413.pdf" class="external-link">Olsen et al. (2022)</a>.</p></dd>


<dt>sigma_sigma</dt>
<dd><p>Numeric representing a hyperparameter in the normal-gamma prior used on the masked encoder,
see Section 3.3.1 in <a href="https://www.jmlr.org/papers/volume23/21-1413/21-1413.pdf" class="external-link">Olsen et al. (2022)</a>.</p></dd>

</dl></div>
    <div id="value">
    <h2>Value</h2>
    

<p>Returns a list with the neural networks of the masked encoder, full encoder, and decoder together
with reconstruction log probability function, optimizer constructor, sampler from the decoder output,
mask generator, batch size, and scale factor for the stability of the variational lower bound optimization.</p>
    </div>
    <div id="details">
    <h2>Details</h2>
    <p>This function builds neural networks (masked encoder, full encoder, decoder) given
the list of one-hot max sizes of the features in the dataset we use to train the vaeac model,
and the provided parameters for the networks. It also creates, e.g., reconstruction log probability function,
methods for sampling from the decoder output, and then use these to create the vaeac model.</p>
    </div>
    <div id="make-observed">
    <h2>make_observed</h2>
    

<p>Apply Mask to Batch to Create Observed Batch</p>
<p>Compute the parameters for the latent normal distributions inferred by the encoders.
If <code>only_masked_encoder = TRUE</code>, then we only compute the latent normal distributions inferred by the
masked encoder. This is used in the deployment phase when we do not have access to the full observation.</p>
    </div>
    <div id="make-latent-distributions">
    <h2>make_latent_distributions</h2>
    

<p>Compute the Latent Distributions Inferred by the Encoders</p>
<p>Compute the parameters for the latent normal distributions inferred by the encoders.
If <code>only_masked_encoder = TRUE</code>, then we only compute the latent normal distributions inferred by the
masked encoder. This is used in the deployment phase when we do not have access to the full observation.</p>
    </div>
    <div id="masked-encoder-regularization">
    <h2>masked_encoder_regularization</h2>
    

<p>Compute the Regularizes for the Latent Distribution Inferred by the Masked Encoder.</p>
<p>The masked encoder (prior) distribution regularization in the latent space.
This is used to compute the extended variational lower bound used to train vaeac, see
Section 3.3.1 in <a href="https://www.jmlr.org/papers/volume23/21-1413/21-1413.pdf" class="external-link">Olsen et al. (2022)</a>.
Though regularizing prevents the masked encoder distribution parameters from going to infinity,
the model usually doesn't diverge even without this regularization. It almost doesn't affect
learning process near zero with default regularization parameters which are recommended to be used.</p>
    </div>
    <div id="batch-vlb">
    <h2>batch_vlb</h2>
    

<p>Compute the Variational Lower Bound for the Observations in the Batch</p>
<p>Compute differentiable lower bound for the given batch of objects and mask.
Used as the (negative) loss function for training the vaeac model.</p>
    </div>
    <div id="batch-iwae">
    <h2>batch_iwae</h2>
    

<p>Compute IWAE log likelihood estimate with K samples per object.</p>
<p>Technically, it is differentiable, but it is recommended to use it for
evaluation purposes inside torch.no_grad in order to save memory. With <code><a href="https://rdrr.io/pkg/torch/man/with_no_grad.html" class="external-link">torch::with_no_grad()</a></code>
the method almost doesn't require extra memory for very large K. The method makes K independent
passes through decoder network, so the batch size is the same as for training with batch_vlb.
IWAE is an abbreviation for Importance Sampling Estimator:
$$
\log p_{\theta, \psi}(x|y) \approx
\log {\frac{1}{K} \sum_{i=1}^K [p_\theta(x|z_i, y) * p_\psi(z_i|y) / q_\phi(z_i|x,y)]} \newline
=
\log {\sum_{i=1}^K \exp(\log[p_\theta(x|z_i, y) * p_\psi(z_i|y) / q_\phi(z_i|x,y)])} - \log(K) \newline
=
\log {\sum_{i=1}^K \exp(\log[p_\theta(x|z_i, y)] + \log[p_\psi(z_i|y)] - \log[q_\phi(z_i|x,y)])} - \log(K) \newline
=
\operatorname{logsumexp}(\log[p_\theta(x|z_i, y)] + \log[p_\psi(z_i|y)] - \log[q_\phi(z_i|x,y)]) - \log(K) \newline
=
\operatorname{logsumexp}(\text{rec}\_\text{loss} + \text{prior}\_\text{log}\_\text{prob} -
 \text{proposal}\_\text{log}\_\text{prob}) - \log(K),$$
where \(z_i \sim q_\phi(z|x,y)\).</p>
    </div>
    <div id="generate-samples-params">
    <h2>generate_samples_params</h2>
    

<p>Generate the parameters of the generative distributions for samples from the batch.</p>
<p>The function makes K latent representation for each object from the batch, send these
latent representations through the decoder to obtain the parameters for the generative distributions.
I.e., means and variances for the normal distributions (continuous features) and probabilities
for the categorical distribution (categorical features).
The second axis is used to index samples for an object, i.e. if the batch shape is [n x D1 x D2], then
the result shape is [n x K x D1 x D2]. It is better to use it inside <code><a href="https://rdrr.io/pkg/torch/man/with_no_grad.html" class="external-link">torch::with_no_grad()</a></code> in order to save
memory. With <code><a href="https://rdrr.io/pkg/torch/man/with_no_grad.html" class="external-link">torch::with_no_grad()</a></code> the method doesn't require extra memory except the memory for the result.</p>
    </div>
    <div id="author">
    <h2>Author</h2>
    <p>Lars Henry Berge Olsen</p>
    </div>

  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Nikolai Sellereite, Martin Jullum, Lars Henry Berge Olsen, Annabelle Redelmeier, Jon Lachmann, Norsk Regnesentral.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer></div>

  


  

  </body></html>

