<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Asymmetric and causal Shapley value explanations • shapr</title>
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Asymmetric and causal Shapley value explanations">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">shapr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.2.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-vignettes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Vignettes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-vignettes">
<li><a class="dropdown-item" href="../articles/general_usage.html">General usage of shapr</a></li>
    <li><a class="dropdown-item" href="../articles/vaeac.html">Advanced usage of the `vaeac` approach</a></li>
    <li><a class="dropdown-item" href="../articles/regression.html">The separate and surrogate regression approches</a></li>
    <li><a class="dropdown-item" href="../articles/asymmetric_causal.html">Asymmetric and Causal Shapley values</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Manual</a></li>
<li class="nav-item"><a class="nav-link" href="../shaprpy.html">Python</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/NorskRegnesentral/shapr/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Asymmetric and causal Shapley value explanations</h1>
                        <h4 data-toc-skip class="author">Lars Henry
Berge Olsen</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/NorskRegnesentral/shapr/blob/master/vignettes/asymmetric_causal.Rmd" class="external-link"><code>vignettes/asymmetric_causal.Rmd</code></a></small>
      <div class="d-none name"><code>asymmetric_causal.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="Vignette">Overview<a class="anchor" aria-label="anchor" href="#Vignette"></a>
</h2>
<p>This vignette elaborates and demonstrates the asymmetric and causal
Shapley value frameworks introduced by <span class="citation">Frye,
Rowat, and Feige (2020)</span> and <span class="citation">Heskes et al.
(2020)</span>, respectively. We also consider the marginal and
conditional Shapley value frameworks, see <span class="citation">Lundberg and Lee (2017)</span> and <span class="citation">Aas, Jullum, and Løland (2021)</span>, respectively. We
demonstrate the frameworks on the <a href="https://archive.ics.uci.edu/dataset/275/" class="external-link">bike sharing</a> dataset
from the UCI Machine Learning Repository. The setup is based on the
<code>CauSHAPley</code> package, which is the <a href="https://proceedings.neurips.cc/paper/2020/hash/32e54441e6382a7fbacbbbaf3c450059-Abstract.html" class="external-link">code
supplement</a> to the <span class="citation">Heskes et al. (2020)</span>
paper. The <code>CauSHAPley</code> package was based on an old version
of <code>shapr</code> and was restricted to the <code>gaussian</code>
approach (see section 6 in <span class="citation">Heskes et al.
(2020)</span> for more details).</p>
<p>We have extended the causal Shapley value framework to work for all
Monte Carlo-based approaches (<code>independence</code> (not
recommended), <code>empirical</code>, <code>gaussian</code>,
<code>copula</code>, <code>ctree</code>, <code>vaeac</code> and
<code>categorical</code>), while the extension of the asymmetric Shapley
value framework works for all the Monte Carlo and regression-based
approaches. Our generalization is of uttermost importance, as many
real-world data sets are far from the Gaussian distribution, and,
compared to <code>CauSHAPley</code>, our implementation can utilize all
of <code>shapr</code>’s new features, such as batch computation,
parallelization and iterative computation for both feature-wise and
group-wise Shapley values.</p>
<p>The main differences between the marginal, conditional, and casual
Shapley value frameworks is that they sample/generate the Monte Carlo
samples from the marginal distribution, (conventional) observational
conditional distribution, and interventional conditional distribution,
respectively. Asymmetric means that we do not consider all possible
coalitions, but rather only the coalitions that respects a causal
ordering.</p>
</div>
<div class="section level2">
<h2 id="AsymSV">Asymmetric conditional Shapley values<a class="anchor" aria-label="anchor" href="#AsymSV"></a>
</h2>
<p>Asymmetric (conditional) Shapley values were proposed by <span class="citation">Frye, Rowat, and Feige (2020)</span> as a way to
incorporate causal knowledge in the real world by computing the Shapley
value explanations using only the feature combinations/coalitions
consistent with a (partial) causal ordering. See the figure below for a
schematic overview of the causal ordering we are going to use in the
examples in this vignette. In the figure, we see that our causal
ordering consists of three components:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>τ</mi><mn>1</mn></msub><mo>=</mo><mo stretchy="false" form="prefix">{</mo><msub><mi>X</mi><mn>1</mn></msub><mo stretchy="false" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">\tau_1 = \{X_1\}</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>τ</mi><mn>2</mn></msub><mo>=</mo><mo stretchy="false" form="prefix">{</mo><msub><mi>X</mi><mn>2</mn></msub><mo>,</mo><msub><mi>X</mi><mn>3</mn></msub><mo stretchy="false" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">\tau_2 = \{X_2, X_3\}</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>τ</mi><mn>3</mn></msub><mo>=</mo><mo stretchy="false" form="prefix">{</mo><msub><mi>X</mi><mn>4</mn></msub><mo>,</mo><msub><mi>X</mi><mn>5</mn></msub><mo>,</mo><msub><mi>X</mi><mn>6</mn></msub><mo>,</mo><msub><mi>X</mi><mn>7</mn></msub><mo stretchy="false" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">\tau_3 = \{X_4, X_5, X_6, X_7\}</annotation></semantics></math>.
See the <a href="#Code">code section</a> for what the features
represent.</p>
<p>To elaborate, instead of considering the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mn>2</mn><mi>M</mi></msup><annotation encoding="application/x-tex">2^M</annotation></semantics></math>
possible coalitions, where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>M</mi><annotation encoding="application/x-tex">M</annotation></semantics></math>
is the number of features, asymmetric Shapley values only consider the
subset of coalitions which respects the causal ordering. For our causal
ordering, this means that the asymmetric Shapley value explanation
framework skips the coalitions where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>X</mi><mn>2</mn></msub><annotation encoding="application/x-tex">X_2</annotation></semantics></math>
is included but
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>X</mi><mn>1</mn></msub><annotation encoding="application/x-tex">X_1</annotation></semantics></math>,
as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>X</mi><mn>1</mn></msub><annotation encoding="application/x-tex">X_1</annotation></semantics></math>
is the ancestor of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>X</mi><mn>2</mn></msub><annotation encoding="application/x-tex">X_2</annotation></semantics></math>.
This will skew the explanations towards distal/root causes, see Section
3.2 in <span class="citation">Frye, Rowat, and Feige (2020)</span>.</p>
<p>We can use all approaches in <code>shapr</code>, both Monte
Carlo-based and regression based methods, to compute the asymmetric
Shapley values. This is because the asymmetric Shapley value explanation
framework does not change how we compute the contribution functions
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>S</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">v(S)</annotation></semantics></math>,
but rather which of the coalitions
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>S</mi><annotation encoding="application/x-tex">S</annotation></semantics></math>
that are used to compute the Shapley value explanations. This means that
the number of coalitions are no longer
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mrow><mo stretchy="true" form="prefix">(</mo><msup><mn>2</mn><mi>M</mi></msup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">O(2^M)</annotation></semantics></math>,
but rather
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mrow><mo stretchy="true" form="prefix">(</mo><msup><mn>2</mn><msub><mi>τ</mi><mn>0</mn></msub></msup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">O(2^{\tau_0})</annotation></semantics></math>,
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>τ</mi><mn>0</mn></msub><mo>=</mo><msub><mo>max</mo><mi>i</mi></msub><mrow><mo stretchy="true" form="prefix">|</mo><msub><mi>τ</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">|</mo></mrow></mrow><annotation encoding="application/x-tex">\tau_0 = \operatorname{max}_i |\tau_i|</annotation></semantics></math>
is the number of features
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">|</mo><msub><mi>τ</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">|</mo></mrow><annotation encoding="application/x-tex">|\tau_i|</annotation></semantics></math>)
in the largest component of the causal ordering.</p>
<p>Furthermore, asymmetric Shapley values supports groups of features,
but then the causal ordering must be given on the group level instead of
on the feature level. The asymmetric Shapley value framework also
supports sampling of coalitions where the sampling is done from the set
of coalitions that respects the causal ordering.</p>
<p>Finally, we want make a remark that asymmetric conditional Shapley
values are equivalent to asymmetric causal Shapley values (see below)
when we only use the coalitions respecting the causal ordering and
assuming that all dependencies within chain components are induced by
mutual interactions.</p>
<div class="figure" style="text-align: center">
<img src="figure_asymmetric_causal%2FAsymmetric_ordering.png" alt="Schematic overview of the causal ordering used in this vignette." width="50%"><p class="caption">
Schematic overview of the causal ordering used in this vignette.
</p>
</div>
</div>
<div class="section level2">
<h2 id="CausSV">Causal Shapley values<a class="anchor" aria-label="anchor" href="#CausSV"></a>
</h2>
<p>Causal Shapley values were proposed by <span class="citation">Heskes
et al. (2020)</span> as a way to explain the total effect of features on
the prediction by taking into account their causal relationships and
adapting the sampling procedure in <code>shapr</code>. More precisely,
they propose to employ Pearl’s do-calculus to circumvent the
independence assumption, made by <span class="citation">Lundberg and Lee
(2017)</span>, without sacrificing any of the desirable properties of
the Shapley value framework. The causal Shapley value explanation
framework can also separate the contribution of direct and indirect
effects, which makes them principally different from marginal and
conditional Shapley values. The framework also provides a more direct
and robust way to incorporate causal knowledge, compared to the
asymmetric Shapley value explanation framework.</p>
<p>To compute causal Shapley values, we have to specify a (partial)
causal ordering and make an assumption about the confounding in each
component. Together, they form a causal chain graph which contains
directed and undirected edges. All features that are treated on an equal
footing are linked together with undirected edges and become part of the
same chain component. Edges between chain components are directed and
represent causal relationships. In the figure below, we have the same
causal ordering as above, but we have in addition made the assumption
that we have confounding in the second component, but no confounding in
the first and third components. This allows us to correctly
distinguishes between dependencies that are due to confounding and
mutual interactions. That is, in the figure, the dependencies in chain
component
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>τ</mi><mn>2</mn></msub><annotation encoding="application/x-tex">\tau_2</annotation></semantics></math>
are assumed to be the result of a common confounder, and those in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>τ</mi><mn>3</mn></msub><annotation encoding="application/x-tex">\tau_3</annotation></semantics></math>
of mutual interactions, while we have no mutual interactions in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>τ</mi><mn>1</mn></msub><annotation encoding="application/x-tex">\tau_1</annotation></semantics></math>
as it is a singleton.</p>
<p>Computing the effect of an intervention depends on how we interpret
the generative process that lead to the feature dependencies within each
component. If they are the result of marginalizing out a common
confounder, then intervention on a particular feature will break the
dependency with the other features, and we denote the set of these chain
components by
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝒯</mi><mtext mathvariant="normal">confounding</mtext></msub><annotation encoding="application/x-tex">\mathcal{T}_{\text{confounding}}</annotation></semantics></math>.
For the components with mutual feature interactions, setting the value
of a feature effects the distribution of the variables within the same
component. We denote the set of these components by
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝒯</mi><mrow><mspace width="0.167em"></mspace><mover><mtext mathvariant="normal">confounding</mtext><mo accent="true">¯</mo></mover></mrow></msub><annotation encoding="application/x-tex">\mathcal{T}_{\,\overline{\text{confounding}}}</annotation></semantics></math>.</p>
<p><span class="citation">Heskes et al. (2020)</span> described how any
expectation by intervention needed to compute the causal Shapley values
can be translated to an expectation by observation, by using the
interventional formula for causal chain graphs:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mover><mi>𝒮</mi><mo accent="true">‾</mo></mover></msub><mo>∣</mo><mi>d</mi><mi>o</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mi>𝒮</mi></msub><mo>=</mo><msub><mi>x</mi><mi>𝒮</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo></mtd><mtd columnalign="left" style="text-align: left"><munder><mo>∏</mo><mrow><mi>τ</mi><mo>∈</mo><msub><mi>𝒯</mi><mrow><mspace width="0.167em"></mspace><mtext mathvariant="normal">confounding</mtext></mrow></msub></mrow></munder><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mrow><mi>τ</mi><mo>∩</mo><mover><mi>𝒮</mi><mo accent="true">‾</mo></mover></mrow></msub><mo>∣</mo><msub><mi>X</mi><mrow><mtext mathvariant="normal">pa</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mi>τ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>∩</mo><mover><mi>𝒮</mi><mo accent="true">‾</mo></mover></mrow></msub><mo>,</mo><msub><mi>x</mi><mrow><mtext mathvariant="normal">pa</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mi>τ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>∩</mo><mi>𝒮</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>×</mo></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mspace width="1.0em"></mspace><munder><mo>∏</mo><mrow><mi>τ</mi><mo>∈</mo><msub><mi>𝒯</mi><mrow><mspace width="0.167em"></mspace><mover><mtext mathvariant="normal">confounding</mtext><mo accent="true">¯</mo></mover></mrow></msub></mrow></munder><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mrow><mi>τ</mi><mo>∩</mo><mover><mi>𝒮</mi><mo accent="true">‾</mo></mover></mrow></msub><mo>∣</mo><msub><mi>X</mi><mrow><mtext mathvariant="normal">pa</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mi>τ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>∩</mo><mover><mi>𝒮</mi><mo accent="true">‾</mo></mover></mrow></msub><mo>,</mo><msub><mi>x</mi><mrow><mtext mathvariant="normal">pa</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mi>τ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>∩</mo><mi>𝒮</mi></mrow></msub><mo>,</mo><msub><mi>x</mi><mrow><mi>τ</mi><mo>∩</mo><mi>𝒮</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>.</mi></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\label{eq:do}
P(X_{\bar{\mathcal{S}}} \mid do(X_\mathcal{S} = x_\mathcal{S}))
= &amp;
\prod_{\tau \in \mathcal{T}_{\,\text{confounding}}}
P(X_{\tau \cap \bar{\mathcal{S}}} \mid X_{\text{pa}(\tau) \cap \bar{\mathcal{S}}}, x_{\text{pa}(\tau) \cap \mathcal{S}}) \times \tag{1} \\
&amp; \quad
\prod_{\tau \in \mathcal{T}_{\,\overline{\text{confounding}}}}
P(X_{\tau \cap \bar{\mathcal{S}}} \mid X_{\text{pa}(\tau) \cap \bar{\mathcal{S}}}, x_{\text{pa}(\tau) \cap \mathcal{S}}, x_{\tau \cap \mathcal{S}}).
\end{align}</annotation></semantics></math> Here, any of the Monte
Carlo-based approaches in <code>shapr</code> can be used to compute the
conditional distributions/observational expectations. The marginals are
estimated from the training data for all approaches except
<code>gaussian</code>, for which we use the marginals of the Gaussian
distribution instead.</p>
<p>For specific causal chain graphs, the causal Shapley value framework
simplifies to symmetric conditional, asymmetric conditional, and
marginal Shapley values, see Corollary 1 to 3 in the supplement of <span class="citation">Heskes et al. (2020)</span>.</p>
<div class="figure">
<img src="figure_asymmetric_causal%2FCausal_ordering.png" alt="Schematic overview of the causal chain graph used in this vignette." width="50%"><p class="caption">
Schematic overview of the causal chain graph used in this vignette.
</p>
</div>
</div>
<div class="section level2">
<h2 id="MarginaSV">Marginal Shapley values<a class="anchor" aria-label="anchor" href="#MarginaSV"></a>
</h2>
<p>Causal Shapley values are equivalent to marginal Shapley values when
all
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>M</mi><annotation encoding="application/x-tex">M</annotation></semantics></math>
features are combined into a single component
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>τ</mi><mo>=</mo><mi>ℳ</mi><mo>=</mo><mo stretchy="false" form="prefix">{</mo><mn>1</mn><mo>,</mo><mn>2</mn><mo>,</mo><mi>.</mi><mi>.</mi><mi>.</mi><mo>,</mo><mi>M</mi><mo stretchy="false" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">\tau = \mathcal{M} = \{1,2,...,M\}</annotation></semantics></math>
and all dependencies are induced by confounding. Then
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">pa</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mi>τ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>∅</mi></mrow><annotation encoding="application/x-tex">\text{pa}(\tau) = \emptyset</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mover><mi>𝒮</mi><mo accent="true">‾</mo></mover></msub><mo>∣</mo><mi>d</mi><mi>o</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mi>𝒮</mi></msub><mo>=</mo><msub><mi>x</mi><mi>𝒮</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">P(X_{\bar{\mathcal{S}}} \mid do(X_\mathcal{S} = x_\mathcal{S}))</annotation></semantics></math>
in Equation () simplifies to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mover><mi>𝒮</mi><mo accent="true">‾</mo></mover></msub><mo>∣</mo><mi>d</mi><mi>o</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mi>𝒮</mi></msub><mo>=</mo><msub><mi>x</mi><mi>𝒮</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mover><mi>𝒮</mi><mo accent="true">‾</mo></mover></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">P(X_{\bar{\mathcal{S}}} \mid do(X_\mathcal{S} = x_\mathcal{S})) = P(X_{\bar{\mathcal{S}}})</annotation></semantics></math>,
as specified in <span class="citation">Lundberg and Lee
(2017)</span>.</p>
<p>The Monte Carlo samples for the marginals are generated by sampling
from the training data, except for the <code>gaussian</code> approach
where we use the marginals of the estimated multivariate Gaussian
distribution. This means that for all other approaches, this is the same
as using the <code>independence</code> approach in the conditional
Shapley value explanation framework.</p>
</div>
<div class="section level2">
<h2 id="ConditionalSV">Symmetric conditional Shapley values<a class="anchor" aria-label="anchor" href="#ConditionalSV"></a>
</h2>
<p>Causal Shapley values are equivalent to symmetric conditional Shapley
values when all
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>M</mi><annotation encoding="application/x-tex">M</annotation></semantics></math>
features are combined in a single component
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>τ</mi><mo>=</mo><mi>ℳ</mi><mo>=</mo><mo stretchy="false" form="prefix">{</mo><mn>1</mn><mo>,</mo><mn>2</mn><mo>,</mo><mi>.</mi><mi>.</mi><mi>.</mi><mo>,</mo><mi>M</mi><mo stretchy="false" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">\tau = \mathcal{M} = \{1,2,...,M\}</annotation></semantics></math>
and all dependencies are induced by mutual interaction. Then
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">pa</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mi>τ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>∅</mi></mrow><annotation encoding="application/x-tex">\text{pa}(\tau) = \emptyset</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mover><mi>𝒮</mi><mo accent="true">‾</mo></mover></msub><mo>∣</mo><mi>d</mi><mi>o</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mi>𝒮</mi></msub><mo>=</mo><msub><mi>x</mi><mi>𝒮</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">P(X_{\bar{\mathcal{S}}} \mid do(X_\mathcal{S} = x_\mathcal{S}))</annotation></semantics></math>
in Equation () simplifies to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mover><mi>𝒮</mi><mo accent="true">‾</mo></mover></msub><mo>∣</mo><mi>d</mi><mi>o</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mi>𝒮</mi></msub><mo>=</mo><msub><mi>x</mi><mi>𝒮</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mover><mi>𝒮</mi><mo accent="true">‾</mo></mover></msub><mo>∣</mo><msub><mi>X</mi><mi>𝒮</mi></msub><mo>=</mo><msub><mi>x</mi><mi>𝒮</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">P(X_{\bar{\mathcal{S}}} \mid do(X_\mathcal{S} = x_\mathcal{S})) = P(X_{\bar{\mathcal{S}}} \mid X_\mathcal{S} = x_\mathcal{S})</annotation></semantics></math>,
as specified in <span class="citation">Aas, Jullum, and Løland
(2021)</span>. Symmetric means that we consider all coalitions.</p>
</div>
<div class="section level2">
<h2 id="Code">Code example<a class="anchor" aria-label="anchor" href="#Code"></a>
</h2>
<div class="section level3">
<h3 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h3>
<p>We demonstrate the frameworks on the <a href="https://archive.ics.uci.edu/dataset/275/" class="external-link">bike sharing</a> dataset
from the UCI Machine Learning Repository. We let the features be the
number of days since January 2011 (<code>trend</code>), two cyclical
variables representing the season (<code>cosyear</code>,
<code>sinyear</code>), temperature (<code>temp</code>), feeling
temperature (<code>atemp</code>), wind speed (<code>windspeed</code>),
and humidity (<code>hum</code>). The first three features are considered
to be a potential cause of the four weather-related features. The bike
rental is strongly seasonal and shows an upward trend, as illustrated in
the figure below. The bike data is split randomly into a training (80%)
and test/explicand (20%) set. We train an <code>XGBoost</code> model for
100 rounds with default variables to act as the model we want to
explain.</p>
<p>In the table below, we highlight the Shapley value explanation
frameworks introduced above and how to access them by changing the
arguments <code>asymmetric</code>, <code>ordering</code>, and
<code>confounding</code> in <code><a href="../reference/explain.html">shapr::explain()</a></code>. Note that
symmetric conditional Shapley values are the default version, i.e., by
default <code>asymmetric = FALSE</code>, <code>ordering = NULL</code>,
<code>confounding = NULL</code>.</p>
<table class="table">
<colgroup>
<col width="18%">
<col width="22%">
<col width="20%">
<col width="12%">
<col width="12%">
<col width="13%">
</colgroup>
<thead><tr class="header">
<th align="left">Framework</th>
<th align="left">Sampling</th>
<th align="left">Approaches</th>
<th align="left"><code>asymmetric</code></th>
<th align="left"><code>ordering</code></th>
<th align="left"><code>confounding</code></th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Sym. Conditional</td>
<td align="left"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false" form="prefix">(</mo><msub><mi>X</mi><mover><mi>𝒮</mi><mo accent="true">‾</mo></mover></msub><mo>∣</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mi>𝒮</mi></msub><mo>=</mo><msub><mi>x</mi><mi>𝒮</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">P(X_{\bar{\mathcal{S}}} \mid (X_\mathcal{S} = x_\mathcal{S})</annotation></semantics></math></td>
<td align="left">All</td>
<td align="left"><code>FALSE</code></td>
<td align="left"><code>NULL</code></td>
<td align="left"><code>NULL</code></td>
</tr>
<tr class="even">
<td align="left">Asym. Conditional</td>
<td align="left"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false" form="prefix">(</mo><msub><mi>X</mi><mover><mi>𝒮</mi><mo accent="true">‾</mo></mover></msub><mo>∣</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mi>𝒮</mi></msub><mo>=</mo><msub><mi>x</mi><mi>𝒮</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">P(X_{\bar{\mathcal{S}}} \mid (X_\mathcal{S} = x_\mathcal{S})</annotation></semantics></math></td>
<td align="left">All</td>
<td align="left"><code>TRUE</code></td>
<td align="left"><code>list(...)</code></td>
<td align="left"><code>NULL</code></td>
</tr>
<tr class="odd">
<td align="left">Sym. Causal</td>
<td align="left"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mover><mi>𝒮</mi><mo accent="true">‾</mo></mover></msub><mo>∣</mo><mi>d</mi><mi>o</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mi>𝒮</mi></msub><mo>=</mo><msub><mi>x</mi><mi>𝒮</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">P(X_{\bar{\mathcal{S}}} \mid do(X_\mathcal{S} = x_\mathcal{S}))</annotation></semantics></math></td>
<td align="left">All MC-based</td>
<td align="left"><code>FALSE</code></td>
<td align="left"><code>list(...)</code></td>
<td align="left"><code>c(...)</code></td>
</tr>
<tr class="even">
<td align="left">Asym. Causal</td>
<td align="left"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mover><mi>𝒮</mi><mo accent="true">‾</mo></mover></msub><mo>∣</mo><mi>d</mi><mi>o</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mi>𝒮</mi></msub><mo>=</mo><msub><mi>x</mi><mi>𝒮</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">P(X_{\bar{\mathcal{S}}} \mid do(X_\mathcal{S} = x_\mathcal{S}))</annotation></semantics></math></td>
<td align="left">All MC-based</td>
<td align="left"><code>TRUE</code></td>
<td align="left"><code>list(...)</code></td>
<td align="left"><code>c(...)</code></td>
</tr>
<tr class="odd">
<td align="left">Sym. Marginal</td>
<td align="left"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mover><mi>𝒮</mi><mo accent="true">‾</mo></mover></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">P(X_{\bar{\mathcal{S}}})</annotation></semantics></math></td>
<td align="left">
<code>indep.</code>, <code>gaussian</code>
</td>
<td align="left"><code>FALSE</code></td>
<td align="left"><code>NULL</code></td>
<td align="left"><code>TRUE</code></td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="code-setup">Code setup<a class="anchor" aria-label="anchor" href="#code-setup"></a>
</h3>
<p>First, we load the needed libraries, set up the training/explicand
data, plot the data, and train an <code>xgboost</code> model.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/dmlc/xgboost" class="external-link">xgboost</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://norskregnesentral.github.io/shapr/">shapr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Additional packages which are only used for plotting in this vignette.</span></span>
<span><span class="co"># There are not listed as dependencies is shapr</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggobi.github.io/ggally/" class="external-link">GGally</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rpkgs.datanovia.com/ggpubr/" class="external-link">ggpubr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">gridExtra</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co"># Ensure that shapr's functions are prioritzed, otherwise we need to use the `shapr::`</span></span>
<span><span class="co"># prefix when calling explain(). The `conflicted` package is imported by `tidymodels`.</span></span>
<span><span class="fu">conflicted</span><span class="fu">::</span><span class="fu">conflicts_prefer</span><span class="op">(</span><span class="fu">shapr</span><span class="fu">::</span><span class="va"><a href="../reference/explain.html">explain</a></span>, <span class="fu">shapr</span><span class="fu">::</span><span class="va"><a href="../reference/prepare_data.html">prepare_data</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set up the data</span></span>
<span><span class="co"># Can also download the data set from the source https://archive.ics.uci.edu/dataset/275/bike+sharing+dataset</span></span>
<span><span class="co"># temp &lt;- tempfile()</span></span>
<span><span class="co"># download.file("https://archive.ics.uci.edu/static/public/275/bike+sharing+dataset.zip", temp)</span></span>
<span><span class="co"># bike &lt;- read.csv(unz(temp, "day.csv"))</span></span>
<span><span class="co"># unlink(temp)</span></span>
<span><span class="va">bike</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"../inst/extdata/day.csv"</span><span class="op">)</span></span>
<span><span class="co"># Difference in days, which takes DST into account</span></span>
<span><span class="va">bike</span><span class="op">$</span><span class="va">trend</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span><span class="va">bike</span><span class="op">$</span><span class="va">dteday</span>, <span class="va">bike</span><span class="op">$</span><span class="va">dteday</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, units <span class="op">=</span> <span class="st">"days"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">bike</span><span class="op">$</span><span class="va">cosyear</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">cospi</a></span><span class="op">(</span><span class="va">bike</span><span class="op">$</span><span class="va">trend</span> <span class="op">/</span> <span class="fl">365</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">bike</span><span class="op">$</span><span class="va">sinyear</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">sinpi</a></span><span class="op">(</span><span class="va">bike</span><span class="op">$</span><span class="va">trend</span> <span class="op">/</span> <span class="fl">365</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co"># Unnormalize variables (see data set information in link above)</span></span>
<span><span class="va">bike</span><span class="op">$</span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">bike</span><span class="op">$</span><span class="va">temp</span> <span class="op">*</span> <span class="op">(</span><span class="fl">39</span> <span class="op">-</span> <span class="op">(</span><span class="op">-</span><span class="fl">8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="op">-</span><span class="fl">8</span><span class="op">)</span></span>
<span><span class="va">bike</span><span class="op">$</span><span class="va">atemp</span> <span class="op">&lt;-</span> <span class="va">bike</span><span class="op">$</span><span class="va">atemp</span> <span class="op">*</span> <span class="op">(</span><span class="fl">50</span> <span class="op">-</span> <span class="op">(</span><span class="op">-</span><span class="fl">16</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="op">-</span><span class="fl">16</span><span class="op">)</span></span>
<span><span class="va">bike</span><span class="op">$</span><span class="va">windspeed</span> <span class="op">&lt;-</span> <span class="fl">67</span> <span class="op">*</span> <span class="va">bike</span><span class="op">$</span><span class="va">windspeed</span></span>
<span><span class="va">bike</span><span class="op">$</span><span class="va">hum</span> <span class="op">&lt;-</span> <span class="fl">100</span> <span class="op">*</span> <span class="va">bike</span><span class="op">$</span><span class="va">hum</span></span>
<span></span>
<span><span class="co"># Plot the data</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">bike</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">trend</span>, y <span class="op">=</span> <span class="va">cnt</span>, color <span class="op">=</span> <span class="va">temp</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_color_gradient</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">"blue"</span>, high <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"temp"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Days since 1 January 2011"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Number of bikes rented"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"right"</span>, legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_asymmetric_causal%2Fsetup_1-1.png"></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define the features and the response variable</span></span>
<span><span class="va">x_var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"trend"</span>, <span class="st">"cosyear"</span>, <span class="st">"sinyear"</span>, <span class="st">"temp"</span>, <span class="st">"atemp"</span>, <span class="st">"windspeed"</span>, <span class="st">"hum"</span><span class="op">)</span></span>
<span><span class="va">y_var</span> <span class="op">&lt;-</span> <span class="st">"cnt"</span></span>
<span></span>
<span><span class="co"># NOTE: To avoid RNG reproducibility issues across different systems, we</span></span>
<span><span class="co"># load the training-test split from a file. 80% training and 20% test</span></span>
<span><span class="va">train_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"../inst/extdata/train_index.rds"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Training data</span></span>
<span><span class="va">x_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">bike</span><span class="op">[</span><span class="va">train_index</span>, <span class="va">x_var</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y_train_nc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">bike</span><span class="op">[</span><span class="va">train_index</span>, <span class="va">y_var</span><span class="op">]</span><span class="op">)</span> <span class="co"># not centered</span></span>
<span><span class="va">y_train</span> <span class="op">&lt;-</span> <span class="va">y_train_nc</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">y_train_nc</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot pairs plot</span></span>
<span><span class="fu">GGally</span><span class="fu">::</span><span class="fu"><a href="https://ggobi.github.io/ggally/reference/ggpairs.html" class="external-link">ggpairs</a></span><span class="op">(</span><span class="va">x_train</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_asymmetric_causal%2Fsetup_2-1.png"></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Test/explicand data</span></span>
<span><span class="va">x_explain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">bike</span><span class="op">[</span><span class="op">-</span><span class="va">train_index</span>, <span class="va">x_var</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y_explain_nc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">bike</span><span class="op">[</span><span class="op">-</span><span class="va">train_index</span>, <span class="va">y_var</span><span class="op">]</span><span class="op">)</span> <span class="co"># not centered</span></span>
<span><span class="va">y_explain</span> <span class="op">&lt;-</span> <span class="va">y_explain_nc</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">y_train_nc</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get 6 explicands to plot the Shapley values of with a wide spread in their predicted outcome</span></span>
<span><span class="va">n_index_x_explain</span> <span class="op">&lt;-</span> <span class="fl">6</span></span>
<span><span class="va">index_x_explain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">y_explain</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">y_explain</span><span class="op">)</span>, length.out <span class="op">=</span> <span class="va">n_index_x_explain</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">y_explain</span><span class="op">[</span><span class="va">index_x_explain</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] -3900.03 -1872.03  -377.03   411.97  1690.97  3889.97</span></span>
<span></span>
<span><span class="co"># Fit an XGBoost model to the training data</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">xgboost</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.train.html" class="external-link">xgboost</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  label <span class="op">=</span> <span class="va">y_train</span>,</span>
<span>  nround <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Save the phi0</span></span>
<span><span class="va">phi0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">y_train</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Look at the root mean squared error</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">x_explain</span><span class="op">)</span> <span class="op">-</span> <span class="va">y_explain</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 798.71</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/data.table.html" class="external-link">data.table</a></span><span class="op">(</span><span class="st">"response"</span> <span class="op">=</span> <span class="va">y_explain</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, <span class="st">"predicted_response"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">x_explain</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">response</span>, <span class="va">predicted_response</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_asymmetric_causal%2Fsetup_3-1.png"></p>
<p>We are going to use the <code>causal_ordering</code> and
<code>confounding</code> illustrated in the figures above. For
<code>causal_ordering</code>, we can either provide the index of feature
or the feature names. Thus, the following two versions of
<code>causal_ordering</code> will produce equivalent results.
Furthermore, we assume that we have confounding for the second component
(i.e., the season has an effect on the weather) and no confounding for
the third component (i.e., we do not how to model the intricate
relations between the weather features).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">causal_ordering</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span><span class="op">:</span><span class="fl">7</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">causal_ordering</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"trend"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cosyear"</span>, <span class="st">"sinyear"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"temp"</span>, <span class="st">"atemp"</span>, <span class="st">"windspeed"</span>, <span class="st">"hum"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">confounding</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">FALSE</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>To make the rest of the vignette easier to follow, we create some
helper functions that plot and summarize the results of the explanation
methods. This code block is optional to understand and can be
skipped.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract the MSEv criterion scores and elapsed times</span></span>
<span><span class="va">print_MSEv_scores_and_time</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">explanation_list</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span></span>
<span>    <span class="va">explanation_list</span>,</span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="va">explanation</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>        <span class="va">explanation</span><span class="op">$</span><span class="va">MSEv</span><span class="op">$</span><span class="va">MSEv</span><span class="op">$</span><span class="va">MSEv</span>,</span>
<span>        <span class="va">explanation</span><span class="op">$</span><span class="va">MSEv</span><span class="op">$</span><span class="va">MSEv</span><span class="op">$</span><span class="va">MSEv_sd</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span><span class="va">explanation</span><span class="op">$</span><span class="va">timing</span><span class="op">$</span><span class="va">end_time</span>, <span class="va">explanation</span><span class="op">$</span><span class="va">timing</span><span class="op">$</span><span class="va">init_time</span>, units <span class="op">=</span> <span class="st">"secs"</span><span class="op">)</span></span>
<span>      <span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"MSEv"</span>, <span class="st">"MSEv_sd"</span>, <span class="st">"Time (secs)"</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Print the full time information</span></span>
<span><span class="va">print_time</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">explanation_list</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">explanation_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">explanation</span><span class="op">)</span> <span class="va">explanation</span><span class="op">$</span><span class="va">timing</span><span class="op">$</span><span class="va">total_time_secs</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Make beeswarm plots</span></span>
<span><span class="va">plot_beeswarms</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">explanation_list</span>, <span class="va">title</span> <span class="op">=</span> <span class="st">""</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Make the beeswarm plots</span></span>
<span>  <span class="va">grobs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">explanation_list</span><span class="op">)</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">explanation_idx</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">gg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">explanation_list</span><span class="op">[[</span><span class="va">explanation_idx</span><span class="op">]</span><span class="op">]</span>, plot_type <span class="op">=</span> <span class="st">"beeswarm"</span>, <span class="va">...</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="fu">tools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/tools/toTitleCase.html" class="external-link">toTitleCase</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"_"</span>, <span class="st">" "</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">explanation_list</span><span class="op">)</span><span class="op">[[</span><span class="va">explanation_idx</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Flip the order such that the features comes in the right order</span></span>
<span>    <span class="va">gg</span> <span class="op">&lt;-</span> <span class="va">gg</span> <span class="op">+</span></span>
<span>      <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html" class="external-link">scale_x_discrete</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gg</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">variable</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gg</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">variable</span><span class="op">)</span> <span class="op">!=</span> <span class="st">"none"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Get the limits</span></span>
<span>  <span class="va">ylim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">grobs</span>, <span class="kw">function</span><span class="op">(</span><span class="va">grob</span><span class="op">)</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot_build.html" class="external-link">ggplot_build</a></span><span class="op">(</span><span class="va">grob</span><span class="op">)</span><span class="op">$</span><span class="va">layout</span><span class="op">$</span><span class="va">panel_scales_y</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">range</span><span class="op">$</span><span class="va">range</span><span class="op">)</span></span>
<span>  <span class="va">ylim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">ylim</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">ylim</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Update the limits</span></span>
<span>  <span class="va">grobs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">grobs</span>, <span class="kw">function</span><span class="op">(</span><span class="va">grob</span><span class="op">)</span> <span class="va">grob</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html" class="external-link">coord_flip</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="va">ylim</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Make the combined plot</span></span>
<span>  <span class="fu">gridExtra</span><span class="fu">::</span><span class="fu">grid.arrange</span><span class="op">(</span></span>
<span>    grobs <span class="op">=</span> <span class="va">grobs</span>, ncol <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    top <span class="op">=</span> <span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/grid.text.html" class="external-link">textGrob</a></span><span class="op">(</span><span class="va">title</span>, gp <span class="op">=</span> <span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/gpar.html" class="external-link">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="fl">18</span>, font <span class="op">=</span> <span class="fl">8</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="symmetric-conditional-shapley-values-default">Symmetric conditional Shapley values (default)<a class="anchor" aria-label="anchor" href="#symmetric-conditional-shapley-values-default"></a>
</h3>
<p>We start by demonstrating how to compute symmetric conditional
Shapley values. This is the default version in <code>shapr</code> and
there is no need to specify the arguments below. However, we have
specified them for the sake of clarity. We use the
<code>gaussian</code>, <code>ctree</code>, and
<code>regression_separate</code>(<code>xgboost</code> with default
hyperparameters) approaches, but any other approach can also be
used.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># list to store the results</span></span>
<span><span class="va">explanation_sym_con</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">explanation_sym_con</span><span class="op">[[</span><span class="st">"gaussian"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"gaussian"</span>,</span>
<span>  phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>  n_MC_samples <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  asymmetric <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co"># Default value (TRUE will give the same since `causal_ordering = NULL`)</span></span>
<span>  causal_ordering <span class="op">=</span> <span class="cn">NULL</span>, <span class="co"># Default value</span></span>
<span>  confounding <span class="op">=</span> <span class="cn">NULL</span> <span class="co"># Default value</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Success with message:</span></span>
<span><span class="co">#&gt; max_n_coalitions is NULL or larger than or 2^n_features = 128, </span></span>
<span><span class="co">#&gt; and is therefore set to 2^n_features = 128.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Starting `shapr::explain()` at 2025-01-20 11:55:25 ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • Model class: &lt;xgb.Booster&gt;</span></span>
<span><span class="co">#&gt; • Approach: gaussian</span></span>
<span><span class="co">#&gt; • Iterative estimation: TRUE</span></span>
<span><span class="co">#&gt; • Number of feature-wise Shapley values: 7</span></span>
<span><span class="co">#&gt; • Number of observations to explain: 144</span></span>
<span><span class="co">#&gt; • Computations (temporary) saved at: '/tmp/RtmpwfPA0n/shapr_obj_35d5101940cde3.rds'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── iterative computation started ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 1 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 14 of 128 coalitions, 14 new.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 2 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 26 of 128 coalitions, 12 new.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 3 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 36 of 128 coalitions, 10 new.</span></span>
<span></span>
<span><span class="va">explanation_sym_con</span><span class="op">[[</span><span class="st">"ctree"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"ctree"</span>,</span>
<span>  phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>  n_MC_samples <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  asymmetric <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co"># Default value (TRUE will give the same since `causal_ordering = NULL`)</span></span>
<span>  causal_ordering <span class="op">=</span> <span class="cn">NULL</span>, <span class="co"># Default value</span></span>
<span>  confounding <span class="op">=</span> <span class="cn">NULL</span> <span class="co"># Default value</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Success with message:</span></span>
<span><span class="co">#&gt; max_n_coalitions is NULL or larger than or 2^n_features = 128, </span></span>
<span><span class="co">#&gt; and is therefore set to 2^n_features = 128.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Starting `shapr::explain()` at 2025-01-20 11:55:31 ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • Model class: &lt;xgb.Booster&gt;</span></span>
<span><span class="co">#&gt; • Approach: ctree</span></span>
<span><span class="co">#&gt; • Iterative estimation: TRUE</span></span>
<span><span class="co">#&gt; • Number of feature-wise Shapley values: 7</span></span>
<span><span class="co">#&gt; • Number of observations to explain: 144</span></span>
<span><span class="co">#&gt; • Computations (temporary) saved at: '/tmp/RtmpwfPA0n/shapr_obj_35d5107a05bca3.rds'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── iterative computation started ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 1 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 14 of 128 coalitions, 14 new.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 2 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 26 of 128 coalitions, 12 new.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 3 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 36 of 128 coalitions, 10 new.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 4 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 48 of 128 coalitions, 12 new.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 5 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 54 of 128 coalitions, 6 new.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 6 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 66 of 128 coalitions, 12 new.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 7 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 72 of 128 coalitions, 6 new.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 8 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 82 of 128 coalitions, 10 new.</span></span>
<span></span>
<span><span class="va">explanation_sym_con</span><span class="op">[[</span><span class="st">"xgboost"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"regression_separate"</span>,</span>
<span>  regression.model <span class="op">=</span> <span class="fu">parsnip</span><span class="fu">::</span><span class="fu"><a href="https://parsnip.tidymodels.org/reference/boost_tree.html" class="external-link">boost_tree</a></span><span class="op">(</span>engine <span class="op">=</span> <span class="st">"xgboost"</span>, mode <span class="op">=</span> <span class="st">"regression"</span><span class="op">)</span>,</span>
<span>  asymmetric <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co"># Default value (TRUE will give the same as `causal_ordering = NULL`)</span></span>
<span>  causal_ordering <span class="op">=</span> <span class="cn">NULL</span>, <span class="co"># Default value</span></span>
<span>  confounding <span class="op">=</span> <span class="cn">NULL</span> <span class="co"># Default value</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Success with message:</span></span>
<span><span class="co">#&gt; max_n_coalitions is NULL or larger than or 2^n_features = 128, </span></span>
<span><span class="co">#&gt; and is therefore set to 2^n_features = 128.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Starting `shapr::explain()` at 2025-01-20 11:56:38 ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • Model class: &lt;xgb.Booster&gt;</span></span>
<span><span class="co">#&gt; • Approach: regression_separate</span></span>
<span><span class="co">#&gt; • Iterative estimation: TRUE</span></span>
<span><span class="co">#&gt; • Number of feature-wise Shapley values: 7</span></span>
<span><span class="co">#&gt; • Number of observations to explain: 144</span></span>
<span><span class="co">#&gt; • Computations (temporary) saved at: '/tmp/RtmpwfPA0n/shapr_obj_35d5106910fdb.rds'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── iterative computation started ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 1 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 14 of 128 coalitions, 14 new.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 2 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 26 of 128 coalitions, 12 new.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 3 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 36 of 128 coalitions, 10 new.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 4 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 54 of 128 coalitions, 18 new.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 5 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 70 of 128 coalitions, 16 new.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 6 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 74 of 128 coalitions, 4 new.</span></span></code></pre></div>
<p>We can then look at the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mo>MSE</mo><mi>v</mi></msub><annotation encoding="application/x-tex">\operatorname{MSE}_v</annotation></semantics></math>
evaluation scores to compare the approaches. All approaches are
comparable, but <code>xgboost</code> is clearly the fastest
approach.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">print_MSEv_scores_and_time</span><span class="op">(</span><span class="va">explanation_sym_con</span><span class="op">)</span></span>
<span><span class="co">#&gt;             MSEv MSEv_sd Time (secs)</span></span>
<span><span class="co">#&gt; gaussian 1090309   75827        5.31</span></span>
<span><span class="co">#&gt; ctree    1070563   65940       67.22</span></span>
<span><span class="co">#&gt; xgboost  1120165   62742       11.98</span></span></code></pre></div>
<p>We can then plot the Shapley values for the six explicands chosen
above.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_SV_several_approaches.html">plot_SV_several_approaches</a></span><span class="op">(</span><span class="va">explanation_sym_con</span>, <span class="va">index_x_explain</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_asymmetric_causal%2Fexplanation_sym_con_SV-1.png"></p>
<p>We can also make beeswarm plots of the Shapley values to look at the
structure of the Shapley values for all explicands. The figures are
quite similar, but with minor differences. E.g., the
<code>gaussian</code> approach produces almost no Shapley values around
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>500</mn><annotation encoding="application/x-tex">500</annotation></semantics></math>
for the <code>trend</code> feature.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_beeswarms</span><span class="op">(</span><span class="va">explanation_sym_con</span>, title <span class="op">=</span> <span class="st">"Symmetric conditional Shapley values"</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_asymmetric_causal%2Fexplanation_sym_con_beeswarm-1.png"></p>
</div>
<div class="section level3">
<h3 id="asymmetric-conditional-shapley-values">Asymmetric conditional Shapley values<a class="anchor" aria-label="anchor" href="#asymmetric-conditional-shapley-values"></a>
</h3>
<p>Then we look at the asymmetric conditional Shapley values. To obtain
these types of Shapley values, we have to specify that
<code>asymmetric = TRUE</code> and a <code>causal_ordering</code>. We
use <code>causal_ordering = list(1, c(2, 3), c(4:7))</code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">explanation_asym_con</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">explanation_asym_con</span><span class="op">[[</span><span class="st">"gaussian"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>  n_MC_samples <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"gaussian"</span>,</span>
<span>  asymmetric <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  causal_ordering <span class="op">=</span> <span class="va">causal_ordering</span>,</span>
<span>  confounding <span class="op">=</span> <span class="cn">NULL</span> <span class="co"># Default value</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Success with message:</span></span>
<span><span class="co">#&gt; max_n_coalitions is NULL or larger than or number of coalitions respecting the causal</span></span>
<span><span class="co">#&gt; ordering 20, and is therefore set to 20.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Starting `shapr::explain()` at 2025-01-20 11:56:52 ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • Model class: &lt;xgb.Booster&gt;</span></span>
<span><span class="co">#&gt; • Approach: gaussian</span></span>
<span><span class="co">#&gt; • Iterative estimation: TRUE</span></span>
<span><span class="co">#&gt; • Number of feature-wise Shapley values: 7</span></span>
<span><span class="co">#&gt; • Number of observations to explain: 144</span></span>
<span><span class="co">#&gt; • Number of asymmetric coalitions: 20</span></span>
<span><span class="co">#&gt; • Causal ordering: {trend}, {cosyear, sinyear}, {temp, atemp, windspeed, hum}</span></span>
<span><span class="co">#&gt; • Computations (temporary) saved at: '/tmp/RtmpwfPA0n/shapr_obj_35d51035c6360c.rds'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── iterative computation started ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 1 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 13 of 20 coalitions, 13 new.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 2 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 16 of 20 coalitions, 3 new.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 3 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 17 of 20 coalitions, 1 new.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 4 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 18 of 20 coalitions, 1 new.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 5 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 19 of 20 coalitions, 1 new.</span></span>
<span></span>
<span><span class="va">explanation_asym_con</span><span class="op">[[</span><span class="st">"gaussian_non_iterative"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>  n_MC_samples <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"gaussian"</span>,</span>
<span>  asymmetric <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  causal_ordering <span class="op">=</span> <span class="va">causal_ordering</span>,</span>
<span>  confounding <span class="op">=</span> <span class="cn">NULL</span>, <span class="co"># Default value</span></span>
<span>  iterative <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Success with message:</span></span>
<span><span class="co">#&gt; max_n_coalitions is NULL or larger than or number of coalitions respecting the causal</span></span>
<span><span class="co">#&gt; ordering 20, and is therefore set to 20.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Starting `shapr::explain()` at 2025-01-20 11:56:57 ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • Model class: &lt;xgb.Booster&gt;</span></span>
<span><span class="co">#&gt; • Approach: gaussian</span></span>
<span><span class="co">#&gt; • Iterative estimation: FALSE</span></span>
<span><span class="co">#&gt; • Number of feature-wise Shapley values: 7</span></span>
<span><span class="co">#&gt; • Number of observations to explain: 144</span></span>
<span><span class="co">#&gt; • Number of asymmetric coalitions: 20</span></span>
<span><span class="co">#&gt; • Causal ordering: {trend}, {cosyear, sinyear}, {temp, atemp, windspeed, hum}</span></span>
<span><span class="co">#&gt; • Computations (temporary) saved at: '/tmp/RtmpwfPA0n/shapr_obj_35d51012cbb4e1.rds'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Main computation started ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ℹ Using 20 of 20 coalitions.</span></span>
<span></span>
<span><span class="va">explanation_asym_con</span><span class="op">[[</span><span class="st">"ctree"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>  n_MC_samples <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"ctree"</span>,</span>
<span>  asymmetric <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  causal_ordering <span class="op">=</span> <span class="va">causal_ordering</span>,</span>
<span>  confounding <span class="op">=</span> <span class="cn">NULL</span> <span class="co"># Default value</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Success with message:</span></span>
<span><span class="co">#&gt; max_n_coalitions is NULL or larger than or number of coalitions respecting the causal</span></span>
<span><span class="co">#&gt; ordering 20, and is therefore set to 20.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Starting `shapr::explain()` at 2025-01-20 11:56:59 ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • Model class: &lt;xgb.Booster&gt;</span></span>
<span><span class="co">#&gt; • Approach: ctree</span></span>
<span><span class="co">#&gt; • Iterative estimation: TRUE</span></span>
<span><span class="co">#&gt; • Number of feature-wise Shapley values: 7</span></span>
<span><span class="co">#&gt; • Number of observations to explain: 144</span></span>
<span><span class="co">#&gt; • Number of asymmetric coalitions: 20</span></span>
<span><span class="co">#&gt; • Causal ordering: {trend}, {cosyear, sinyear}, {temp, atemp, windspeed, hum}</span></span>
<span><span class="co">#&gt; • Computations (temporary) saved at: '/tmp/RtmpwfPA0n/shapr_obj_35d51043601531.rds'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── iterative computation started ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 1 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 13 of 20 coalitions, 13 new.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 2 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 17 of 20 coalitions, 4 new.</span></span>
<span></span>
<span><span class="va">explanation_asym_con</span><span class="op">[[</span><span class="st">"xgboost"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"regression_separate"</span>,</span>
<span>  regression.model <span class="op">=</span> <span class="fu">parsnip</span><span class="fu">::</span><span class="fu"><a href="https://parsnip.tidymodels.org/reference/boost_tree.html" class="external-link">boost_tree</a></span><span class="op">(</span>engine <span class="op">=</span> <span class="st">"xgboost"</span>, mode <span class="op">=</span> <span class="st">"regression"</span><span class="op">)</span>,</span>
<span>  asymmetric <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  causal_ordering <span class="op">=</span> <span class="va">causal_ordering</span>,</span>
<span>  confounding <span class="op">=</span> <span class="cn">NULL</span> <span class="co"># Default value</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Success with message:</span></span>
<span><span class="co">#&gt; max_n_coalitions is NULL or larger than or number of coalitions respecting the causal</span></span>
<span><span class="co">#&gt; ordering 20, and is therefore set to 20.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Starting `shapr::explain()` at 2025-01-20 11:57:11 ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • Model class: &lt;xgb.Booster&gt;</span></span>
<span><span class="co">#&gt; • Approach: regression_separate</span></span>
<span><span class="co">#&gt; • Iterative estimation: TRUE</span></span>
<span><span class="co">#&gt; • Number of feature-wise Shapley values: 7</span></span>
<span><span class="co">#&gt; • Number of observations to explain: 144</span></span>
<span><span class="co">#&gt; • Number of asymmetric coalitions: 20</span></span>
<span><span class="co">#&gt; • Causal ordering: {trend}, {cosyear, sinyear}, {temp, atemp, windspeed, hum}</span></span>
<span><span class="co">#&gt; • Computations (temporary) saved at: '/tmp/RtmpwfPA0n/shapr_obj_35d5107780fa4b.rds'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── iterative computation started ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 1 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 13 of 20 coalitions, 13 new.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 2 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 15 of 20 coalitions, 2 new.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 3 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 18 of 20 coalitions, 3 new.</span></span></code></pre></div>
<p>The asymmetric conditional Shapley value framework is faster as we
only consider
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>20</mn><annotation encoding="application/x-tex">20</annotation></semantics></math>
coalitions (including empty and grand coalition) instead of all
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>128</mn><annotation encoding="application/x-tex">128</annotation></semantics></math>
coalitions (see code below).</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">print_MSEv_scores_and_time</span><span class="op">(</span><span class="va">explanation_asym_con</span><span class="op">)</span></span>
<span><span class="co">#&gt;                          MSEv MSEv_sd Time (secs)</span></span>
<span><span class="co">#&gt; gaussian               306948   34888        5.47</span></span>
<span><span class="co">#&gt; gaussian_non_iterative 306458   35412        1.23</span></span>
<span><span class="co">#&gt; ctree                  277729   33049       12.33</span></span>
<span><span class="co">#&gt; xgboost                300690   35411        3.38</span></span>
<span></span>
<span><span class="co"># Look at the number of coalitions considered. Decreased from 128 to 20.</span></span>
<span><span class="va">explanation_sym_con</span><span class="op">$</span><span class="va">gaussian</span><span class="op">$</span><span class="va">internal</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">max_n_coalitions</span></span>
<span><span class="co">#&gt; [1] 128</span></span>
<span><span class="va">explanation_asym_con</span><span class="op">$</span><span class="va">gaussian</span><span class="op">$</span><span class="va">internal</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">max_n_coalitions</span></span>
<span><span class="co">#&gt; [1] 20</span></span>
<span></span>
<span><span class="co"># Here we can see the 20 coalitions that respects the causal ordering</span></span>
<span><span class="va">explanation_asym_con</span><span class="op">$</span><span class="va">gaussian</span><span class="op">$</span><span class="va">internal</span><span class="op">$</span><span class="va">objects</span><span class="op">$</span><span class="va">dt_valid_causal_coalitions</span><span class="op">[[</span><span class="st">"coalitions"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; integer(0)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt; [1] 1 2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[4]]</span></span>
<span><span class="co">#&gt; [1] 1 3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[5]]</span></span>
<span><span class="co">#&gt; [1] 1 2 3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[6]]</span></span>
<span><span class="co">#&gt; [1] 1 2 3 4</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[7]]</span></span>
<span><span class="co">#&gt; [1] 1 2 3 5</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[8]]</span></span>
<span><span class="co">#&gt; [1] 1 2 3 6</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[9]]</span></span>
<span><span class="co">#&gt; [1] 1 2 3 7</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[10]]</span></span>
<span><span class="co">#&gt; [1] 1 2 3 4 5</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[11]]</span></span>
<span><span class="co">#&gt; [1] 1 2 3 4 6</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[12]]</span></span>
<span><span class="co">#&gt; [1] 1 2 3 4 7</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[13]]</span></span>
<span><span class="co">#&gt; [1] 1 2 3 5 6</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[14]]</span></span>
<span><span class="co">#&gt; [1] 1 2 3 5 7</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[15]]</span></span>
<span><span class="co">#&gt; [1] 1 2 3 6 7</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[16]]</span></span>
<span><span class="co">#&gt; [1] 1 2 3 4 5 6</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[17]]</span></span>
<span><span class="co">#&gt; [1] 1 2 3 4 5 7</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[18]]</span></span>
<span><span class="co">#&gt; [1] 1 2 3 4 6 7</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[19]]</span></span>
<span><span class="co">#&gt; [1] 1 2 3 5 6 7</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[20]]</span></span>
<span><span class="co">#&gt; [1] 1 2 3 4 5 6 7</span></span></code></pre></div>
<p>We can then look at the beeswarm plots of the asymmetric conditional
Shapley value. The <code>ctree</code> and <code>xgboost</code>
approaches produce similar figures, while the <code>gaussian</code>
approach both shrinks and groups the Shapley values for the
<code>trend</code> feature, while it produces more negative values for
the <code>cosyear</code> feature.</p>
<p>When going from symmetric to asymmetric Shapley values, we see that
many of the features’ Shapley values are now shrunken closer to zero,
especially <code>temp</code> and <code>atemp</code>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_beeswarms</span><span class="op">(</span><span class="va">explanation_asym_con</span>, title <span class="op">=</span> <span class="st">"Asymmetric conditional Shapley values"</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_asymmetric_causal%2Fexplanation_asym_con_beeswarm-1.png"></p>
<p>We can also compare the obtained symmetric and asymmetric conditional
Shapley values for the 6 explicands. We often see that the asymmetric
version gives larger Shapley values to the distal/root causes, i.e.,
<code>trend</code> and <code>cosyear</code>, than the symmetric version.
This is in line with Section 3.2 in <span class="citation">Frye, Rowat,
and Feige (2020)</span>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Order the symmetric and asymmetric conditional explanations into a joint list</span></span>
<span><span class="va">explanation_sym_con_tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/copy.html" class="external-link">copy</a></span><span class="op">(</span><span class="va">explanation_sym_con</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">explanation_sym_con_tmp</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">explanation_sym_con_tmp</span><span class="op">)</span>, <span class="st">"_sym"</span><span class="op">)</span></span>
<span><span class="va">explanation_asym_con_tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/copy.html" class="external-link">copy</a></span><span class="op">(</span><span class="va">explanation_asym_con</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">explanation_asym_con_tmp</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">explanation_asym_con_tmp</span><span class="op">)</span>, <span class="st">"_asym"</span><span class="op">)</span></span>
<span><span class="va">explanation_asym_sym_con</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">explanation_sym_con_tmp</span>, <span class="va">explanation_asym_con_tmp</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span>, <span class="fl">2</span>, <span class="fl">5</span>, <span class="fl">3</span>, <span class="fl">6</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="../reference/plot_SV_several_approaches.html">plot_SV_several_approaches</a></span><span class="op">(</span><span class="va">explanation_asym_sym_con</span>, <span class="va">index_x_explain</span>, brewer_palette <span class="op">=</span> <span class="st">"Paired"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_asymmetric_causal%2Fsym_and_asym_Shapley_values-1.png"></p>
</div>
<div class="section level3">
<h3 id="symmetric-marginal-shapley-values">Symmetric marginal Shapley values<a class="anchor" aria-label="anchor" href="#symmetric-marginal-shapley-values"></a>
</h3>
<p>For marginal Shapley values, we can only consider the symmetric
version as we must set <code>causal_ordering = list(1:7)</code> (or
<code>NULL</code>) and <code>confounding = TRUE</code>. Setting
<code>asymmetric = TRUE</code> will have no effect, as the causal
ordering consists of only a single component containing all features,
i.e., all coalitions respect the causal ordering. As stated above,
<code>shapr</code> generates the marginal Monte Carlos samples from the
Gaussian marginals if <code>approach = "gaussian"</code>, while for all
other Monte Carlo approaches the marginals are estimated from the
training data, i.e., assuming feature independence. Thus, it does not
matter if we set <code>approach = "independence"</code> or any other of
the Monte Carlo-based approaches. We use
<code>approach = "independence"</code> for clarity. Furthermore, we also
obtain marginal Shapley values by using the conditional Shapley value
framework with the <code>independence</code> approach. However, note
that there will be a minuscule difference in the produced Shapley values
due to different sampling setups/orders.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">explanation_sym_marg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Here we sample from the estimated Gaussian marginals</span></span>
<span><span class="va">explanation_sym_marg</span><span class="op">[[</span><span class="st">"gaussian"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>  n_MC_samples <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"gaussian"</span>,</span>
<span>  asymmetric <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  causal_ordering <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">7</span><span class="op">)</span>,</span>
<span>  confounding <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Success with message:</span></span>
<span><span class="co">#&gt; max_n_coalitions is NULL or larger than or 2^n_features = 128, </span></span>
<span><span class="co">#&gt; and is therefore set to 2^n_features = 128.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Starting `shapr::explain()` at 2025-01-20 11:57:17 ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • Model class: &lt;xgb.Booster&gt;</span></span>
<span><span class="co">#&gt; • Approach: gaussian</span></span>
<span><span class="co">#&gt; • Iterative estimation: TRUE</span></span>
<span><span class="co">#&gt; • Number of feature-wise Shapley values: 7</span></span>
<span><span class="co">#&gt; • Number of observations to explain: 144</span></span>
<span><span class="co">#&gt; • Causal ordering: {trend, cosyear, sinyear, temp, atemp, windspeed, hum}</span></span>
<span><span class="co">#&gt; • Components with confounding: {trend, cosyear, sinyear, temp, atemp, windspeed, hum}</span></span>
<span><span class="co">#&gt; • Computations (temporary) saved at: '/tmp/RtmpwfPA0n/shapr_obj_35d5101310bf78.rds'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── iterative computation started ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 1 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 14 of 128 coalitions, 14 new.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 2 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 26 of 128 coalitions, 12 new.</span></span>
<span></span>
<span><span class="co"># Here we sample from the marginals of the training data</span></span>
<span><span class="va">explanation_sym_marg</span><span class="op">[[</span><span class="st">"independence_marg"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>  n_MC_samples <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"independence"</span>,</span>
<span>  asymmetric <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  causal_ordering <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">7</span><span class="op">)</span>,</span>
<span>  confounding <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Success with message:</span></span>
<span><span class="co">#&gt; max_n_coalitions is NULL or larger than or 2^n_features = 128, </span></span>
<span><span class="co">#&gt; and is therefore set to 2^n_features = 128.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Starting `shapr::explain()` at 2025-01-20 11:57:24 ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • Model class: &lt;xgb.Booster&gt;</span></span>
<span><span class="co">#&gt; • Approach: independence</span></span>
<span><span class="co">#&gt; • Iterative estimation: TRUE</span></span>
<span><span class="co">#&gt; • Number of feature-wise Shapley values: 7</span></span>
<span><span class="co">#&gt; • Number of observations to explain: 144</span></span>
<span><span class="co">#&gt; • Causal ordering: {trend, cosyear, sinyear, temp, atemp, windspeed, hum}</span></span>
<span><span class="co">#&gt; • Components with confounding: {trend, cosyear, sinyear, temp, atemp, windspeed, hum}</span></span>
<span><span class="co">#&gt; • Computations (temporary) saved at: '/tmp/RtmpwfPA0n/shapr_obj_35d510627b1e2c.rds'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── iterative computation started ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 1 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 14 of 128 coalitions, 14 new.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 2 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 26 of 128 coalitions, 12 new.</span></span>
<span></span>
<span><span class="co"># Here we use the conditional Shapley value framework with the `independence` approach</span></span>
<span><span class="va">explanation_sym_marg</span><span class="op">[[</span><span class="st">"independence_con"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>  n_MC_samples <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"independence"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Success with message:</span></span>
<span><span class="co">#&gt; max_n_coalitions is NULL or larger than or 2^n_features = 128, </span></span>
<span><span class="co">#&gt; and is therefore set to 2^n_features = 128.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Starting `shapr::explain()` at 2025-01-20 11:57:32 ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • Model class: &lt;xgb.Booster&gt;</span></span>
<span><span class="co">#&gt; • Approach: independence</span></span>
<span><span class="co">#&gt; • Iterative estimation: TRUE</span></span>
<span><span class="co">#&gt; • Number of feature-wise Shapley values: 7</span></span>
<span><span class="co">#&gt; • Number of observations to explain: 144</span></span>
<span><span class="co">#&gt; • Computations (temporary) saved at: '/tmp/RtmpwfPA0n/shapr_obj_35d5105353e947.rds'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── iterative computation started ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 1 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 14 of 128 coalitions, 14 new.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 2 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 26 of 128 coalitions, 12 new.</span></span></code></pre></div>
<p>We can look the beeswarm plots</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">print_MSEv_scores_and_time</span><span class="op">(</span><span class="va">explanation_sym_marg</span><span class="op">)</span></span>
<span><span class="co">#&gt;                      MSEv MSEv_sd Time (secs)</span></span>
<span><span class="co">#&gt; gaussian          1380661  111239        6.57</span></span>
<span><span class="co">#&gt; independence_marg 1379855  110801        8.18</span></span>
<span><span class="co">#&gt; independence_con  1379646  110728        6.67</span></span>
<span></span>
<span><span class="fu">plot_beeswarms</span><span class="op">(</span><span class="va">explanation_sym_marg</span>, title <span class="op">=</span> <span class="st">"Symmetric marginal Shapley values"</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_asymmetric_causal%2Fexplanation_sym_mar_beeswarm-1.png"></p>
</div>
<div class="section level3">
<h3 id="causal-shapley-values">Causal Shapley values<a class="anchor" aria-label="anchor" href="#causal-shapley-values"></a>
</h3>
<p>To compute (symmetric/asymmetric) causal Shapley values, we have to
provide the <code>causal_ordering</code> and <code>confounding</code>
objects. We set them to be
<code>causal_ordering = list(1, 2:3, 4:7)</code> and
<code>confounding = c(FALSE, TRUE, FALSE)</code>, as explained
above.</p>
<p>The causal framework takes longer than the other frameworks, as
generating the the Monte Carlo samples often consists of a chain of
sampling steps. For example, for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>𝒮</mi><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">\mathcal{S} = {2}</annotation></semantics></math>,
we must generate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mn>1</mn></msub><mo>,</mo><msub><mi>X</mi><mn>3</mn></msub><mo>,</mo><msub><mi>X</mi><mn>4</mn></msub><mo>,</mo><msub><mi>X</mi><mn>5</mn></msub><mo>,</mo><msub><mi>X</mi><mn>6</mn></msub><mo>,</mo><msub><mi>X</mi><mn>7</mn></msub><mo>∣</mo><msub><mi>X</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">X_1,X_3,X_4,X_5,X_6,X_7 \mid X_2</annotation></semantics></math>.
However, we cannot do this directly due to the
<code>causal_ordering</code> and <code>confounding</code> specified
above. To generate the Monte Carlo samples, we have to follow a chain of
sampling steps. More precisely, we first need to generate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>X</mi><mn>1</mn></msub><annotation encoding="application/x-tex">X_1</annotation></semantics></math>
from the marginal, then
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mn>3</mn></msub><mo>∣</mo><msub><mi>X</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">X_3 \mid X_1</annotation></semantics></math>,
and finally
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mn>4</mn></msub><mo>,</mo><msub><mi>X</mi><mn>5</mn></msub><mo>,</mo><msub><mi>X</mi><mn>6</mn></msub><mo>,</mo><msub><mi>X</mi><mn>7</mn></msub><mo>∣</mo><msub><mi>X</mi><mn>1</mn></msub><mo>,</mo><msub><mi>X</mi><mn>2</mn></msub><mo>,</mo><msub><mi>X</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">X_4,X_5,X_6,X_7 \mid X_1,X_2,X_3</annotation></semantics></math>.
The latter two steps are done by using the provided
<code>approach</code> to model the conditional distributions. The
<code>internal$objects$S_causal_steps_strings</code> object contains the
sampling steps needed for the different feature combinations/coalitions
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝒮</mi><annotation encoding="application/x-tex">\mathcal{S}</annotation></semantics></math>.</p>
<p>For causal Shapley values, only the Monte Carlo-based approaches are
applicable.</p>
<div class="section level4">
<h4 id="symmetric">Symmetric<a class="anchor" aria-label="anchor" href="#symmetric"></a>
</h4>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">explanation_sym_cau</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">explanation_sym_cau</span><span class="op">[[</span><span class="st">"gaussian"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>  n_MC_samples <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"gaussian"</span>,</span>
<span>  asymmetric <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  causal_ordering <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">4</span><span class="op">:</span><span class="fl">7</span><span class="op">)</span>,</span>
<span>  confounding <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">FALSE</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  iterative <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co"># Set to FALSE to get a single iteration to illustrate sampling steps below</span></span>
<span>  exact <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Success with message:</span></span>
<span><span class="co">#&gt; max_n_coalitions is NULL or larger than or 2^n_features = 128, </span></span>
<span><span class="co">#&gt; and is therefore set to 2^n_features = 128.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Starting `shapr::explain()` at 2025-01-20 11:57:40 ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • Model class: &lt;xgb.Booster&gt;</span></span>
<span><span class="co">#&gt; • Approach: gaussian</span></span>
<span><span class="co">#&gt; • Iterative estimation: FALSE</span></span>
<span><span class="co">#&gt; • Number of feature-wise Shapley values: 7</span></span>
<span><span class="co">#&gt; • Number of observations to explain: 144</span></span>
<span><span class="co">#&gt; • Causal ordering: {trend}, {cosyear, sinyear}, {temp, atemp, windspeed, hum}</span></span>
<span><span class="co">#&gt; • Components with confounding: {cosyear, sinyear}</span></span>
<span><span class="co">#&gt; • Computations (temporary) saved at: '/tmp/RtmpwfPA0n/shapr_obj_35d51010eb7291.rds'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Main computation started ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ℹ Using 128 of 128 coalitions.</span></span>
<span></span>
<span><span class="co"># Look at the sampling steps for the third coalition (S = {2})</span></span>
<span><span class="va">explanation_sym_cau</span><span class="op">$</span><span class="va">gaussian</span><span class="op">$</span><span class="va">internal</span><span class="op">$</span><span class="va">iter_list</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">S_causal_steps_strings</span><span class="op">$</span><span class="va">id_coalition_3</span></span>
<span><span class="co">#&gt; [1] "1|"            "3|1"           "4,5,6,7|1,2,3"</span></span>
<span></span>
<span><span class="co"># Use the copula approach</span></span>
<span><span class="va">explanation_sym_cau</span><span class="op">[[</span><span class="st">"copula"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>  n_MC_samples <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"copula"</span>,</span>
<span>  asymmetric <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  causal_ordering <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">4</span><span class="op">:</span><span class="fl">7</span><span class="op">)</span>,</span>
<span>  confounding <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">FALSE</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Success with message:</span></span>
<span><span class="co">#&gt; max_n_coalitions is NULL or larger than or 2^n_features = 128, </span></span>
<span><span class="co">#&gt; and is therefore set to 2^n_features = 128.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Starting `shapr::explain()` at 2025-01-20 11:58:10 ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • Model class: &lt;xgb.Booster&gt;</span></span>
<span><span class="co">#&gt; • Approach: copula</span></span>
<span><span class="co">#&gt; • Iterative estimation: TRUE</span></span>
<span><span class="co">#&gt; • Number of feature-wise Shapley values: 7</span></span>
<span><span class="co">#&gt; • Number of observations to explain: 144</span></span>
<span><span class="co">#&gt; • Causal ordering: {trend}, {cosyear, sinyear}, {temp, atemp, windspeed, hum}</span></span>
<span><span class="co">#&gt; • Components with confounding: {cosyear, sinyear}</span></span>
<span><span class="co">#&gt; • Computations (temporary) saved at: '/tmp/RtmpwfPA0n/shapr_obj_35d51078f28c99.rds'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── iterative computation started ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 1 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 14 of 128 coalitions, 14 new.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 2 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 26 of 128 coalitions, 12 new.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 3 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 28 of 128 coalitions, 2 new.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 4 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 30 of 128 coalitions, 2 new.</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">print_MSEv_scores_and_time</span><span class="op">(</span><span class="va">explanation_sym_cau</span><span class="op">)</span></span>
<span><span class="co">#&gt;             MSEv MSEv_sd Time (secs)</span></span>
<span><span class="co">#&gt; gaussian 1112304   85462       30.04</span></span>
<span><span class="co">#&gt; copula   1229027   96067       16.49</span></span>
<span><span class="fu">plot_beeswarms</span><span class="op">(</span><span class="va">explanation_sym_cau</span>, title <span class="op">=</span> <span class="st">"Symmetric causal Shapley values"</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_asymmetric_causal%2Fexplanation_sym_cau_beeswarm-1.png"></p>
</div>
<div class="section level4">
<h4 id="asymmetric">Asymmetric<a class="anchor" aria-label="anchor" href="#asymmetric"></a>
</h4>
<p>We now turn to asymmetric causal Shapley values. That is, we only use
the coalitions that respects the causal ordering. Thus, the computations
are faster as the number of coalitions are reduced.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">explanation_asym_cau</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">explanation_asym_cau</span><span class="op">[[</span><span class="st">"gaussian"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>  n_MC_samples <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"gaussian"</span>,</span>
<span>  asymmetric <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  causal_ordering <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">4</span><span class="op">:</span><span class="fl">7</span><span class="op">)</span>,</span>
<span>  confounding <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">FALSE</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Success with message:</span></span>
<span><span class="co">#&gt; max_n_coalitions is NULL or larger than or number of coalitions respecting the causal</span></span>
<span><span class="co">#&gt; ordering 20, and is therefore set to 20.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Starting `shapr::explain()` at 2025-01-20 11:58:27 ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • Model class: &lt;xgb.Booster&gt;</span></span>
<span><span class="co">#&gt; • Approach: gaussian</span></span>
<span><span class="co">#&gt; • Iterative estimation: TRUE</span></span>
<span><span class="co">#&gt; • Number of feature-wise Shapley values: 7</span></span>
<span><span class="co">#&gt; • Number of observations to explain: 144</span></span>
<span><span class="co">#&gt; • Number of asymmetric coalitions: 20</span></span>
<span><span class="co">#&gt; • Causal ordering: {trend}, {cosyear, sinyear}, {temp, atemp, windspeed, hum}</span></span>
<span><span class="co">#&gt; • Components with confounding: {cosyear, sinyear}</span></span>
<span><span class="co">#&gt; • Computations (temporary) saved at: '/tmp/RtmpwfPA0n/shapr_obj_35d510d0258d1.rds'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── iterative computation started ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 1 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 13 of 20 coalitions, 13 new.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 2 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 15 of 20 coalitions, 2 new.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 3 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 18 of 20 coalitions, 3 new.</span></span>
<span></span>
<span><span class="co"># Use the copula approach</span></span>
<span><span class="va">explanation_asym_cau</span><span class="op">[[</span><span class="st">"copula"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>  n_MC_samples <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"copula"</span>,</span>
<span>  asymmetric <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  causal_ordering <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">4</span><span class="op">:</span><span class="fl">7</span><span class="op">)</span>,</span>
<span>  confounding <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">FALSE</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Success with message:</span></span>
<span><span class="co">#&gt; max_n_coalitions is NULL or larger than or number of coalitions respecting the causal</span></span>
<span><span class="co">#&gt; ordering 20, and is therefore set to 20.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Starting `shapr::explain()` at 2025-01-20 11:58:31 ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • Model class: &lt;xgb.Booster&gt;</span></span>
<span><span class="co">#&gt; • Approach: copula</span></span>
<span><span class="co">#&gt; • Iterative estimation: TRUE</span></span>
<span><span class="co">#&gt; • Number of feature-wise Shapley values: 7</span></span>
<span><span class="co">#&gt; • Number of observations to explain: 144</span></span>
<span><span class="co">#&gt; • Number of asymmetric coalitions: 20</span></span>
<span><span class="co">#&gt; • Causal ordering: {trend}, {cosyear, sinyear}, {temp, atemp, windspeed, hum}</span></span>
<span><span class="co">#&gt; • Components with confounding: {cosyear, sinyear}</span></span>
<span><span class="co">#&gt; • Computations (temporary) saved at: '/tmp/RtmpwfPA0n/shapr_obj_35d5104a4aeda.rds'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── iterative computation started ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 1 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 13 of 20 coalitions, 13 new.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 2 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 16 of 20 coalitions, 3 new.</span></span>
<span></span>
<span><span class="co"># Use the vaeac approach</span></span>
<span><span class="va">explanation_asym_cau</span><span class="op">[[</span><span class="st">"vaeac"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>   model <span class="op">=</span> <span class="va">model</span>,</span>
<span>   x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>   x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>   phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>   n_MC_samples <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>   approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>   vaeac.epochs <span class="op">=</span> <span class="fl">20</span>,</span>
<span>   asymmetric <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>   causal_ordering <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">4</span><span class="op">:</span><span class="fl">7</span><span class="op">)</span>,</span>
<span>   confounding <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">FALSE</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span></span>
<span> <span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Success with message:</span></span>
<span><span class="co">#&gt; max_n_coalitions is NULL or larger than or number of coalitions respecting the causal</span></span>
<span><span class="co">#&gt; ordering 20, and is therefore set to 20.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Starting `shapr::explain()` at 2025-01-20 11:58:35 ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • Model class: &lt;xgb.Booster&gt;</span></span>
<span><span class="co">#&gt; • Approach: vaeac</span></span>
<span><span class="co">#&gt; • Iterative estimation: FALSE</span></span>
<span><span class="co">#&gt; • Number of feature-wise Shapley values: 7</span></span>
<span><span class="co">#&gt; • Number of observations to explain: 144</span></span>
<span><span class="co">#&gt; • Number of asymmetric coalitions: 20</span></span>
<span><span class="co">#&gt; • Causal ordering: {trend}, {cosyear, sinyear}, {temp, atemp, windspeed, hum}</span></span>
<span><span class="co">#&gt; • Components with confounding: {cosyear, sinyear}</span></span>
<span><span class="co">#&gt; • Computations (temporary) saved at: '/tmp/RtmpwfPA0n/shapr_obj_35d51011a1235e.rds'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Main computation started ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ℹ Using 20 of 20 coalitions.</span></span></code></pre></div>
<p>We can look at the elapsed time. See the <a href="#Implementation_details">implementation details</a> for an
explanation.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">print_time</span><span class="op">(</span><span class="va">explanation_asym_cau</span><span class="op">)</span></span>
<span><span class="co">#&gt;      gaussian copula  vaeac</span></span>
<span><span class="co">#&gt; [1,]   4.1399 4.2475 462.34</span></span></code></pre></div>
<p>We can then plot the beeswarm plots.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot the beeswarm plots</span></span>
<span><span class="fu">plot_beeswarms</span><span class="op">(</span><span class="va">explanation_asym_cau</span>, title <span class="op">=</span> <span class="st">"Asymmetric causal Shapley values"</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_asymmetric_causal%2Fexplanation_asym_cau_beeswarm-1.png"></p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot the Shapley values</span></span>
<span><span class="fu"><a href="../reference/plot_SV_several_approaches.html">plot_SV_several_approaches</a></span><span class="op">(</span><span class="va">explanation_asym_cau</span>, <span class="va">index_x_explain</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_asymmetric_causal%2Fexplanation_asym_cau_SV-1.png"></p>
<p>We can also use the other Monte Carlo-based approaches
(<code>independence</code> and <code>empirical</code>), too.</p>
</div>
</div>
<div class="section level3">
<h3 id="comparing-the-frameworks">Comparing the frameworks<a class="anchor" aria-label="anchor" href="#comparing-the-frameworks"></a>
</h3>
<p>Here we plot the obtained Shapley values for the six explicand when
using the <code>gaussian</code> approach in the different Shapley value
explanation frameworks, and we see that the different frameworks provide
different explanations. The largest difference are between whether we
use the symmetric or asymmetric version. To summarize, asymmetric
conditional/causal Shapley values focus on the root cause, marginal
Shapley values on the more direct effect, and symmetric
conditional/causal Shapley consider both for a more natural
explanation.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">explanation_gaussian</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  symmetric_marginal <span class="op">=</span> <span class="va">explanation_sym_marg</span><span class="op">$</span><span class="va">gaussian</span>,</span>
<span>  symmetric_conditional <span class="op">=</span> <span class="va">explanation_sym_con</span><span class="op">$</span><span class="va">gaussian</span>,</span>
<span>  symmetric_causal <span class="op">=</span> <span class="va">explanation_sym_cau</span><span class="op">$</span><span class="va">gaussian</span>,</span>
<span>  asymmetric_conditional <span class="op">=</span> <span class="va">explanation_asym_con</span><span class="op">$</span><span class="va">gaussian</span>,</span>
<span>  asymmetric_causal <span class="op">=</span> <span class="va">explanation_asym_cau</span><span class="op">$</span><span class="va">gaussian</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plot_SV_several_approaches.html">plot_SV_several_approaches</a></span><span class="op">(</span><span class="va">explanation_gaussian</span>, <span class="va">index_x_explain</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Shapley value prediction explanation (approach = 'gaussian')"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Framework"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_asymmetric_causal%2Fcompare_plots-1.png"></p>
</div>
<div class="section level3">
<h3 id="scatter-plots-marginal-vs--causal-shapley-values">Scatter plots: marginal vs. causal Shapley values<a class="anchor" aria-label="anchor" href="#scatter-plots-marginal-vs--causal-shapley-values"></a>
</h3>
<p>In this section, we produce scatter plots comparing the symmetric
marginal and symmetric causal Shapley values for the temperature feature
<code>temp</code> and the seasonal feature <code>cosyear</code> for all
explicands. The plots shows that the marginal Shapley values almost
purely explain the predictions based on temperature, while the causal
Shapley values also give credit to season. We can change the features
and frameworks in the code below, but we chose these values to replicate
Figure 3 in <span class="citation">Heskes et al. (2020)</span>.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># The color of the points</span></span>
<span><span class="va">color</span> <span class="op">&lt;-</span> <span class="st">"temp"</span></span>
<span></span>
<span><span class="co"># The features we want to compare</span></span>
<span><span class="va">feature_1</span> <span class="op">&lt;-</span> <span class="st">"cosyear"</span></span>
<span><span class="va">feature_2</span> <span class="op">&lt;-</span> <span class="st">"temp"</span></span>
<span></span>
<span><span class="co"># The Shapley value frameworks we want to compare</span></span>
<span><span class="va">sv_framework_1</span> <span class="op">&lt;-</span> <span class="va">explanation_sym_marg</span><span class="op">[[</span><span class="st">"gaussian"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">sv_framework_1_str</span> <span class="op">&lt;-</span> <span class="st">"Marginal SV"</span></span>
<span><span class="va">sv_framework_2</span> <span class="op">&lt;-</span> <span class="va">explanation_sym_cau</span><span class="op">[[</span><span class="st">"gaussian"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">sv_framework_2_str</span> <span class="op">&lt;-</span> <span class="st">"Causal SV"</span></span>
<span></span>
<span><span class="co"># Set up the data.frame we are going to plot</span></span>
<span><span class="va">sv_correlation_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  color <span class="op">=</span> <span class="va">x_explain</span><span class="op">[</span>, <span class="va">color</span><span class="op">]</span>,</span>
<span>  sv_framework_1_feature_1 <span class="op">=</span> <span class="va">sv_framework_1</span><span class="op">$</span><span class="va">shapley_values_est</span><span class="op">[[</span><span class="va">feature_1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  sv_framework_2_feature_1 <span class="op">=</span> <span class="va">sv_framework_2</span><span class="op">$</span><span class="va">shapley_values_est</span><span class="op">[[</span><span class="va">feature_1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  sv_framework_1_feature_2 <span class="op">=</span> <span class="va">sv_framework_1</span><span class="op">$</span><span class="va">shapley_values_est</span><span class="op">[[</span><span class="va">feature_2</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  sv_framework_2_feature_2 <span class="op">=</span> <span class="va">sv_framework_2</span><span class="op">$</span><span class="va">shapley_values_est</span><span class="op">[[</span><span class="va">feature_2</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Make the plots</span></span>
<span><span class="va">scatterplot_topleft</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>    <span class="va">sv_correlation_df</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">sv_framework_1_feature_2</span>, y <span class="op">=</span> <span class="va">sv_framework_1_feature_1</span>, color <span class="op">=</span> <span class="va">color</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">sv_framework_1_str</span>, <span class="va">feature_2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">sv_framework_1_str</span>, <span class="va">feature_1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1500</span>, <span class="fl">1000</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1000</span>, <span class="fl">0</span>, <span class="fl">1000</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">500</span>, <span class="fl">500</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">500</span>, <span class="fl">0</span>, <span class="fl">500</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_color_gradient</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">"blue"</span>, high <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>    axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>    axis.ticks.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">scatterplot_topright</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>    <span class="va">sv_correlation_df</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">sv_framework_2_feature_1</span>, y <span class="op">=</span> <span class="va">sv_framework_1_feature_1</span>, color <span class="op">=</span> <span class="va">color</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_color_gradient</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">"blue"</span>, high <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">sv_framework_2_str</span>, <span class="va">feature_1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">sv_framework_1_str</span>, <span class="va">feature_1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1500</span>, <span class="fl">1000</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1000</span>, <span class="fl">0</span>, <span class="fl">1000</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">500</span>, <span class="fl">500</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">500</span>, <span class="fl">0</span>, <span class="fl">500</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>    axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.ticks.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.ticks.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">scatterplot_bottomleft</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>    <span class="va">sv_correlation_df</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">sv_framework_1_feature_2</span>, y <span class="op">=</span> <span class="va">sv_framework_2_feature_2</span>, color <span class="op">=</span> <span class="va">color</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_color_gradient</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">"blue"</span>, high <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">sv_framework_1_str</span>, <span class="va">feature_2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">sv_framework_2_str</span>, <span class="va">feature_2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1500</span>, <span class="fl">1000</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1000</span>, <span class="fl">0</span>, <span class="fl">1000</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1000</span>, <span class="fl">1000</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">500</span>, <span class="fl">0</span>, <span class="fl">500</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>    axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>    axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">scatterplot_bottomright</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>    <span class="va">sv_correlation_df</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">sv_framework_2_feature_1</span>, y <span class="op">=</span> <span class="va">sv_framework_2_feature_2</span>, color <span class="op">=</span> <span class="va">color</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">sv_framework_2_str</span>, <span class="va">feature_1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">sv_framework_2_str</span>, <span class="va">feature_2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1500</span>, <span class="fl">1000</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1000</span>, <span class="fl">0</span>, <span class="fl">1000</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1000</span>, <span class="fl">1000</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">500</span>, <span class="fl">0</span>, <span class="fl">500</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_color_gradient</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">"blue"</span>, high <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>    axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>    axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.ticks.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot of the trend of the data</span></span>
<span><span class="va">bike_plot_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">bike</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">trend</span>, y <span class="op">=</span> <span class="va">cnt</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">color</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_color_gradient</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">"blue"</span>, high <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">color</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Days since 1 January 2011"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Number of bikes rented"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"right"</span>, legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine the plots</span></span>
<span><span class="fu">ggpubr</span><span class="fu">::</span><span class="fu">ggarrange</span><span class="op">(</span></span>
<span>  <span class="va">bike_plot_new</span>,</span>
<span>  <span class="fu">ggpubr</span><span class="fu">::</span><span class="fu">ggarrange</span><span class="op">(</span></span>
<span>    <span class="va">scatterplot_topleft</span>,</span>
<span>    <span class="va">scatterplot_topright</span>,</span>
<span>    <span class="va">scatterplot_bottomleft</span>,</span>
<span>    <span class="va">scatterplot_bottomright</span>,</span>
<span>    legend <span class="op">=</span> <span class="st">"none"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  nrow <span class="op">=</span> <span class="fl">2</span>, heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_asymmetric_causal%2Fscatter_plots-1.png"></p>
</div>
<div class="section level3">
<h3 id="investigating-two-similar-days">Investigating two similar days<a class="anchor" aria-label="anchor" href="#investigating-two-similar-days"></a>
</h3>
<p>We investigate the difference between symmetric/asymmetric
conditional, symmetric/asymmetric causal, and marginal Shapley values
for two days: October 10 and December 3, 2012. They have more or less
the same temperature of 13 and 13.27 degrees Celsius, and predicted bike
counts of 6117 and 6241, respectively. The figure below is an extension
of Figure 4 in <span class="citation">Heskes et al. (2020)</span>, as
they only included asymmetric conditional, symmetric causal, and
marginal Shapley values.</p>
<p>We plot the various Shapley values for the <code>cosyear</code> and
<code>temp</code> features below. We obtain the same results as <span class="citation">Heskes et al. (2020)</span> obtained, namely, that the
marginal Shapley value explanation framework provides similar
explanation for both days. I.e., it only considers the direct effect of
<code>temp</code>. The asymmetric conditional and causal Shapley values
are almost indistinguishable and put the most weight on the ‘root’ cause
<code>cosyear</code>. <span class="citation">Heskes et al. (2020)</span>
states that the symmetric causal Shapley values provides a sensible
balance between the two extremes and gives credit to both season and
temperature, but still different explanation for the two days.</p>
<p>However, as we also include symmetric conditional Shapley values, we
see that they are extremely similar to symmetric causal Shapley values.
I.e., the conditional Shapley value explanation framework also provides
a sensible balance between marginal and asymmetric Shapley values. To
summarize: as concluded by <span class="citation">Heskes et al.
(2020)</span> in their Figure 4, the asymmetric conditional/causal
Shapley values focus on the root cause, marginal Shapley values on the
more direct effect, and symmetric conditional/causal Shapley consider
both for a more natural explanation.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Features of interest</span></span>
<span><span class="va">features</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cosyear"</span>, <span class="st">"temp"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get explicands with similar temperature: 2012-10-09 (October) and 2012-12-03 (December)</span></span>
<span><span class="va">dates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2012-10-09"</span>, <span class="st">"2012-12-03"</span><span class="op">)</span></span>
<span><span class="va">dates_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">dates</span>, <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">x_explain</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">bike</span><span class="op">$</span><span class="va">dteday</span> <span class="op">==</span> <span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># predict(model, x_explain)[dates_idx] + mean(y_train_nc) # predicted values for the two points</span></span>
<span></span>
<span><span class="co"># List of the Shapley value explanations</span></span>
<span><span class="va">explanations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"Sym. Mar."</span> <span class="op">=</span> <span class="va">explanation_sym_marg</span><span class="op">[[</span><span class="st">"gaussian"</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  <span class="st">"Sym. Con."</span> <span class="op">=</span> <span class="va">explanation_sym_con</span><span class="op">[[</span><span class="st">"gaussian"</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  <span class="st">"Sym. Cau."</span> <span class="op">=</span> <span class="va">explanation_sym_cau</span><span class="op">[[</span><span class="st">"gaussian"</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  <span class="st">"Asym. Con."</span> <span class="op">=</span> <span class="va">explanation_asym_con</span><span class="op">[[</span><span class="st">"gaussian"</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  <span class="st">"Asym. Cau."</span> <span class="op">=</span> <span class="va">explanation_asym_cau</span><span class="op">[[</span><span class="st">"gaussian"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract the relevant Shapley values</span></span>
<span><span class="va">explanations_extracted</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/rbindlist.html" class="external-link">rbindlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">explanations</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">idx</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">explanations</span><span class="op">[[</span><span class="va">idx</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">shapley_values_est</span><span class="op">[</span></span>
<span>    <span class="va">dates_idx</span>, <span class="va">..features</span></span>
<span>  <span class="op">]</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span>Date <span class="op">=</span> <span class="va">dates</span>, type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">explanations</span><span class="op">)</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set type to be a ordered factor</span></span>
<span><span class="va">explanations_extracted</span><span class="op">[</span>, <span class="va">type</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">type</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">explanations</span><span class="op">)</span>, ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Convert from wide to long data table</span></span>
<span><span class="va">dt_all</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/melt.data.table.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">explanations_extracted</span>,</span>
<span>  id.vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Date"</span>, <span class="st">"type"</span><span class="op">)</span>,</span>
<span>  variable.name <span class="op">=</span> <span class="st">"feature"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Make the plot</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">dt_all</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">feature</span>, y <span class="op">=</span> <span class="va">value</span>, group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/interaction.html" class="external-link">interaction</a></span><span class="op">(</span><span class="va">Date</span>, <span class="va">feature</span><span class="op">)</span>,</span>
<span>  fill <span class="op">=</span> <span class="va">Date</span>, label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">value</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_col</a></span><span class="op">(</span>position <span class="op">=</span> <span class="st">"dodge"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Shapley value"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"indianred4"</span>, <span class="st">"ivory4"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    legend.position.inside <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.75</span>, <span class="fl">0.25</span><span class="op">)</span>, axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,</span>
<span>    legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">16</span><span class="op">)</span>, legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span>,</span>
<span>    axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>, axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>    strip.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="figure_asymmetric_causal%2Ftwo_dates_1-1.png"></p>
<p>We can also make a similar plot using the
<code>plot_SV_several_approaches</code> function in <code>shapr</code>,
but then we get each explicand in a separate facet instead of a facet
for each framework.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Here 2012-10-09 is the left facet and 2012-12-03 the right facet</span></span>
<span><span class="fu"><a href="../reference/plot_SV_several_approaches.html">plot_SV_several_approaches</a></span><span class="op">(</span><span class="va">explanations</span>,</span>
<span>  index_explicands <span class="op">=</span> <span class="va">dates_idx</span>,</span>
<span>  only_these_features <span class="op">=</span> <span class="va">features</span>, <span class="co"># Can include more features.</span></span>
<span>  facet_scales <span class="op">=</span> <span class="st">"free_x"</span>,</span>
<span>  horizontal_bars <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  axis_labels_n_dodge <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_asymmetric_causal%2Ftwo_dates_2-1.png"></p>
<p>Furthermore, instead of doing as <span class="citation">Heskes et al.
(2020)</span> and only considering the features <code>cosyear</code> and
<code>temp</code>, we can plot all features, too, to get a more complete
overview.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Here 2012-10-09 is the left facet and 2012-12-03 the right facet</span></span>
<span><span class="fu"><a href="../reference/plot_SV_several_approaches.html">plot_SV_several_approaches</a></span><span class="op">(</span><span class="va">explanations</span>,</span>
<span>  index_explicands <span class="op">=</span> <span class="va">dates_idx</span>,</span>
<span>  facet_scales <span class="op">=</span> <span class="st">"free_x"</span>,</span>
<span>  horizontal_bars <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  axis_labels_rotate_angle <span class="op">=</span> <span class="fl">45</span>,</span>
<span>  digits <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_asymmetric_causal%2Ftwo_dates_3-1.png"></p>
</div>
<div class="section level3">
<h3 id="sampling-of-coalitions">Sampling of coalitions<a class="anchor" aria-label="anchor" href="#sampling-of-coalitions"></a>
</h3>
<p>We can use <code>max_n_coalitions</code> to specify/reduce the number
of coalitions to use when computing the Shapley value explanation
framework. This applies to marginal, conditional, and causal Shapley
values, both the symmetric and asymmetric versions. However, recall that
the asymmetric versions already have fewer valid coalitions due to the
causal ordering.</p>
<p>In the example below, we demonstrate the sampling of coalitions for
the asymmetric and symmetric causal Shapley value explanation
frameworks. We half the number of coalitions for both versions and see
that the elapsed times are approximately halved, too.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">explanation_n_coal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">explanation_n_coal</span><span class="op">[[</span><span class="st">"sym_cau_gaussian_64"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"gaussian"</span>,</span>
<span>  phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>  asymmetric <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  causal_ordering <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">4</span><span class="op">:</span><span class="fl">7</span><span class="op">)</span>,</span>
<span>  confounding <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">FALSE</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  max_n_coalitions <span class="op">=</span> <span class="fl">64</span> <span class="co"># Instead of 128</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Starting `shapr::explain()` at 2025-01-20 12:06:23 ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • Model class: &lt;xgb.Booster&gt;</span></span>
<span><span class="co">#&gt; • Approach: gaussian</span></span>
<span><span class="co">#&gt; • Iterative estimation: TRUE</span></span>
<span><span class="co">#&gt; • Number of feature-wise Shapley values: 7</span></span>
<span><span class="co">#&gt; • Number of observations to explain: 144</span></span>
<span><span class="co">#&gt; • Causal ordering: {trend}, {cosyear, sinyear}, {temp, atemp, windspeed, hum}</span></span>
<span><span class="co">#&gt; • Components with confounding: {cosyear, sinyear}</span></span>
<span><span class="co">#&gt; • Computations (temporary) saved at: '/tmp/RtmpwfPA0n/shapr_obj_35d510423d2520.rds'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── iterative computation started ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 1 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 14 of 128 coalitions, 14 new.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 2 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 26 of 128 coalitions, 12 new.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 3 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 28 of 128 coalitions, 2 new.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Iteration 4 ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ Using 30 of 128 coalitions, 2 new.</span></span>
<span></span>
<span><span class="va">explanation_n_coal</span><span class="op">[[</span><span class="st">"asym_cau_gaussian_10"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"gaussian"</span>,</span>
<span>  phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>  asymmetric <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  causal_ordering <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">4</span><span class="op">:</span><span class="fl">7</span><span class="op">)</span>,</span>
<span>  confounding <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">FALSE</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  verbose <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"basic"</span>, <span class="st">"convergence"</span>, <span class="st">"shapley"</span><span class="op">)</span>,</span>
<span>  max_n_coalitions <span class="op">=</span> <span class="fl">10</span>, <span class="co"># Instead of 20</span></span>
<span>  iterative <span class="op">=</span> <span class="cn">FALSE</span> <span class="co"># Due to small number of coalitions</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Starting `shapr::explain()` at 2025-01-20 12:06:34 ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • Model class: &lt;xgb.Booster&gt;</span></span>
<span><span class="co">#&gt; • Approach: gaussian</span></span>
<span><span class="co">#&gt; • Iterative estimation: FALSE</span></span>
<span><span class="co">#&gt; • Number of feature-wise Shapley values: 7</span></span>
<span><span class="co">#&gt; • Number of observations to explain: 144</span></span>
<span><span class="co">#&gt; • Number of asymmetric coalitions: 20</span></span>
<span><span class="co">#&gt; • Causal ordering: {trend}, {cosyear, sinyear}, {temp, atemp, windspeed, hum}</span></span>
<span><span class="co">#&gt; • Components with confounding: {cosyear, sinyear}</span></span>
<span><span class="co">#&gt; • Computations (temporary) saved at: '/tmp/RtmpwfPA0n/shapr_obj_35d5107ec2774e.rds'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Main computation started ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ℹ Using 10 of 10 coalitions.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Convergence info</span></span>
<span><span class="co">#&gt; ✔ Converged after 10 coalitions:</span></span>
<span><span class="co">#&gt; Maximum number of iterations reached!</span></span>
<span><span class="co">#&gt; Maximum number of coalitions reached!</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Final estimated Shapley values (sd)</span></span>
<span><span class="co">#&gt;             none             trend            cosyear           sinyear              temp             atemp          windspeed                hum</span></span>
<span><span class="co">#&gt;           &lt;char&gt;            &lt;char&gt;             &lt;char&gt;            &lt;char&gt;            &lt;char&gt;            &lt;char&gt;             &lt;char&gt;             &lt;char&gt;</span></span>
<span><span class="co">#&gt;   1: 0.00 (0.00) -2141.72 (306.93) -1074.911 (243.25)  -16.056 (344.32) -114.709 (118.85)  -10.554 ( 54.94)    87.566 ( 77.64)   119.011 ( 71.28)</span></span>
<span><span class="co">#&gt;   2: 0.00 (0.00) -2161.44 (309.32) -1003.422 (228.27)  -34.133 (335.26)  -59.627 ( 98.51)   36.381 ( 22.13)    -0.503 ( 29.74)   203.429 ( 60.42)</span></span>
<span><span class="co">#&gt;   3: 0.00 (0.00) -2091.16 (296.32)  -883.448 (192.19)  -82.901 (300.93)  -85.515 ( 84.55)  -10.027 ( 47.05)   201.557 ( 76.71)  -118.762 ( 59.49)</span></span>
<span><span class="co">#&gt;   4: 0.00 (0.00) -2105.66 (296.82)  -803.626 (181.10) -106.765 (292.70)  133.988 (116.23)   30.362 ( 40.00)  -133.321 ( 50.53)  -202.532 ( 80.15)</span></span>
<span><span class="co">#&gt;   5: 0.00 (0.00) -2008.71 (277.57)  -796.969 (166.17) -146.958 (269.79)   39.890 ( 78.66)   16.046 ( 38.00)   164.981 ( 47.27)   -13.309 ( 49.32)</span></span>
<span><span class="co">#&gt;  ---                                                                                                                                             </span></span>
<span><span class="co">#&gt; 140: 0.00 (0.00)  1636.39 (296.83)  -865.837 (331.32)   57.316 (321.28)  489.037 (254.83)   90.281 (156.82)   372.930 (213.06)   -43.552 (207.80)</span></span>
<span><span class="co">#&gt; 141: 0.00 (0.00)  1603.01 (291.12) -1148.434 (358.00)  138.898 (363.48)   31.864 ( 95.62)   14.279 ( 22.12)   202.730 ( 48.92)  -123.344 ( 51.61)</span></span>
<span><span class="co">#&gt; 142: 0.00 (0.00)  1523.98 (301.19) -1231.968 (343.75)  -24.796 (355.40)   27.888 (106.78)  144.464 (  8.87)    71.813 ( 15.13)   187.236 ( 35.36)</span></span>
<span><span class="co">#&gt; 143: 0.00 (0.00)  1022.25 (249.73) -1863.900 (484.45)   -7.356 (451.24)   -7.586 (146.70)    0.738 ( 26.75)    18.547 ( 42.24)  -213.752 ( 55.95)</span></span>
<span><span class="co">#&gt; 144: 0.00 (0.00)   781.60 (264.74) -2821.680 (700.49)  -35.536 (643.39)  -93.366 (310.23) -105.770 ( 86.84)  -485.277 (177.12)   720.198 (220.32)</span></span>
<span></span>
<span><span class="co"># Look at the times</span></span>
<span><span class="va">explanation_n_coal</span><span class="op">[[</span><span class="st">"sym_cau_gaussian_all_128"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">explanation_sym_cau</span><span class="op">$</span><span class="va">gaussian</span></span>
<span><span class="va">explanation_n_coal</span><span class="op">[[</span><span class="st">"asym_cau_gaussian_all_20"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">explanation_asym_cau</span><span class="op">$</span><span class="va">gaussian</span></span>
<span><span class="va">explanation_n_coal</span> <span class="op">&lt;-</span> <span class="va">explanation_n_coal</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">2</span>, <span class="fl">4</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu">print_time</span><span class="op">(</span><span class="va">explanation_n_coal</span><span class="op">)</span></span>
<span><span class="co">#&gt;      sym_cau_gaussian_64 sym_cau_gaussian_all_128 asym_cau_gaussian_10 asym_cau_gaussian_all_20</span></span>
<span><span class="co">#&gt; [1,]              10.426                   30.038               1.9627                   4.1399</span></span></code></pre></div>
<p>We can then plot the beeswarm plots and the Shapley values for the
six selected explicands. We see that there are only minuscule
differences between the Shapley values we obtain when we use all the
coalitions and those we obtain when we use half of the valid
coalitions.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_beeswarms</span><span class="op">(</span><span class="va">explanation_n_coal</span>, title <span class="op">=</span> <span class="st">"Shapley values (gaussian) exact vs. approximation"</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_asymmetric_causal%2Fn_coalitions_plot_beeswarm-1.png"></p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_SV_several_approaches.html">plot_SV_several_approaches</a></span><span class="op">(</span><span class="va">explanation_n_coal</span>, <span class="va">index_x_explain</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_asymmetric_causal%2Fn_coalitions_plot_SV-1.png"></p>
</div>
<div class="section level3">
<h3 id="groups-of-features">Groups of features<a class="anchor" aria-label="anchor" href="#groups-of-features"></a>
</h3>
<p>In this section, we demonstrate that we can compute marginal,
asymmetric conditional, and symmetric/asymmetric Shapley values for
groups of features, too. For group Shapley values, we need to specify
the causal ordering on the group level and feature level. We demonstrate
with the <code>gaussian</code> approach, but other approaches are
applicable, too.</p>
<p>In the pairs plot above (and below), we see that it can be natural to
group the features <code>temp</code> and <code>atemp</code> due to their
(conceptual) similarity and high correlation.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">GGally</span><span class="fu">::</span><span class="fu"><a href="https://ggobi.github.io/ggally/reference/ggpairs.html" class="external-link">ggpairs</a></span><span class="op">(</span><span class="va">x_train</span><span class="op">[</span>, <span class="fl">4</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_asymmetric_causal%2Fgroup_cor-1.png"></p>
<p>We set up the groups and update the causal ordering to be on the
group level.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">group_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  trend <span class="op">=</span> <span class="st">"trend"</span>,</span>
<span>  cosyear <span class="op">=</span> <span class="st">"cosyear"</span>,</span>
<span>  sinyear <span class="op">=</span> <span class="st">"sinyear"</span>,</span>
<span>  temp_group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"temp"</span>, <span class="st">"atemp"</span><span class="op">)</span>,</span>
<span>  windspeed <span class="op">=</span> <span class="st">"windspeed"</span>,</span>
<span>  hum <span class="op">=</span> <span class="st">"hum"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">causal_ordering_group</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"trend"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cosyear"</span>, <span class="st">"sinyear"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"temp_group"</span>, <span class="st">"windspeed"</span>, <span class="st">"hum"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">confounding</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">FALSE</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>We can then compute the (group) Shapley values using the different
Shapley value frameworks.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">explanation_group_gaussian</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">explanation_group_gaussian</span><span class="op">[[</span><span class="st">"symmetric_marginal"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>    model <span class="op">=</span> <span class="va">model</span>,</span>
<span>    x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>    x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>    approach <span class="op">=</span> <span class="st">"gaussian"</span>,</span>
<span>    phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>    asymmetric <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    causal_ordering <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">group_list</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="co"># or `NULL`</span></span>
<span>    confounding <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    n_MC_samples <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>    group <span class="op">=</span> <span class="va">group_list</span>,</span>
<span>    iterative <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Success with message:</span></span>
<span><span class="co">#&gt; max_n_coalitions is NULL or larger than or 2^n_groups = 64, </span></span>
<span><span class="co">#&gt; and is therefore set to 2^n_groups = 64.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Starting `shapr::explain()` at 2025-01-20 12:06:39 ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • Model class: &lt;xgb.Booster&gt;</span></span>
<span><span class="co">#&gt; • Approach: gaussian</span></span>
<span><span class="co">#&gt; • Iterative estimation: FALSE</span></span>
<span><span class="co">#&gt; • Number of group-wise Shapley values: 6</span></span>
<span><span class="co">#&gt; • Number of observations to explain: 144</span></span>
<span><span class="co">#&gt; • Causal ordering: {trend, cosyear, sinyear, temp_group, windspeed, hum}</span></span>
<span><span class="co">#&gt; • Components with confounding: {trend, cosyear, sinyear, temp_group, windspeed, hum}</span></span>
<span><span class="co">#&gt; • Computations (temporary) saved at: '/tmp/RtmpwfPA0n/shapr_obj_35d5101164edf2.rds'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Main computation started ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ℹ Using 64 of 64 coalitions.</span></span>
<span></span>
<span><span class="va">explanation_group_gaussian</span><span class="op">[[</span><span class="st">"symmetric_conditional"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>    model <span class="op">=</span> <span class="va">model</span>,</span>
<span>    x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>    x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>    approach <span class="op">=</span> <span class="st">"gaussian"</span>,</span>
<span>    phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>    asymmetric <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    causal_ordering <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">group_list</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="co"># or `NULL`</span></span>
<span>    confounding <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    n_MC_samples <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>    group <span class="op">=</span> <span class="va">group_list</span>,</span>
<span>    iterative <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Success with message:</span></span>
<span><span class="co">#&gt; max_n_coalitions is NULL or larger than or 2^n_groups = 64, </span></span>
<span><span class="co">#&gt; and is therefore set to 2^n_groups = 64.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Starting `shapr::explain()` at 2025-01-20 12:06:47 ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • Model class: &lt;xgb.Booster&gt;</span></span>
<span><span class="co">#&gt; • Approach: gaussian</span></span>
<span><span class="co">#&gt; • Iterative estimation: FALSE</span></span>
<span><span class="co">#&gt; • Number of group-wise Shapley values: 6</span></span>
<span><span class="co">#&gt; • Number of observations to explain: 144</span></span>
<span><span class="co">#&gt; • Computations (temporary) saved at: '/tmp/RtmpwfPA0n/shapr_obj_35d5104bff40dd.rds'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Main computation started ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ℹ Using 64 of 64 coalitions.</span></span>
<span></span>
<span><span class="va">explanation_group_gaussian</span><span class="op">[[</span><span class="st">"asymmetric_conditional"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>    model <span class="op">=</span> <span class="va">model</span>,</span>
<span>    x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>    x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>    approach <span class="op">=</span> <span class="st">"gaussian"</span>,</span>
<span>    phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>    asymmetric <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    causal_ordering <span class="op">=</span> <span class="va">causal_ordering_group</span>,</span>
<span>    confounding <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    n_MC_samples <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>    group <span class="op">=</span> <span class="va">group_list</span>,</span>
<span>    iterative <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Success with message:</span></span>
<span><span class="co">#&gt; max_n_coalitions is NULL or larger than or number of coalitions respecting the causal</span></span>
<span><span class="co">#&gt; ordering 12, and is therefore set to 12.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Starting `shapr::explain()` at 2025-01-20 12:06:51 ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • Model class: &lt;xgb.Booster&gt;</span></span>
<span><span class="co">#&gt; • Approach: gaussian</span></span>
<span><span class="co">#&gt; • Iterative estimation: FALSE</span></span>
<span><span class="co">#&gt; • Number of group-wise Shapley values: 6</span></span>
<span><span class="co">#&gt; • Number of observations to explain: 144</span></span>
<span><span class="co">#&gt; • Number of asymmetric coalitions: 12</span></span>
<span><span class="co">#&gt; • Causal ordering: {trend}, {cosyear, sinyear}, {temp_group, windspeed, hum}</span></span>
<span><span class="co">#&gt; • Computations (temporary) saved at: '/tmp/RtmpwfPA0n/shapr_obj_35d51057cee1e6.rds'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Main computation started ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ℹ Using 12 of 12 coalitions.</span></span>
<span></span>
<span><span class="va">explanation_group_gaussian</span><span class="op">[[</span><span class="st">"symmetric_causal"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>    model <span class="op">=</span> <span class="va">model</span>,</span>
<span>    x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>    x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>    approach <span class="op">=</span> <span class="st">"gaussian"</span>,</span>
<span>    phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>    asymmetric <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    causal_ordering <span class="op">=</span> <span class="va">causal_ordering_group</span>,</span>
<span>    confounding <span class="op">=</span> <span class="va">confounding</span>,</span>
<span>    n_MC_samples <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>    group <span class="op">=</span> <span class="va">group_list</span>,</span>
<span>    iterative <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Success with message:</span></span>
<span><span class="co">#&gt; max_n_coalitions is NULL or larger than or 2^n_groups = 64, </span></span>
<span><span class="co">#&gt; and is therefore set to 2^n_groups = 64.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Starting `shapr::explain()` at 2025-01-20 12:06:52 ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • Model class: &lt;xgb.Booster&gt;</span></span>
<span><span class="co">#&gt; • Approach: gaussian</span></span>
<span><span class="co">#&gt; • Iterative estimation: FALSE</span></span>
<span><span class="co">#&gt; • Number of group-wise Shapley values: 6</span></span>
<span><span class="co">#&gt; • Number of observations to explain: 144</span></span>
<span><span class="co">#&gt; • Causal ordering: {trend}, {cosyear, sinyear}, {temp_group, windspeed, hum}</span></span>
<span><span class="co">#&gt; • Components with confounding: {cosyear, sinyear}</span></span>
<span><span class="co">#&gt; • Computations (temporary) saved at: '/tmp/RtmpwfPA0n/shapr_obj_35d510739d6a14.rds'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Main computation started ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ℹ Using 64 of 64 coalitions.</span></span>
<span></span>
<span><span class="va">explanation_group_gaussian</span><span class="op">[[</span><span class="st">"asymmetric_causal"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>    model <span class="op">=</span> <span class="va">model</span>,</span>
<span>    x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>    x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>    approach <span class="op">=</span> <span class="st">"gaussian"</span>,</span>
<span>    phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>    asymmetric <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    causal_ordering <span class="op">=</span> <span class="va">causal_ordering_group</span>,</span>
<span>    confounding <span class="op">=</span> <span class="va">confounding</span>,</span>
<span>    n_MC_samples <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>    group <span class="op">=</span> <span class="va">group_list</span>,</span>
<span>    iterative <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Success with message:</span></span>
<span><span class="co">#&gt; max_n_coalitions is NULL or larger than or number of coalitions respecting the causal</span></span>
<span><span class="co">#&gt; ordering 12, and is therefore set to 12.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Starting `shapr::explain()` at 2025-01-20 12:07:07 ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • Model class: &lt;xgb.Booster&gt;</span></span>
<span><span class="co">#&gt; • Approach: gaussian</span></span>
<span><span class="co">#&gt; • Iterative estimation: FALSE</span></span>
<span><span class="co">#&gt; • Number of group-wise Shapley values: 6</span></span>
<span><span class="co">#&gt; • Number of observations to explain: 144</span></span>
<span><span class="co">#&gt; • Number of asymmetric coalitions: 12</span></span>
<span><span class="co">#&gt; • Causal ordering: {trend}, {cosyear, sinyear}, {temp_group, windspeed, hum}</span></span>
<span><span class="co">#&gt; • Components with confounding: {cosyear, sinyear}</span></span>
<span><span class="co">#&gt; • Computations (temporary) saved at: '/tmp/RtmpwfPA0n/shapr_obj_35d51062dd26fb.rds'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Main computation started ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ℹ Using 12 of 12 coalitions.</span></span>
<span></span>
<span><span class="co"># Look at the elapsed times (symmetric takes the longest time)</span></span>
<span><span class="fu">print_time</span><span class="op">(</span><span class="va">explanation_group_gaussian</span><span class="op">)</span></span>
<span><span class="co">#&gt;      symmetric_marginal symmetric_conditional asymmetric_conditional symmetric_causal asymmetric_causal</span></span>
<span><span class="co">#&gt; [1,]             8.5457                3.9995                0.94695           14.273            1.5066</span></span></code></pre></div>
<p>We can then make the beeswarm plots and Shapley values plots for the
six selected explicands. For the beeswarm plots, we set
<code>include_group_feature_means = TRUE</code> to make the plots. This
means that the plot function use the mean of the <code>temp</code> and
<code>atemp</code> features as the feature value. This only makes sense
due to the high correlation between the two features.</p>
<p>The main difference between the feature-wise and group-wise Shapley
values is that we now see a much wider spread in the Shapley values for
<code>temp_group</code> than we did for <code>temp</code> and
<code>atemp</code>. For example, for the symmetric causal framework, we
saw above that the <code>temp</code> and <code>atemp</code> obtained
Shapley values between (around)
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>500</mn></mrow><annotation encoding="application/x-tex">-500</annotation></semantics></math>
to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>500</mn><annotation encoding="application/x-tex">500</annotation></semantics></math>,
while the grouped version <code>temp_group</code> obtains Shapley values
between
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>1000</mn></mrow><annotation encoding="application/x-tex">-1000</annotation></semantics></math>
to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1000</mn><annotation encoding="application/x-tex">1000</annotation></semantics></math></p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_beeswarms</span><span class="op">(</span><span class="va">explanation_group_gaussian</span>,</span>
<span>  title <span class="op">=</span> <span class="st">"Group Shapley values (gaussian)"</span>,</span>
<span>  include_group_feature_means <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_asymmetric_causal%2Fgroup_gaussian_plot_beeswarm-1.png"></p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_SV_several_approaches.html">plot_SV_several_approaches</a></span><span class="op">(</span><span class="va">explanation_group_gaussian</span>, <span class="va">index_x_explain</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Shapley value prediction explanation (gaussian)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_asymmetric_causal%2Fgroup_gaussian_plot_SV-1.png"></p>
<p><a id="Implementation_details"></a></p>
</div>
<div class="section level3">
<h3 id="implementation-details">Implementation details<a class="anchor" aria-label="anchor" href="#implementation-details"></a>
</h3>
<p>The <code>shapr</code> package is built to estimate conditional
Shapley values, thus, it parallelize over the coalitions. This makes
perfect sense for said framework as each batch of coalitions are
independent of other batches, which means that it is easy to
parallelize. Furthermore, by using many batches we drastically reduce
the memory usage as <code>shapr</code> does not need to store the Monte
Carlo samples for all coalitions.</p>
<p>This setup is not optimal for the causal Shapley value framework as
the chains of sampling steps for two coalition
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝒮</mi><annotation encoding="application/x-tex">\mathcal{S}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>𝒮</mi><mo>*</mo></msup><annotation encoding="application/x-tex">\mathcal{S}^*</annotation></semantics></math>
can contain many of the same steps. Ideally, each unique sampling step
should only be modeled once to save computation time, but, some of the
sampling steps will occur in many of the chains. Thus, we would then
have to store the Monte Carlo samples for all coalitions where this
sampling step is included, and we can therefor run into memory
consumption problems. Thus, in the current implementation, we treat each
coalition
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝒮</mi><annotation encoding="application/x-tex">\mathcal{S}</annotation></semantics></math>
independent and remodel the needed sampling steps for each
coalition.</p>
<p>Furthermore, in the conditional Shapley value framework, we have that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>𝒮</mi><mo accent="true">‾</mo></mover><mo>=</mo><mi>ℳ</mi><mo>∖</mo><mi>𝒮</mi></mrow><annotation encoding="application/x-tex">\bar{\mathcal{S}} = \mathcal{M} \backslash \mathcal{S}</annotation></semantics></math>,
thus <code>shapr</code> will by default generate Monte Carlo samples for
all features not in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝒮</mi><annotation encoding="application/x-tex">\mathcal{S}</annotation></semantics></math>.
For the causal Shapley value framework, this is not the case, i.e.,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>𝒮</mi><mo accent="true">‾</mo></mover><mo>≠</mo><mi>ℳ</mi><mo>∖</mo><mi>𝒮</mi></mrow><annotation encoding="application/x-tex">\bar{\mathcal{S}} \neq \mathcal{M} \backslash \mathcal{S}</annotation></semantics></math>
in general. To reuse the code, we generate Monte Carlo samples for all
features not in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝒮</mi><annotation encoding="application/x-tex">\mathcal{S}</annotation></semantics></math>,
but only keep the samples for the features in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>𝒮</mi><mo accent="true">‾</mo></mover><annotation encoding="application/x-tex">\bar{\mathcal{S}}</annotation></semantics></math>.
To speed up <code>shapr</code> further, one could rewrite all the
approaches to support that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>𝒮</mi><mo accent="true">‾</mo></mover><annotation encoding="application/x-tex">\bar{\mathcal{S}}</annotation></semantics></math>
is not the complement of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝒮</mi><annotation encoding="application/x-tex">\mathcal{S}</annotation></semantics></math>.</p>
<p>In the code below, we see the unique coalitions/set of features to
condition on to generate the Monte Carlo samples for all coalitions and
the number of times that set of conditional features is needed in the
symmetric causal Shapley value framework for the set up above. We see
that most of the conditional distributions will now be remodeled eights
times. For the <code>gaussian</code> approach, which is very fast to
estimate the conditional distributions, this does not have a major
impact on the time. However, for, e.g., the <code>ctree</code> approach
which is much slower, this will take a significant amount of extra time.
The <code>vaeac</code> approach trains only on these relevant
coalitions.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">S_causal_steps</span> <span class="op">&lt;-</span> <span class="va">explanation_sym_cau</span><span class="op">$</span><span class="va">gaussian</span><span class="op">$</span><span class="va">internal</span><span class="op">$</span><span class="va">iter_list</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">S_causal_steps</span></span>
<span><span class="va">S_causal_unlist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">c</span>, <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">S_causal_steps</span>, recursive <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">S_causal_steps_freq</span> <span class="op">&lt;-</span> <span class="va">S_causal_unlist</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"\\.S(?!bar)"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">S_causal_unlist</span><span class="op">)</span>, perl <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">S_causal_steps_freq</span> <span class="op">&lt;-</span> <span class="va">S_causal_steps_freq</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">S_causal_steps_freq</span>, <span class="va">is.null</span><span class="op">)</span><span class="op">]</span> <span class="co"># Remove NULLs</span></span>
<span><span class="va">S_causal_steps_freq</span> <span class="op">&lt;-</span> <span class="va">S_causal_steps_freq</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">S_causal_steps_freq</span>, <span class="va">length</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">]</span> <span class="co"># Remove extra integer(0)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">S_causal_steps_freq</span>, <span class="va">paste0</span>, collapse <span class="op">=</span> <span class="st">","</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           1       1,2,3     1,2,3,4   1,2,3,4,5 1,2,3,4,5,6 1,2,3,4,5,7   1,2,3,4,6 1,2,3,4,6,7   1,2,3,4,7     1,2,3,5   1,2,3,5,6 1,2,3,5,6,7   1,2,3,5,7 </span></span>
<span><span class="co">#&gt;          95           7           8           8           8           8           8           8           8           8           8           8           8 </span></span>
<span><span class="co">#&gt;     1,2,3,6   1,2,3,6,7     1,2,3,7 </span></span>
<span><span class="co">#&gt;           8           8           8</span></span></code></pre></div>
<p>The <code>independence</code>, <code>empirical</code>,
<code>ctree</code>, and <code>categorical</code> approaches produce
weighted Monte Carlo samples. That means that they do not necessarily
generate <code>n_MC_samples</code>. To ensure <code>n_MC_samples</code>,
we sample <code>n_MC_samples</code> samples using weighted sampling with
replacements where the weights are the weights returned by the
approaches.</p>
<p>The marginal Shapley value explanation framework can be extended to
support modeling the marginal distributions using the
<code>copula</code> and <code>vaeac</code> approaches as both of these
methods support unconditional sampling.</p>
</div>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-aas2019explaining" class="csl-entry">
Aas, Kjersti, Martin Jullum, and Anders Løland. 2021. <span>“Explaining
Individual Predictions When Features Are Dependent: More Accurate
Approximations to Shapley Values.”</span> <em><span>Artificial
Intelligence</span></em> 298.
</div>
<div id="ref-frye2020asymmetric" class="csl-entry">
Frye, Christopher, Colin Rowat, and Ilya Feige. 2020. <span>“Asymmetric
Shapley Values: Incorporating Causal Knowledge into Model-Agnostic
Explainability.”</span> <em>Advances in Neural Information Processing
Systems</em> 33: 1229–39.
</div>
<div id="ref-heskes2020causal" class="csl-entry">
Heskes, Tom, Evi Sijben, Ioan Gabriel Bucur, and Tom Claassen. 2020.
<span>“Causal Shapley Values: Exploiting Causal Knowledge to Explain
Individual Predictions of Complex Models.”</span> <em>Advances in Neural
Information Processing Systems</em> 33: 4778–89.
</div>
<div id="ref-lundberg2017unified" class="csl-entry">
Lundberg, Scott M, and Su-In Lee. 2017. <span>“A Unified Approach to
Interpreting Model Predictions.”</span> In <em>Advances in Neural
Information Processing Systems</em>, 4765–74.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Martin Jullum, Lars Henry Berge Olsen, Annabelle Redelmeier, Jon Lachmann, Nikolai Sellereite, Norsk Regnesentral.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
