<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>More details and advanced usage of the `vaeac` approach • shapr</title>
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="More details and advanced usage of the `vaeac` approach">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">shapr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.2.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-vignettes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Vignettes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-vignettes">
<li><a class="dropdown-item" href="../articles/general_usage.html">General usage of shapr</a></li>
    <li><a class="dropdown-item" href="../articles/vaeac.html">Advanced usage of the `vaeac` approach</a></li>
    <li><a class="dropdown-item" href="../articles/regression.html">The separate and surrogate regression approches</a></li>
    <li><a class="dropdown-item" href="../articles/asymmetric_causal.html">Asymmetric and Causal Shapley values</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Manual</a></li>
<li class="nav-item"><a class="nav-link" href="../shaprpy.html">Python</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/NorskRegnesentral/shapr/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>More details and advanced usage of the `vaeac` approach</h1>
                        <h4 data-toc-skip class="author">Lars Henry
Berge Olsen</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/NorskRegnesentral/shapr/blob/master/vignettes/vaeac.Rmd" class="external-link"><code>vignettes/vaeac.Rmd</code></a></small>
      <div class="d-none name"><code>vaeac.Rmd</code></div>
    </div>

    
    
<p><a id="intro"></a></p>
<p>In this vignette, we elaborate and illustrate the <code>vaeac</code>
approach in more depth than in the general usage. In the general usage,
only a few basic examples of using <code>vaeac</code> is included, while
we here showcase more advanced usage. See the overview above for what
topics that are covered in this vignette.</p>
<div class="section level2">
<h2 id="vaeac">vaeac<a class="anchor" aria-label="anchor" href="#vaeac"></a>
</h2>
<p>An approach that supports mixed features is the Variational
AutoEncoder with Arbitrary Conditioning (<span class="citation">Olsen et
al. (2022)</span>), abbreviated to <code>vaeac</code>. The
<code>vaeac</code> is an extension of the regular variational
autoencoder (<span class="citation">Kingma and Welling (2014)</span>),
but instead of giving a probabilistic representation of the distribution
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝐱</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">p(\boldsymbol{x})</annotation></semantics></math>
it gives a probabilistic representation of the conditional distribution
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>𝐱</mi><mover><mi>𝒮</mi><mo accent="true">‾</mo></mover></msub><mo>∣</mo><msub><mi>𝐱</mi><mi>𝒮</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">p(\boldsymbol{x}_{\bar{\mathcal{S}}} \mid \boldsymbol{x}_{\mathcal{S}})</annotation></semantics></math>,
for all possible feature subsets
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>𝒮</mi><mo>⊆</mo><mi>ℳ</mi></mrow><annotation encoding="application/x-tex">\mathcal{S}\subseteq\mathcal{M}</annotation></semantics></math>
simultaneously, where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ℳ</mi><annotation encoding="application/x-tex">\mathcal{M}</annotation></semantics></math>
is the set of all features. That is, only a single <code>vaeac</code>
model is needed to model all conditional distributions.</p>
<p>The <code>vaeac</code> consists of three neural networks: a <em>full
encoder</em>, a <em>masked encoder</em>, and a <em>decoder</em>. The
encoders map the full and masked/conditional input representations,
i.e.,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐱</mi><annotation encoding="application/x-tex">\boldsymbol{x}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝐱</mi><mi>𝒮</mi></msub><annotation encoding="application/x-tex">\boldsymbol{x}_{\mathcal{S}}</annotation></semantics></math>,
respectively, to latent probabilistic representations. Sampled instances
from this latent probabilistic representations are sent to the decoder,
which maps them back to the feature space and provides a samplable
probabilistic representation for the unconditioned features
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝐱</mi><mover><mi>𝒮</mi><mo accent="true">‾</mo></mover></msub><annotation encoding="application/x-tex">\boldsymbol{x}_{\bar{\mathcal{S}}}</annotation></semantics></math>.
The full encoder is only used during the training phase of the
<code>vaeac</code> model to guide the training process of the masked
encoder, as the former relies on the full input sample
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐱</mi><annotation encoding="application/x-tex">\boldsymbol{x}</annotation></semantics></math>,
which is not accessible in the deployment phase (when we generate the
Monte Carlo samples), as we only have access to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝐱</mi><mi>𝒮</mi></msub><annotation encoding="application/x-tex">\boldsymbol{x}_{\mathcal{S}}</annotation></semantics></math>.
The networks are trained by minimizing a variational lower bound, and
see Section 3 in <span class="citation">Olsen et al. (2022)</span> for
an in-depth introduction to the <code>vaeac</code> methodology. We use
the <code>vaeac</code> model at the epoch which obtains the lowest
validation IWAE score to generate the Monte Carlo samples used in the
Shapley value computations.</p>
<p>We fit the <code>vaeac</code> model using the <em>torch</em> package
in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="sans-serif">𝖱</mtext><annotation encoding="application/x-tex">\textsf{R}</annotation></semantics></math>
(<span class="citation">Falbel and Luraschi (2023)</span>). The main
parameters are the the number of layers in the networks
(<code>vaeac.depth</code>), the width of the layers
(<code>vaeac.width</code>), the number of dimensions in the latent space
(<code>vaeac.latent_dim</code>), the activation function between the
layers in the networks (<code>vaeac.activation_function</code>), the
learning rate in the ADAM optimizer (<code>vaeac.lr</code>), the number
of <code>vaeac</code> models to initiate to remedy poorly initiated
model parameter values (<code>vaeac.n_vaeacs_initialize</code>), and the
number of learning epochs (<code>vaeac.epochs</code>). Call
<code><a href="../reference/setup_approach.html">?shapr::setup_approach.vaeac</a></code> for a more detailed
description of the parameters.</p>
<p>There are additional extra parameters which can be set by including a
named list in the call to the <code><a href="../reference/explain.html">explain()</a></code> function. For
example, we can the change the batch size to 32 by including
<code>vaeac.extra_parameters = list(vaeac.batch_size = 32)</code> as a
parameter in the call the <code><a href="../reference/explain.html">explain()</a></code> function. See
<code><a href="../reference/vaeac_get_extra_para_default.html">?shapr::vaeac_get_extra_para_default</a></code> for a description of
the possible extra parameters to the <code>vaeac</code> approach. The
main parameters are directly entered to the <code><a href="../reference/explain.html">explain()</a></code>
function, while the extra parameters are included in a named list called
<code>vaeac.extra_parameters</code>.</p>
</div>
<div class="section level2">
<h2 id="code">Code Examples<a class="anchor" aria-label="anchor" href="#code"></a>
</h2>
<p>We now demonstrate the <code>vaeac</code> approach on several
different use cases. Note that this vignette runs on CPU, but all code
sections below can be run on GPU too. To enable GPU, we have to include
<code>vaeac.extra_parameters = list(vaeac.cuda = TRUE)</code> in the
calls to the <code><a href="../reference/explain.html">explain()</a></code> function.</p>
<div class="section level3">
<h3 id="basicexample">Basic Example<a class="anchor" aria-label="anchor" href="#basicexample"></a>
</h3>
<p>Here we go through how to use the <code>vaeac</code> approach on the
same data as in the general usage</p>
<p>First we load the shapr package</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://norskregnesentral.github.io/shapr/">shapr</a></span><span class="op">)</span></span></code></pre></div>
<p>First we set up the model we want to explain.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/dmlc/xgboost" class="external-link">xgboost</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; data.table 1.16.2 using 16 threads (see ?getDTthreads).  Latest news: r-datatable.com</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"airquality"</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html" class="external-link">complete.cases</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span><span class="va">x_var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Solar.R"</span>, <span class="st">"Wind"</span>, <span class="st">"Temp"</span>, <span class="st">"Month"</span><span class="op">)</span></span>
<span><span class="va">y_var</span> <span class="op">&lt;-</span> <span class="st">"Ozone"</span></span>
<span></span>
<span><span class="va">ind_x_explain</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">6</span></span>
<span><span class="va">x_train</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="op">-</span><span class="va">ind_x_explain</span>, <span class="va">..x_var</span><span class="op">]</span></span>
<span><span class="va">y_train</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="op">-</span><span class="va">ind_x_explain</span>, <span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">y_var</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">x_explain</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="va">ind_x_explain</span>, <span class="va">..x_var</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Fitting a basic xgboost model to the training data</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.train.html" class="external-link">xgboost</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">x_train</span><span class="op">)</span>,</span>
<span>  label <span class="op">=</span> <span class="va">y_train</span>,</span>
<span>  nround <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Specifying the phi_0, i.e. the expected prediction without any features</span></span>
<span><span class="va">phi0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">y_train</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="first-vaeac-example">First vaeac example<a class="anchor" aria-label="anchor" href="#first-vaeac-example"></a>
</h3>
<p>We are now going to explain predictions made by the model using the
<code>vaeac</code> approach.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_MC_samples</span> <span class="op">&lt;-</span> <span class="fl">25</span> <span class="co"># Low number of MC samples to make the vignette build faster</span></span>
<span><span class="va">vaeac.n_vaeacs_initialize</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="co"># Initialize several vaeacs to counteract bad initialization values</span></span>
<span><span class="va">vaeac.epochs</span> <span class="op">&lt;-</span> <span class="fl">4</span> <span class="co"># The number of training epochs</span></span>
<span></span>
<span><span class="va">explanation</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>  phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>  n_MC_samples <span class="op">=</span> <span class="va">n_MC_samples</span>,</span>
<span>  vaeac.epochs <span class="op">=</span> <span class="va">vaeac.epochs</span>,</span>
<span>  vaeac.n_vaeacs_initialize <span class="op">=</span> <span class="va">vaeac.n_vaeacs_initialize</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Success with message:</span></span>
<span><span class="co">#&gt; max_n_coalitions is NULL or larger than or 2^n_features = 16, </span></span>
<span><span class="co">#&gt; and is therefore set to 2^n_features = 16.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Starting `shapr::explain()` at 2024-11-21 19:59:59 ───────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • Model class: &lt;xgb.Booster&gt;</span></span>
<span><span class="co">#&gt; • Approach: vaeac</span></span>
<span><span class="co">#&gt; • Iterative estimation: FALSE</span></span>
<span><span class="co">#&gt; • Number of feature-wise Shapley values: 4</span></span>
<span><span class="co">#&gt; • Number of observations to explain: 6</span></span>
<span><span class="co">#&gt; • Computations (temporary) saved at: '/tmp/RtmpCcS4cy/shapr_obj_1b8c933afb44f.rds'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Main computation started ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ℹ Using 16 of 16 coalitions.</span></span></code></pre></div>
<p>We can look at the Shapley values.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Printing and ploting the Shapley values.</span></span>
<span><span class="co"># See ?shapr::explain for interpretation of the values.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">explanation</span><span class="op">$</span><span class="va">shapley_values_est</span><span class="op">)</span></span>
<span><span class="co">#&gt;    explain_id     none    Solar.R        Wind       Temp      Month</span></span>
<span><span class="co">#&gt;         &lt;int&gt;    &lt;num&gt;      &lt;num&gt;       &lt;num&gt;      &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:          1 43.08572  4.3582680  -0.4948663 -16.717263  0.5535165</span></span>
<span><span class="co">#&gt; 2:          2 43.08571 -2.0696785  -2.7666843 -17.375969 -1.8428742</span></span>
<span><span class="co">#&gt; 3:          3 43.08571  1.2425910  -5.0586505 -18.791919 -0.6818670</span></span>
<span><span class="co">#&gt; 4:          4 43.08571  5.2083437 -10.0374107  -8.480697 -1.2813575</span></span>
<span><span class="co">#&gt; 5:          5 43.08571  0.2212691  -3.0584692 -17.917710 -3.6207951</span></span>
<span><span class="co">#&gt; 6:          6 43.08572  4.2557578  -9.5851397 -18.712318  2.6201697</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">explanation</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac%2Ffirst-vaeac-plots-1.png"></p>
</div>
<div class="section level3">
<h3 id="pretrained_vaeac">Pre-trained vaeac<a class="anchor" aria-label="anchor" href="#pretrained_vaeac"></a>
</h3>
<p>If the user has a pre-trained <code>vaeac</code> model (from a
previous run), the user can send that to the <code><a href="../reference/explain.html">explain()</a></code>
function and <code>shapr</code> will skip the training of a new
<code>vaeac</code> model and rather use the provided <code>vaeac</code>
model. This is useful if we want to explain new predictions using the
same combinations/coalitions as previously, i.e., we have a new
<code>x_explain</code>. Note that the new <code>x_explain</code> must
have the same features as before.</p>
<p>The <code>vaeac</code> model is accessible via
<code>explanation$internal$parameters$vaeac</code>. Note that if we let
<code>'vS_detail' %in% verbose</code> in <code><a href="../reference/explain.html">explain()</a></code>, then
<code>shapr</code> will give a message that it loads a pretrained
<code>vaeac</code> model instead of training it from scratch.</p>
<p>In this example, we extract the trained <code>vaeac</code> model from
the previous example and send it to <code><a href="../reference/explain.html">explain()</a></code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Send the pre-trained vaeac model</span></span>
<span><span class="va">expl_pretrained_vaeac</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>  phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>  n_MC_samples <span class="op">=</span> <span class="va">n_MC_samples</span>,</span>
<span>  vaeac.extra_parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    vaeac.pretrained_vaeac_model <span class="op">=</span> <span class="va">explanation</span><span class="op">$</span><span class="va">internal</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">vaeac</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Success with message:</span></span>
<span><span class="co">#&gt; max_n_coalitions is NULL or larger than or 2^n_features = 16, </span></span>
<span><span class="co">#&gt; and is therefore set to 2^n_features = 16.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Starting `shapr::explain()` at 2024-11-21 20:00:10 ───────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • Model class: &lt;xgb.Booster&gt;</span></span>
<span><span class="co">#&gt; • Approach: vaeac</span></span>
<span><span class="co">#&gt; • Iterative estimation: FALSE</span></span>
<span><span class="co">#&gt; • Number of feature-wise Shapley values: 4</span></span>
<span><span class="co">#&gt; • Number of observations to explain: 6</span></span>
<span><span class="co">#&gt; • Computations (temporary) saved at: '/tmp/RtmpCcS4cy/shapr_obj_1b8c93a966a6.rds'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Main computation started ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ℹ Using 16 of 16 coalitions.</span></span>
<span></span>
<span><span class="co"># Check that this version provides the same Shapley values</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">explanation</span><span class="op">$</span><span class="va">shapley_values_est</span>, <span class="va">expl_pretrained_vaeac</span><span class="op">$</span><span class="va">shapley_values_est</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="pretrained_vaeac_path">Pre-trained vaeac (path)<a class="anchor" aria-label="anchor" href="#pretrained_vaeac_path"></a>
</h3>
<p>We can also just provide a path to the stored <code>vaeac</code>
model. This is beneficial if we have only stored the <code>vaeac</code>
model on the computer but not the whole <code>explanation</code> object.
The possible save paths are stored in
<code>explanation$internal$parameters$vaeac$model</code>. Note that if
we let <code>'vS_detail' %in% verbose</code> in <code><a href="../reference/explain.html">explain()</a></code>,
then <code>shapr</code> will give a message that it loads a pretrained
<code>vaeac</code> model instead of training it from scratch.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Call `explanation$internal$parameters$vaeac$model` to see possible vaeac models. We use `best` below.</span></span>
<span><span class="co"># send the pre-trained vaeac path</span></span>
<span><span class="va">expl_pretrained_vaeac_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>  phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>  n_MC_samples <span class="op">=</span> <span class="va">n_MC_samples</span>,</span>
<span>  vaeac.extra_parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    vaeac.pretrained_vaeac_model <span class="op">=</span> <span class="va">explanation</span><span class="op">$</span><span class="va">internal</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">vaeac</span><span class="op">$</span><span class="va">models</span><span class="op">$</span><span class="va">best</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Success with message:</span></span>
<span><span class="co">#&gt; max_n_coalitions is NULL or larger than or 2^n_features = 16, </span></span>
<span><span class="co">#&gt; and is therefore set to 2^n_features = 16.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Starting `shapr::explain()` at 2024-11-21 20:00:15 ───────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • Model class: &lt;xgb.Booster&gt;</span></span>
<span><span class="co">#&gt; • Approach: vaeac</span></span>
<span><span class="co">#&gt; • Iterative estimation: FALSE</span></span>
<span><span class="co">#&gt; • Number of feature-wise Shapley values: 4</span></span>
<span><span class="co">#&gt; • Number of observations to explain: 6</span></span>
<span><span class="co">#&gt; • Computations (temporary) saved at: '/tmp/RtmpCcS4cy/shapr_obj_1b8c93259a4780.rds'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Main computation started ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ℹ Using 16 of 16 coalitions.</span></span>
<span></span>
<span><span class="co"># Check that this version provides the same Shapley values</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">explanation</span><span class="op">$</span><span class="va">shapley_values_est</span>, <span class="va">expl_pretrained_vaeac_path</span><span class="op">$</span><span class="va">shapley_values_est</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="n_coalitions">Specified max_n_coalitions<a class="anchor" aria-label="anchor" href="#n_coalitions"></a>
</h3>
<p>In this section, we discuss a general <code>shapr</code> parameter in
the <code><a href="../reference/explain.html">explain()</a></code> function that is method independent, namely,
<code>max_n_coalitions</code>. The user can limit the Shapley value
computations to only a subset of coalitions by setting the
<code>max_n_coalitions</code> parameter to a value lower than
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mn>2</mn><msub><mi>n</mi><mtext mathvariant="normal">features</mtext></msub></msup><annotation encoding="application/x-tex">2^{n_\text{features}}</annotation></semantics></math>.</p>
<p>Note that we do not need to train a new <code>vaeac</code> model as
we can use the one above trained on all <code>16</code> coalitions as we
are now only using a subset of them. This is not applicable the other
way around.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># send the pre-trained vaeac path</span></span>
<span><span class="va">expl_batches_combinations</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>  phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>  max_n_coalitions <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  n_MC_samples <span class="op">=</span> <span class="va">n_MC_samples</span>,</span>
<span>  vaeac.extra_parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    vaeac.pretrained_vaeac_model <span class="op">=</span> <span class="va">explanation</span><span class="op">$</span><span class="va">internal</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">vaeac</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Starting `shapr::explain()` at 2024-11-21 20:00:19 ───────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • Model class: &lt;xgb.Booster&gt;</span></span>
<span><span class="co">#&gt; • Approach: vaeac</span></span>
<span><span class="co">#&gt; • Iterative estimation: FALSE</span></span>
<span><span class="co">#&gt; • Number of feature-wise Shapley values: 4</span></span>
<span><span class="co">#&gt; • Number of observations to explain: 6</span></span>
<span><span class="co">#&gt; • Computations (temporary) saved at: '/tmp/RtmpCcS4cy/shapr_obj_1b8c937a7cee44.rds'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Main computation started ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ℹ Using 10 of 16 coalitions.</span></span>
<span></span>
<span><span class="co"># Gives different Shapley values as the latter one are only based on a subset of coalitions</span></span>
<span><span class="fu"><a href="../reference/plot_SV_several_approaches.html">plot_SV_several_approaches</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Original"</span> <span class="op">=</span> <span class="va">explanation</span>, <span class="st">"Other combi."</span> <span class="op">=</span> <span class="va">expl_batches_combinations</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac%2Fcheck-n_coalitions-1.png"></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Can compare that to the situation where we have exact computations (i.e., include all coalitions)</span></span>
<span><span class="va">explanation</span><span class="op">$</span><span class="va">internal</span><span class="op">$</span><span class="va">objects</span><span class="op">$</span><span class="va">X</span></span>
<span><span class="co">#&gt;     id_coalition coalitions coalition_size     N shapley_weight sample_freq features approach</span></span>
<span><span class="co">#&gt;            &lt;int&gt;     &lt;list&gt;          &lt;int&gt; &lt;int&gt;          &lt;num&gt;      &lt;lgcl&gt;   &lt;list&gt;   &lt;char&gt;</span></span>
<span><span class="co">#&gt;  1:            1                         0     1       1.00e+06          NA             vaeac</span></span>
<span><span class="co">#&gt;  2:            2          1              1     4       2.50e-01          NA        1    vaeac</span></span>
<span><span class="co">#&gt;  3:            3          2              1     4       2.50e-01          NA        2    vaeac</span></span>
<span><span class="co">#&gt;  4:            4          3              1     4       2.50e-01          NA        3    vaeac</span></span>
<span><span class="co">#&gt;  5:            5          4              1     4       2.50e-01          NA        4    vaeac</span></span>
<span><span class="co">#&gt;  6:            6        1,2              2     6       1.25e-01          NA      1,2    vaeac</span></span>
<span><span class="co">#&gt;  7:            7        1,3              2     6       1.25e-01          NA      1,3    vaeac</span></span>
<span><span class="co">#&gt;  8:            8        1,4              2     6       1.25e-01          NA      1,4    vaeac</span></span>
<span><span class="co">#&gt;  9:            9        2,3              2     6       1.25e-01          NA      2,3    vaeac</span></span>
<span><span class="co">#&gt; 10:           10        2,4              2     6       1.25e-01          NA      2,4    vaeac</span></span>
<span><span class="co">#&gt; 11:           11        3,4              2     6       1.25e-01          NA      3,4    vaeac</span></span>
<span><span class="co">#&gt; 12:           12      1,2,3              3     4       2.50e-01          NA    1,2,3    vaeac</span></span>
<span><span class="co">#&gt; 13:           13      1,2,4              3     4       2.50e-01          NA    1,2,4    vaeac</span></span>
<span><span class="co">#&gt; 14:           14      1,3,4              3     4       2.50e-01          NA    1,3,4    vaeac</span></span>
<span><span class="co">#&gt; 15:           15      2,3,4              3     4       2.50e-01          NA    2,3,4    vaeac</span></span>
<span><span class="co">#&gt; 16:           16    1,2,3,4              4     1       1.00e+06          NA  1,2,3,4    vaeac</span></span></code></pre></div>
<p>Note that if we train a <code>vaeac</code> model from scratch with
the setup above, then the <code>vaeac</code> model will not use a
missing completely as random (MCAR) mask generator, but rather a mask
generator that ensures that the <code>vaeac</code> model is only trained
on the specified set of coalitions. In this case, it will be the set of
the sampled coalitions.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">expl_batches_combinations_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>  phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>  max_n_coalitions <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  n_MC_samples <span class="op">=</span> <span class="va">n_MC_samples</span>,</span>
<span>  vaeac.n_vaeacs_initialize <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  vaeac.epochs <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  verbose <span class="op">=</span> <span class="st">"vS_details"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Extra info about the pretrained vaeac model ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Training the `vaeac` model with the provided parameters from scratch on CPU.</span></span>
<span><span class="co">#&gt; Using 'specified_masks_mask_generator' with '10' coalitions.</span></span>
<span><span class="co">#&gt; The vaeac model contains 17032 trainable parameters.</span></span>
<span><span class="co">#&gt; Initializing vaeac model number 1 of 1.</span></span>
<span><span class="co">#&gt; Best vaeac inititalization was number 1 (of 1) with a training VLB = -6.489 after 2 epochs. Continue to</span></span>
<span><span class="co">#&gt; train this inititalization.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Results of the `vaeac` training process:</span></span>
<span><span class="co">#&gt; Best epoch:             3.   VLB = -4.736    IWAE = -3.231   IWAE_running = -3.482</span></span>
<span><span class="co">#&gt; Best running avg epoch: 3.   VLB = -4.736    IWAE = -3.231   IWAE_running = -3.482</span></span>
<span><span class="co">#&gt; Last epoch:             3.   VLB = -4.736    IWAE = -3.231   IWAE_running = -3.482</span></span>
<span><span class="co">#&gt; ℹ The trained `vaeac` models are saved to folder '/tmp/RtmpCcS4cy' at</span></span>
<span><span class="co">#&gt; '/tmp/RtmpCcS4cy/X2024.11.21.20.00.24.69317_n_features_4_n_train_105_depth_3_width_32_latent_8_lr_0.001_epoch_best.pt'</span></span>
<span><span class="co">#&gt; '/tmp/RtmpCcS4cy/X2024.11.21.20.00.24.69317_n_features_4_n_train_105_depth_3_width_32_latent_8_lr_0.001_epoch_best_running.pt'</span></span>
<span><span class="co">#&gt; '/tmp/RtmpCcS4cy/X2024.11.21.20.00.24.69317_n_features_4_n_train_105_depth_3_width_32_latent_8_lr_0.001_epoch_last.pt'</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="paired_sampling">Paired sampling<a class="anchor" aria-label="anchor" href="#paired_sampling"></a>
</h3>
<p>The <code>vaeac</code> approach can use paired sampling to improve
the stability of the vaeac training procedure. When using paired
sampling, each observation in the training batches will be duplicated,
but the first version will be masked by
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>S</mi><annotation encoding="application/x-tex">S</annotation></semantics></math>
and the second version will be masked by the complement
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>S</mi><mo accent="true">‾</mo></mover><annotation encoding="application/x-tex">\bar{S}</annotation></semantics></math>.
The mask are taken from the <code>explanation$internal$objects$S</code>
matrix. Note that <code>vaeac</code> does not check if the complement is
also in said matrix. This means that if the Shapley value explanations
are computed based on a subset of coalitions, then the
<code>vaeac</code> model might be trained on coalitions which are not
used when computing the Shapley values. This should not be considered as
redundant training as it increases the stability and performance of the
<code>vaeac</code> model as a whole, hence, we recommend to use paired
sampling (default). Furthermore, the masks are randomly selected for
each observation in the batch. The training time when using paired
sampling is higher in comparison to random sampling due to more complex
implementation.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">expl_paired_sampling_TRUE</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>  phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>  n_MC_samples <span class="op">=</span> <span class="va">n_MC_samples</span>,</span>
<span>  vaeac.epochs <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  vaeac.n_vaeacs_initialize <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  vaeac.extra_parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>vaeac.paired_sampling <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Success with message:</span></span>
<span><span class="co">#&gt; max_n_coalitions is NULL or larger than or 2^n_features = 16, </span></span>
<span><span class="co">#&gt; and is therefore set to 2^n_features = 16.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Starting `shapr::explain()` at 2024-11-21 20:00:32 ───────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • Model class: &lt;xgb.Booster&gt;</span></span>
<span><span class="co">#&gt; • Approach: vaeac</span></span>
<span><span class="co">#&gt; • Iterative estimation: FALSE</span></span>
<span><span class="co">#&gt; • Number of feature-wise Shapley values: 4</span></span>
<span><span class="co">#&gt; • Number of observations to explain: 6</span></span>
<span><span class="co">#&gt; • Computations (temporary) saved at: '/tmp/RtmpCcS4cy/shapr_obj_1b8c93194f586e.rds'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Main computation started ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ℹ Using 16 of 16 coalitions.</span></span>
<span></span>
<span><span class="va">expl_paired_sampling_FALSE</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>  phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>  n_MC_samples <span class="op">=</span> <span class="va">n_MC_samples</span>,</span>
<span>  vaeac.epochs <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  vaeac.n_vaeacs_initialize <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  vaeac.extra_parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>vaeac.paired_sampling <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Success with message:</span></span>
<span><span class="co">#&gt; max_n_coalitions is NULL or larger than or 2^n_features = 16, </span></span>
<span><span class="co">#&gt; and is therefore set to 2^n_features = 16.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Starting `shapr::explain()` at 2024-11-21 20:00:44 ───────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • Model class: &lt;xgb.Booster&gt;</span></span>
<span><span class="co">#&gt; • Approach: vaeac</span></span>
<span><span class="co">#&gt; • Iterative estimation: FALSE</span></span>
<span><span class="co">#&gt; • Number of feature-wise Shapley values: 4</span></span>
<span><span class="co">#&gt; • Number of observations to explain: 6</span></span>
<span><span class="co">#&gt; • Computations (temporary) saved at: '/tmp/RtmpCcS4cy/shapr_obj_1b8c937aee27ae.rds'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Main computation started ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ℹ Using 16 of 16 coalitions.</span></span></code></pre></div>
<p>We can compare the results by looking at the training and validation
errors and by the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>S</mi><msub><mi>E</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">MSE_v</annotation></semantics></math>
evaluation criterion. We do this by using the
<code><a href="../reference/plot_vaeac_eval_crit.html">plot_vaeac_eval_crit()</a></code> and
<code><a href="../reference/plot_MSEv_eval_crit.html">plot_MSEv_eval_crit()</a></code> functions in the <code>shapr</code>
package, respectively.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">explanation_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Regular samp."</span> <span class="op">=</span> <span class="va">expl_paired_sampling_FALSE</span>,</span>
<span>                         <span class="st">"Paired samp."</span> <span class="op">=</span> <span class="va">expl_paired_sampling_TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot_vaeac_eval_crit.html">plot_vaeac_eval_crit</a></span><span class="op">(</span><span class="va">explanation_list</span>, plot_type <span class="op">=</span> <span class="st">"criterion"</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac%2Fpaired-sampling-plotting-1.png"></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_MSEv_eval_crit.html">plot_MSEv_eval_crit</a></span><span class="op">(</span><span class="va">explanation_list</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac%2Fpaired-sampling-plotting-2.png"></p>
<p>By looking at the time, we see that the paired version takes (a bit)
longer time in the <code>setup_computation</code> phase, that is, in the
training phase.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="st">"Paired"</span> <span class="op">=</span> <span class="va">expl_paired_sampling_TRUE</span><span class="op">$</span><span class="va">timing</span><span class="op">$</span><span class="va">overall_timing_secs</span>,</span>
<span>  <span class="st">"Regular"</span> <span class="op">=</span> <span class="va">expl_paired_sampling_FALSE</span><span class="op">$</span><span class="va">timing</span><span class="op">$</span><span class="va">overall_timing_secs</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;            setup test_prediction main_computation finalize_explanation</span></span>
<span><span class="co">#&gt; Paired  0.049229        0.036201           12.333            0.0043070</span></span>
<span><span class="co">#&gt; Regular 0.047371        0.034762           10.895            0.0043063</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="progress_bar">Progressr<a class="anchor" aria-label="anchor" href="#progress_bar"></a>
</h3>
<p>As discussed in the general usage, the <code>shapr</code> package
provides two ways for receiving information about the progress of the
approach. First, the <code>shapr</code> package provides progress
updates of the computation of the Shapley values through the
<code>progressr</code> package. Second, the user can also get various
form of information through <code>verbose</code> in
<code><a href="../reference/explain.html">explain()</a></code>. By letting
<code>'vS_detail' %in% verbose</code>, we get extra information related
to the <code>vaeac</code> approach. The <code>verbose</code> parameter
works independently of the <code>progressr</code> package. Meaning that
the user can chose to use none, either, or both options simultaneously.
We give two examples here, and refer the reader to the general usage for
more detailed information.</p>
<p>By setting <code>c("basic", vS_details")</code>, we get both basic
messages about the explanation case, and messages about the estimation
of the <code>vaeac</code> approach.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">expl_with_messages</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>  phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>  n_MC_samples <span class="op">=</span> <span class="va">n_MC_samples</span>,</span>
<span>  verbose <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"basic"</span>,<span class="st">"vS_details"</span><span class="op">)</span>,</span>
<span>  vaeac.epochs <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  vaeac.n_vaeacs_initialize <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Success with message:</span></span>
<span><span class="co">#&gt; max_n_coalitions is NULL or larger than or 2^n_features = 16, </span></span>
<span><span class="co">#&gt; and is therefore set to 2^n_features = 16.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Starting `shapr::explain()` at 2024-11-21 20:00:58 ───────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • Model class: &lt;xgb.Booster&gt;</span></span>
<span><span class="co">#&gt; • Approach: vaeac</span></span>
<span><span class="co">#&gt; • Iterative estimation: FALSE</span></span>
<span><span class="co">#&gt; • Number of feature-wise Shapley values: 4</span></span>
<span><span class="co">#&gt; • Number of observations to explain: 6</span></span>
<span><span class="co">#&gt; • Computations (temporary) saved at: '/tmp/RtmpCcS4cy/shapr_obj_1b8c931bbb2f14.rds'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Main computation started ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ℹ Using 16 of 16 coalitions.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Extra info about the pretrained vaeac model ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Training the `vaeac` model with the provided parameters from scratch on CPU.</span></span>
<span><span class="co">#&gt; Using 'mcar_mask_generator' with 'masking_ratio = 0.5'.</span></span>
<span><span class="co">#&gt; The vaeac model contains 17032 trainable parameters.</span></span>
<span><span class="co">#&gt; Initializing vaeac model number 1 of 2.</span></span>
<span><span class="co">#&gt; Initializing vaeac model number 2 of 2.</span></span>
<span><span class="co">#&gt; Best vaeac inititalization was number 2 (of 2) with a training VLB = -4.566 after 2 epochs. Continue to</span></span>
<span><span class="co">#&gt; train this inititalization.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Results of the `vaeac` training process:</span></span>
<span><span class="co">#&gt; Best epoch:             5.   VLB = -3.318    IWAE = -3.049   IWAE_running = -3.149</span></span>
<span><span class="co">#&gt; Best running avg epoch: 5.   VLB = -3.318    IWAE = -3.049   IWAE_running = -3.149</span></span>
<span><span class="co">#&gt; Last epoch:             5.   VLB = -3.318    IWAE = -3.049   IWAE_running = -3.149</span></span>
<span><span class="co">#&gt; ℹ The trained `vaeac` models are saved to folder '/tmp/RtmpCcS4cy' at</span></span>
<span><span class="co">#&gt; '/tmp/RtmpCcS4cy/X2024.11.21.20.00.58.727562_n_features_4_n_train_105_depth_3_width_32_latent_8_lr_0.001_epoch_best.pt'</span></span>
<span><span class="co">#&gt; '/tmp/RtmpCcS4cy/X2024.11.21.20.00.58.727562_n_features_4_n_train_105_depth_3_width_32_latent_8_lr_0.001_epoch_best_running.pt'</span></span>
<span><span class="co">#&gt; '/tmp/RtmpCcS4cy/X2024.11.21.20.00.58.727562_n_features_4_n_train_105_depth_3_width_32_latent_8_lr_0.001_epoch_last.pt'</span></span></code></pre></div>
<p>For more visual information we can use the <code>progressr</code>
package. This can help us see detailed progress of the training step for
the final <code>vaeac</code> model. Note that by default
<code>vS_details</code> is not part of <code>verbose</code>, meaning
that we do not get any messages from the <code>vaeac</code>, approach
and only get the progress bars. See the general usage for examples for
how to change the progress bar.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="fu">library</span>(progressr)</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>progressr<span class="sc">::</span><span class="fu">handlers</span>(<span class="st">"cli"</span>) <span class="co"># Use `progressr::handlers("void")` to silence all `progressr` updates</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>progressr<span class="sc">::</span><span class="fu">with_progress</span>({</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>  expl_with_progressr <span class="ot">&lt;-</span> <span class="fu">explain</span>(</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>    <span class="at">model =</span> model,</span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>    <span class="at">x_explain =</span> x_explain,</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>    <span class="at">x_train =</span> x_train,</span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>    <span class="at">approach =</span> <span class="st">"vaeac"</span>,</span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a>    <span class="at">phi0 =</span> phi0,</span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>    <span class="at">n_MC_samples =</span> n_MC_samples,</span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="st">"vS_details"</span>,</span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a>    <span class="at">vaeac.epochs =</span> <span class="dv">5</span>,</span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a>    <span class="at">vaeac.n_vaeacs_initialize =</span> <span class="dv">2</span></span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a>  )</span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a>})</span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a><span class="co">#&gt; Success with message:</span></span>
<span id="cb15-19"><a href="#cb15-19" tabindex="-1"></a><span class="co">#&gt; max_n_coalitions is NULL or larger than or 2^n_features = 16, </span></span>
<span id="cb15-20"><a href="#cb15-20" tabindex="-1"></a><span class="co">#&gt; and is therefore set to 2^n_features = 16.</span></span>
<span id="cb15-21"><a href="#cb15-21" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-22"><a href="#cb15-22" tabindex="-1"></a><span class="co">#&gt; ── Extra info about the pretrained vaeac model ──</span></span>
<span id="cb15-23"><a href="#cb15-23" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-24"><a href="#cb15-24" tabindex="-1"></a><span class="co">#&gt; Training the `vaeac` model with the provided parameters from scratch on CPU.</span></span>
<span id="cb15-25"><a href="#cb15-25" tabindex="-1"></a><span class="co">#&gt; Using 'mcar_mask_generator' with 'masking_ratio = 0.5'.</span></span>
<span id="cb15-26"><a href="#cb15-26" tabindex="-1"></a><span class="co">#&gt; The vaeac model contains 17032 trainable parameters.</span></span>
<span id="cb15-27"><a href="#cb15-27" tabindex="-1"></a><span class="co">#&gt; Initializing vaeac model number 1 of 2.</span></span>
<span id="cb15-28"><a href="#cb15-28" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-29"><a href="#cb15-29" tabindex="-1"></a>                                                                                                          </span>
<span id="cb15-30"><a href="#cb15-30" tabindex="-1"></a>Initializing vaeac model number <span class="dv">2</span> of <span class="fl">2.</span></span>
<span id="cb15-31"><a href="#cb15-31" tabindex="-1"></a><span class="co">#&gt; ■■■■■■■■■■                        29% | Training vaeac (init. 1 of 2): Epoch: 2 | VLB: -6.593 | IWAE: -3…</span></span>
<span id="cb15-32"><a href="#cb15-32" tabindex="-1"></a></span>
<span id="cb15-33"><a href="#cb15-33" tabindex="-1"></a>                                                                                                          </span>
<span id="cb15-34"><a href="#cb15-34" tabindex="-1"></a>Best vaeac inititalization was number <span class="dv">2</span> (of <span class="dv">2</span>) with a training VLB <span class="ot">=</span> <span class="sc">-</span><span class="fl">4.566</span> after <span class="dv">2</span> epochs. Continue to</span>
<span id="cb15-35"><a href="#cb15-35" tabindex="-1"></a><span class="co">#&gt; train this inititalization.</span></span>
<span id="cb15-36"><a href="#cb15-36" tabindex="-1"></a><span class="co">#&gt; ■■■■■■■■■■■■■■■■■■                57% | Training vaeac (init. 2 of 2): Epoch: 2 | VLB: -4.566 | IWAE: -3…</span></span>
<span id="cb15-37"><a href="#cb15-37" tabindex="-1"></a><span class="co">#&gt; Results of the `vaeac` training process:</span></span>
<span id="cb15-38"><a href="#cb15-38" tabindex="-1"></a><span class="co">#&gt; Best epoch:             5.   VLB = -3.318    IWAE = -3.049   IWAE_running = -3.149</span></span>
<span id="cb15-39"><a href="#cb15-39" tabindex="-1"></a><span class="co">#&gt; Best running avg epoch: 5.   VLB = -3.318    IWAE = -3.049   IWAE_running = -3.149</span></span>
<span id="cb15-40"><a href="#cb15-40" tabindex="-1"></a><span class="co">#&gt; Last epoch:             5.   VLB = -3.318    IWAE = -3.049   IWAE_running = -3.149</span></span>
<span id="cb15-41"><a href="#cb15-41" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-42"><a href="#cb15-42" tabindex="-1"></a><span class="co">#&gt; ℹ The trained `vaeac` models are saved to folder '/tmp/RtmpCcS4cy' at</span></span>
<span id="cb15-43"><a href="#cb15-43" tabindex="-1"></a><span class="co">#&gt; '/tmp/RtmpCcS4cy/X2024.11.21.20.01.09.652795_n_features_4_n_train_105_depth_3_width_32_latent_8_lr_0.001_epoch_best.pt'</span></span>
<span id="cb15-44"><a href="#cb15-44" tabindex="-1"></a><span class="co">#&gt; '/tmp/RtmpCcS4cy/X2024.11.21.20.01.09.652795_n_features_4_n_train_105_depth_3_width_32_latent_8_lr_0.001_epoch_best_running.pt'</span></span>
<span id="cb15-45"><a href="#cb15-45" tabindex="-1"></a><span class="co">#&gt; '/tmp/RtmpCcS4cy/X2024.11.21.20.01.09.652795_n_features_4_n_train_105_depth_3_width_32_latent_8_lr_0.001_epoch_last.pt'</span></span>
<span id="cb15-46"><a href="#cb15-46" tabindex="-1"></a><span class="fu">all.equal</span>(expl_with_messages<span class="sc">$</span>shapley_values_est, expl_with_progressr<span class="sc">$</span>shapley_values_est)</span>
<span id="cb15-47"><a href="#cb15-47" tabindex="-1"></a><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="continue_training">Continue the training of the vaeac approach<a class="anchor" aria-label="anchor" href="#continue_training"></a>
</h3>
<p>In the case the user has set a too low number of training epochs and
sees that the network is still learning, then the user can continue to
train the network from where it stopped. Thus, a good workflow can
therefore be to call the <code><a href="../reference/explain.html">explain()</a></code> function with a
<code>n_MC_samples = 1</code> (to not waste to much time to generate MC
samples), then look at the training and evaluation plots of the
<code>vaeac</code>. If not satisfied, then train more. If satisfied,
then call the <code><a href="../reference/explain.html">explain()</a></code> function again but this time by
using the extra parameter <code>vaeac.pretrained_vaeac_model</code>, as
illustrated above. Note that we have set the number of
<code>vaeac.epochs</code> to be very low in this example and we
recommend to use many more epochs.</p>
<p>We can compare the results by looking at the training and validation
errors and by the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>S</mi><msub><mi>E</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">MSE_v</annotation></semantics></math>
evaluation criterion. We do this by using the
<code><a href="../reference/plot_vaeac_eval_crit.html">plot_vaeac_eval_crit()</a></code> and
<code><a href="../reference/plot_MSEv_eval_crit.html">plot_MSEv_eval_crit()</a></code> functions in the <code>shapr</code>
package, respectively. We also use the
<code><a href="../reference/plot_vaeac_imputed_ggpairs.html">plot_vaeac_imputed_ggpairs()</a></code> function which generates
samples from
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">p(x)</annotation></semantics></math>,
this is meant as a sanity check to see that the <code>vaeac</code> model
is able to follow the general structure/distribution of the data.
However, recall that the <code>vaeac</code> model is never trained on
the empty coalition, so the produced samples should be taken with a
grain of salt.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">expl_little_training</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>  phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>  n_MC_samples <span class="op">=</span> <span class="fl">250</span>,</span>
<span>  vaeac.epochs <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  vaeac.n_vaeacs_initialize <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Look at the training and validation errors. Not happy and want to train more.</span></span>
<span><span class="fu"><a href="../reference/plot_vaeac_eval_crit.html">plot_vaeac_eval_crit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Original"</span> <span class="op">=</span> <span class="va">expl_little_training</span><span class="op">)</span>, plot_type <span class="op">=</span> <span class="st">"method"</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac%2Fcontinue-training-1.png"></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Can also see how well vaeac generates data from the full joint distribution. Quite good.</span></span>
<span><span class="fu"><a href="../reference/plot_vaeac_imputed_ggpairs.html">plot_vaeac_imputed_ggpairs</a></span><span class="op">(</span></span>
<span>  explanation <span class="op">=</span> <span class="va">expl_little_training</span>,</span>
<span>  which_vaeac_model <span class="op">=</span> <span class="st">"best"</span>,</span>
<span>  x_true <span class="op">=</span> <span class="va">x_train</span></span>
<span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac%2Fcontinue-training-2.png"></p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Make a copy of the explanation object and continue to train the vaeac model some more epochs</span></span>
<span><span class="va">expl_train_more</span> <span class="op">&lt;-</span> <span class="va">expl_little_training</span></span>
<span><span class="va">expl_train_more</span><span class="op">$</span><span class="va">internal</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">vaeac</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/vaeac_train_model_continue.html">vaeac_train_model_continue</a></span><span class="op">(</span></span>
<span>    explanation <span class="op">=</span> <span class="va">expl_train_more</span>,</span>
<span>    epochs_new <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    x_train <span class="op">=</span> <span class="va">x_train</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute the Shapley values again but this time using the extra trained vaeac model</span></span>
<span><span class="va">expl_train_more_vaeac</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>  phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>  n_MC_samples <span class="op">=</span> <span class="fl">250</span>,</span>
<span>  vaeac.extra_parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    vaeac.pretrained_vaeac_model <span class="op">=</span> <span class="va">expl_train_more</span><span class="op">$</span><span class="va">internal</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">vaeac</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Look at the training and validation errors and conclude that we want to train some more</span></span>
<span><span class="fu"><a href="../reference/plot_vaeac_eval_crit.html">plot_vaeac_eval_crit</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Original"</span> <span class="op">=</span> <span class="va">expl_little_training</span>, <span class="st">"More epochs"</span> <span class="op">=</span> <span class="va">expl_train_more</span><span class="op">)</span>,</span>
<span>  plot_type <span class="op">=</span> <span class="st">"method"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac%2Fcontinue-training-3.png"></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Continue to train the vaeac model some more epochs</span></span>
<span><span class="va">expl_train_even_more</span> <span class="op">&lt;-</span> <span class="va">expl_train_more</span></span>
<span><span class="va">expl_train_even_more</span><span class="op">$</span><span class="va">internal</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">vaeac</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/vaeac_train_model_continue.html">vaeac_train_model_continue</a></span><span class="op">(</span></span>
<span>    explanation <span class="op">=</span> <span class="va">expl_train_even_more</span>,</span>
<span>    epochs_new <span class="op">=</span> <span class="fl">10</span>,</span>
<span>    x_train <span class="op">=</span> <span class="va">x_train</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute the Shapley values again but this time using the even more trained vaeac model</span></span>
<span><span class="va">expl_train_even_more_vaeac</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>  phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>  n_MC_samples <span class="op">=</span> <span class="fl">250</span>,</span>
<span>  vaeac.extra_parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    vaeac.pretrained_vaeac_model <span class="op">=</span> <span class="va">expl_train_even_more</span><span class="op">$</span><span class="va">internal</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">vaeac</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Look at the training and validation errors.</span></span>
<span><span class="fu"><a href="../reference/plot_vaeac_eval_crit.html">plot_vaeac_eval_crit</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"Original"</span> <span class="op">=</span> <span class="va">expl_little_training</span>,</span>
<span>    <span class="st">"More epochs"</span> <span class="op">=</span> <span class="va">expl_train_more</span>,</span>
<span>    <span class="st">"Even more epochs"</span> <span class="op">=</span> <span class="va">expl_train_even_more</span></span>
<span>  <span class="op">)</span>,</span>
<span>  plot_type <span class="op">=</span> <span class="st">"method"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac%2Fcontinue-training-4.png"></p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Can also see how well vaeac generates data from the full joint distribution</span></span>
<span><span class="fu"><a href="../reference/plot_vaeac_imputed_ggpairs.html">plot_vaeac_imputed_ggpairs</a></span><span class="op">(</span></span>
<span>  explanation <span class="op">=</span> <span class="va">expl_train_even_more</span>,</span>
<span>  which_vaeac_model <span class="op">=</span> <span class="st">"best"</span>,</span>
<span>  x_true <span class="op">=</span> <span class="va">x_train</span></span>
<span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac%2Fcontinue-training-5.png"></p>
<p>We can see that the extra training has decreased the MSEv score. The
Shapley value explanations have also changed, but they are often
comparable.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_MSEv_eval_crit.html">plot_MSEv_eval_crit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"Few epochs"</span> <span class="op">=</span> <span class="va">expl_little_training</span>,</span>
<span>  <span class="st">"More epochs"</span> <span class="op">=</span> <span class="va">expl_train_more_vaeac</span>,</span>
<span>  <span class="st">"Even more epochs"</span> <span class="op">=</span> <span class="va">expl_train_even_more_vaeac</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac%2Fcontinue-training-2-1.png"></p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># We see that the Shapley values have changed, but they are often comparable</span></span>
<span><span class="fu"><a href="../reference/plot_SV_several_approaches.html">plot_SV_several_approaches</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"Few epochs"</span> <span class="op">=</span> <span class="va">expl_little_training</span>,</span>
<span>  <span class="st">"More epochs"</span> <span class="op">=</span> <span class="va">expl_train_more_vaeac</span>,</span>
<span>  <span class="st">"Even more epochs"</span> <span class="op">=</span> <span class="va">expl_train_even_more_vaeac</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac%2Fcontinue-training-2-2.png"></p>
</div>
<div class="section level3">
<h3 id="early_stopping">Vaeac with early stopping<a class="anchor" aria-label="anchor" href="#early_stopping"></a>
</h3>
<p>If we do not want to specify the number of <code>epochs</code>, as we
are uncertain how many <code>epochs</code> it will take before the
<code>vaeac</code> model is properly trained, a good choice is to rather
use early stopping. This means that we can set <code>vaeac.epochs</code>
to a large number and let <code>vaeac.epochs_early_stopping</code> be
for example <code>5</code>. This means that the <code>vaeac</code> model
will stop the training procedure if there has been no improvement in the
validation score for <code>5</code> epochs.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Low value for `vaeac.epochs_early_stopping` here to build the vignette faster</span></span>
<span><span class="va">expl_early_stopping</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>  phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>  n_MC_samples <span class="op">=</span> <span class="fl">250</span>,</span>
<span>  verbose <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"basic"</span>,<span class="st">"vS_details"</span><span class="op">)</span>,</span>
<span>  vaeac.epochs <span class="op">=</span> <span class="fl">1000</span>, <span class="co"># Set it to a big number</span></span>
<span>  vaeac.n_vaeacs_initialize <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  vaeac.extra_parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>vaeac.epochs_early_stopping <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Success with message:</span></span>
<span><span class="co">#&gt; max_n_coalitions is NULL or larger than or 2^n_features = 16, </span></span>
<span><span class="co">#&gt; and is therefore set to 2^n_features = 16.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Starting `shapr::explain()` at 2024-11-21 20:03:10 ───────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • Model class: &lt;xgb.Booster&gt;</span></span>
<span><span class="co">#&gt; • Approach: vaeac</span></span>
<span><span class="co">#&gt; • Iterative estimation: FALSE</span></span>
<span><span class="co">#&gt; • Number of feature-wise Shapley values: 4</span></span>
<span><span class="co">#&gt; • Number of observations to explain: 6</span></span>
<span><span class="co">#&gt; • Computations (temporary) saved at: '/tmp/RtmpCcS4cy/shapr_obj_1b8c93198eb87f.rds'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Main computation started ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ℹ Using 16 of 16 coalitions.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Extra info about the pretrained vaeac model ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Training the `vaeac` model with the provided parameters from scratch on CPU.</span></span>
<span><span class="co">#&gt; Using 'mcar_mask_generator' with 'masking_ratio = 0.5'.</span></span>
<span><span class="co">#&gt; The vaeac model contains 17032 trainable parameters.</span></span>
<span><span class="co">#&gt; Initializing vaeac model number 1 of 2.</span></span>
<span><span class="co">#&gt; Initializing vaeac model number 2 of 2.</span></span>
<span><span class="co">#&gt; Best vaeac inititalization was number 2 (of 2) with a training VLB = -4.566 after 2 epochs. Continue to</span></span>
<span><span class="co">#&gt; train this inititalization.</span></span>
<span><span class="co">#&gt; No IWAE improvment in 2 epochs. Apply early stopping at epoch 14.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Results of the `vaeac` training process:</span></span>
<span><span class="co">#&gt; Best epoch:             12.  VLB = -2.958    IWAE = -2.930   IWAE_running = -2.991</span></span>
<span><span class="co">#&gt; Best running avg epoch: 12.  VLB = -2.958    IWAE = -2.930   IWAE_running = -2.991</span></span>
<span><span class="co">#&gt; Last epoch:             14.  VLB = -2.971    IWAE = -2.955   IWAE_running = -2.996</span></span>
<span><span class="co">#&gt; ℹ The trained `vaeac` models are saved to folder '/tmp/RtmpCcS4cy' at</span></span>
<span><span class="co">#&gt; '/tmp/RtmpCcS4cy/X2024.11.21.20.03.10.227966_n_features_4_n_train_105_depth_3_width_32_latent_8_lr_0.001_epoch_best.pt'</span></span>
<span><span class="co">#&gt; '/tmp/RtmpCcS4cy/X2024.11.21.20.03.10.227966_n_features_4_n_train_105_depth_3_width_32_latent_8_lr_0.001_epoch_best_running.pt'</span></span>
<span><span class="co">#&gt; '/tmp/RtmpCcS4cy/X2024.11.21.20.03.10.227966_n_features_4_n_train_105_depth_3_width_32_latent_8_lr_0.001_epoch_last.pt'</span></span>
<span></span>
<span><span class="co"># Look at the training and validation errors. We are quite happy with it.</span></span>
<span><span class="fu"><a href="../reference/plot_vaeac_eval_crit.html">plot_vaeac_eval_crit</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Vaeac early stopping"</span> <span class="op">=</span> <span class="va">expl_early_stopping</span><span class="op">)</span>,</span>
<span>  plot_type <span class="op">=</span> <span class="st">"method"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac%2Fearly-stopping-1-1.png"></p>
<p>However, we can train it further for a fixed amount of epochs if
desired. This can be in a setting where we are not happy with the IWAE
curve or we feel that we set <code>vaeac.epochs_early_stopping</code> to
a too low value or if the max number of epochs
(<code>vaeac.epochs</code>) were reached.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Make a copy of the explanation object which we are to train further.</span></span>
<span><span class="va">expl_early_stopping_train_more</span> <span class="op">&lt;-</span> <span class="va">expl_early_stopping</span></span>
<span></span>
<span><span class="co"># Continue to train the vaeac model some more epochs</span></span>
<span><span class="va">expl_early_stopping_train_more</span><span class="op">$</span><span class="va">internal</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">vaeac</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/vaeac_train_model_continue.html">vaeac_train_model_continue</a></span><span class="op">(</span></span>
<span>    explanation <span class="op">=</span> <span class="va">expl_early_stopping_train_more</span>,</span>
<span>    epochs_new <span class="op">=</span> <span class="fl">15</span>,</span>
<span>    x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">NULL</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Can even do it twice if desired</span></span>
<span><span class="va">expl_early_stopping_train_more</span><span class="op">$</span><span class="va">internal</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">vaeac</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/vaeac_train_model_continue.html">vaeac_train_model_continue</a></span><span class="op">(</span></span>
<span>    explanation <span class="op">=</span> <span class="va">expl_early_stopping_train_more</span>,</span>
<span>    epochs_new <span class="op">=</span> <span class="fl">10</span>,</span>
<span>    x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">NULL</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Look at the training and validation errors. We see some improvement</span></span>
<span><span class="fu"><a href="../reference/plot_vaeac_eval_crit.html">plot_vaeac_eval_crit</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"Vaeac early stopping"</span> <span class="op">=</span> <span class="va">expl_early_stopping</span>,</span>
<span>    <span class="st">"Vaeac early stopping more epochs"</span> <span class="op">=</span> <span class="va">expl_early_stopping_train_more</span></span>
<span>  <span class="op">)</span>,</span>
<span>  plot_type <span class="op">=</span> <span class="st">"method"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac%2Fearly-stopping-2-1.png"></p>
<p>We can then use the extra trained version to compute the Shapley
value explanations and compare it with the previous version that used
early stopping. We see a non-significant difference.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Use extra trained vaeac model to compute Shapley values again.</span></span>
<span><span class="va">expl_early_stopping_train_more</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>  phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>  n_MC_samples <span class="op">=</span> <span class="fl">250</span>,</span>
<span>  vaeac.extra_parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    vaeac.pretrained_vaeac_model <span class="op">=</span> <span class="va">expl_early_stopping_train_more</span><span class="op">$</span><span class="va">internal</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">vaeac</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Success with message:</span></span>
<span><span class="co">#&gt; max_n_coalitions is NULL or larger than or 2^n_features = 16, </span></span>
<span><span class="co">#&gt; and is therefore set to 2^n_features = 16.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Starting `shapr::explain()` at 2024-11-21 20:04:15 ───────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • Model class: &lt;xgb.Booster&gt;</span></span>
<span><span class="co">#&gt; • Approach: vaeac</span></span>
<span><span class="co">#&gt; • Iterative estimation: FALSE</span></span>
<span><span class="co">#&gt; • Number of feature-wise Shapley values: 4</span></span>
<span><span class="co">#&gt; • Number of observations to explain: 6</span></span>
<span><span class="co">#&gt; • Computations (temporary) saved at: '/tmp/RtmpCcS4cy/shapr_obj_1b8c9341ad4ace.rds'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Main computation started ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ℹ Using 16 of 16 coalitions.</span></span>
<span></span>
<span><span class="co"># We can compare their MSEv scores</span></span>
<span><span class="fu"><a href="../reference/plot_MSEv_eval_crit.html">plot_MSEv_eval_crit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"Vaeac early stopping"</span> <span class="op">=</span> <span class="va">expl_early_stopping</span>,</span>
<span>  <span class="st">"Vaeac early stopping more epochs"</span> <span class="op">=</span> <span class="va">expl_early_stopping_train_more</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac%2Fearly-stopping-3-1.png"></p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># We see that the Shapley values have changed, but only slightly</span></span>
<span><span class="fu"><a href="../reference/plot_SV_several_approaches.html">plot_SV_several_approaches</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"Vaeac early stopping"</span> <span class="op">=</span> <span class="va">expl_early_stopping</span>,</span>
<span>  <span class="st">"Vaeac early stopping more epochs"</span> <span class="op">=</span> <span class="va">expl_early_stopping_train_more</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac%2Fearly-stopping-3-2.png"></p>
</div>
<div class="section level3">
<h3 id="grouping_of_features">Grouping of features<a class="anchor" aria-label="anchor" href="#grouping_of_features"></a>
</h3>
<p>When we train a <code>vaeac</code> model to explain groups of
features, then the <code>vaeac</code> model will use the
“Specified_masks_mask_generator” which ensures that the
<code>vaeac</code> model only train on a specified set of coalitions. In
this case, it will ensure that all features in group A will always
either be conditioned on or be unconditioned. The same goes for group B.
Note that in this setup, there are only <code>4</code> possible
coalitions, but <code>vaeac</code> only train on <code>2</code>
coalitions as the empty and grand coalitions as they are not needed in
the Shapley value computations.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">expl_group</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>  phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>  group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>A <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Temp"</span>, <span class="st">"Month"</span><span class="op">)</span>, B <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Wind"</span>, <span class="st">"Solar.R"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  n_MC_samples <span class="op">=</span> <span class="va">n_MC_samples</span>,</span>
<span>  verbose <span class="op">=</span> <span class="st">"vS_details"</span>,</span>
<span>  vaeac.epochs <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  vaeac.n_vaeacs_initialize <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Success with message:</span></span>
<span><span class="co">#&gt; max_n_coalitions is NULL or larger than or 2^n_groups = 4, </span></span>
<span><span class="co">#&gt; and is therefore set to 2^n_groups = 4.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Extra info about the pretrained vaeac model ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Training the `vaeac` model with the provided parameters from scratch on CPU.</span></span>
<span><span class="co">#&gt; Using 'specified_masks_mask_generator' with '4' coalitions.</span></span>
<span><span class="co">#&gt; The vaeac model contains 17032 trainable parameters.</span></span>
<span><span class="co">#&gt; Initializing vaeac model number 1 of 2.</span></span>
<span><span class="co">#&gt; Initializing vaeac model number 2 of 2.</span></span>
<span><span class="co">#&gt; Best vaeac inititalization was number 2 (of 2) with a training VLB = -4.453 after 2 epochs. Continue to</span></span>
<span><span class="co">#&gt; train this inititalization.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Results of the `vaeac` training process:</span></span>
<span><span class="co">#&gt; Best epoch:             4.   VLB = -3.514    IWAE = -3.114   IWAE_running = -3.153</span></span>
<span><span class="co">#&gt; Best running avg epoch: 4.   VLB = -3.514    IWAE = -3.114   IWAE_running = -3.153</span></span>
<span><span class="co">#&gt; Last epoch:             4.   VLB = -3.514    IWAE = -3.114   IWAE_running = -3.153</span></span>
<span><span class="co">#&gt; ℹ The trained `vaeac` models are saved to folder '/tmp/RtmpCcS4cy' at</span></span>
<span><span class="co">#&gt; '/tmp/RtmpCcS4cy/X2024.11.21.20.04.45.408325_n_features_4_n_train_105_depth_3_width_32_latent_8_lr_0.001_epoch_best.pt'</span></span>
<span><span class="co">#&gt; '/tmp/RtmpCcS4cy/X2024.11.21.20.04.45.408325_n_features_4_n_train_105_depth_3_width_32_latent_8_lr_0.001_epoch_best_running.pt'</span></span>
<span><span class="co">#&gt; '/tmp/RtmpCcS4cy/X2024.11.21.20.04.45.408325_n_features_4_n_train_105_depth_3_width_32_latent_8_lr_0.001_epoch_last.pt'</span></span>
<span></span>
<span><span class="co"># Plot the resulting explanations</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">expl_group</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac%2Fvaeac-grouping-of-features-1.png"></p>
</div>
<div class="section level3">
<h3 id="mixed_data">Mixed Data<a class="anchor" aria-label="anchor" href="#mixed_data"></a>
</h3>
<p>Here we look at a setup with mixed data, i.e., the data contains both
categorical and continuous features. First we set up the data and the
model.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://imbs-hl.github.io/ranger/" class="external-link">ranger</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; ranger 0.17.0 using 2 threads (default). Change with num.threads in ranger() and predict(), options(Ncpus = N), options(ranger.num.threads = N) or environment variable R_RANGER_NUM_THREADS.</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html" class="external-link">complete.cases</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co"># convert the month variable to a factor</span></span>
<span><span class="va">data</span><span class="op">[</span>, <span class="va">Month_factor</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">Month</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">x_var_cat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Solar.R"</span>, <span class="st">"Wind"</span>, <span class="st">"Temp"</span>, <span class="st">"Month_factor"</span><span class="op">)</span></span>
<span><span class="va">y_var</span> <span class="op">&lt;-</span> <span class="st">"Ozone"</span></span>
<span></span>
<span><span class="va">ind_x_explain</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">6</span></span>
<span></span>
<span><span class="va">data_train_cat</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="op">-</span><span class="va">ind_x_explain</span>, <span class="op">]</span></span>
<span><span class="va">x_train_cat</span> <span class="op">&lt;-</span> <span class="va">data_train_cat</span><span class="op">[</span>, <span class="va">..x_var_cat</span><span class="op">]</span></span>
<span><span class="va">x_explain_cat</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="va">ind_x_explain</span>, <span class="op">]</span><span class="op">[</span>, <span class="va">..x_var_cat</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Fit a random forest model to the training data</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://imbs-hl.github.io/ranger/reference/ranger.html" class="external-link">ranger</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">y_var</span>, <span class="st">" ~ "</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">x_var_cat</span>, collapse <span class="op">=</span> <span class="st">" + "</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">data_train_cat</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Specifying the phi_0, i.e. the expected prediction without any features</span></span>
<span><span class="va">phi0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">data_train_cat</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">y_var</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>Then we compute explanations using the <code>ctree</code> and
<code>vaeac</code> approaches. For the <code>vaeac</code> approach, we
consider two setups: the default architecture, and a simpler one without
skip connections. We do this to illustrate that the skip connections
improve the <code>vaeac</code> method. We use <code>ctree</code> with
default parameters.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Here we use the ctree approach</span></span>
<span><span class="va">expl_ctree</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain_cat</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train_cat</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"ctree"</span>,</span>
<span>  phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>  n_MC_samples <span class="op">=</span> <span class="fl">250</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Success with message:</span></span>
<span><span class="co">#&gt; max_n_coalitions is NULL or larger than or 2^n_features = 16, </span></span>
<span><span class="co">#&gt; and is therefore set to 2^n_features = 16.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Starting `shapr::explain()` at 2024-11-21 20:04:53 ───────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • Model class: &lt;ranger&gt;</span></span>
<span><span class="co">#&gt; • Approach: ctree</span></span>
<span><span class="co">#&gt; • Iterative estimation: FALSE</span></span>
<span><span class="co">#&gt; • Number of feature-wise Shapley values: 4</span></span>
<span><span class="co">#&gt; • Number of observations to explain: 6</span></span>
<span><span class="co">#&gt; • Computations (temporary) saved at: '/tmp/RtmpCcS4cy/shapr_obj_1b8c93620526e3.rds'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Main computation started ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ℹ Using 16 of 16 coalitions.</span></span>
<span></span>
<span><span class="co"># Then we use the vaeac approach</span></span>
<span><span class="va">expl_vaeac_with</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain_cat</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train_cat</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>  phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>  n_MC_samples <span class="op">=</span> <span class="fl">250</span>,</span>
<span>  vaeac.epochs <span class="op">=</span> <span class="fl">50</span>,</span>
<span>  vaeac.n_vaeacs_initialize <span class="op">=</span> <span class="fl">4</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Success with message:</span></span>
<span><span class="co">#&gt; max_n_coalitions is NULL or larger than or 2^n_features = 16, </span></span>
<span><span class="co">#&gt; and is therefore set to 2^n_features = 16.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Starting `shapr::explain()` at 2024-11-21 20:04:55 ───────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • Model class: &lt;ranger&gt;</span></span>
<span><span class="co">#&gt; • Approach: vaeac</span></span>
<span><span class="co">#&gt; • Iterative estimation: FALSE</span></span>
<span><span class="co">#&gt; • Number of feature-wise Shapley values: 4</span></span>
<span><span class="co">#&gt; • Number of observations to explain: 6</span></span>
<span><span class="co">#&gt; • Computations (temporary) saved at: '/tmp/RtmpCcS4cy/shapr_obj_1b8c932b9a671e.rds'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Main computation started ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ℹ Using 16 of 16 coalitions.</span></span>
<span></span>
<span><span class="co"># Then we use the vaeac approach</span></span>
<span><span class="va">expl_vaeac_without</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain_cat</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train_cat</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>  phi0 <span class="op">=</span> <span class="va">phi0</span>,</span>
<span>  n_MC_samples <span class="op">=</span> <span class="fl">250</span>,</span>
<span>  vaeac.epochs <span class="op">=</span> <span class="fl">50</span>,</span>
<span>  vaeac.n_vaeacs_initialize <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  vaeac.extra_parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    vaeac.skip_conn_layer <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    vaeac.skip_conn_masked_enc_dec <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Success with message:</span></span>
<span><span class="co">#&gt; max_n_coalitions is NULL or larger than or 2^n_features = 16, </span></span>
<span><span class="co">#&gt; and is therefore set to 2^n_features = 16.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Starting `shapr::explain()` at 2024-11-21 20:06:15 ───────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • Model class: &lt;ranger&gt;</span></span>
<span><span class="co">#&gt; • Approach: vaeac</span></span>
<span><span class="co">#&gt; • Iterative estimation: FALSE</span></span>
<span><span class="co">#&gt; • Number of feature-wise Shapley values: 4</span></span>
<span><span class="co">#&gt; • Number of observations to explain: 6</span></span>
<span><span class="co">#&gt; • Computations (temporary) saved at: '/tmp/RtmpCcS4cy/shapr_obj_1b8c935a5fe38f.rds'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Main computation started ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ℹ Using 16 of 16 coalitions.</span></span>
<span></span>
<span><span class="co"># We see that the `vaeac` model without the skip connections perform worse</span></span>
<span><span class="fu"><a href="../reference/plot_vaeac_eval_crit.html">plot_vaeac_eval_crit</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"Vaeac w.o. skip-con."</span> <span class="op">=</span> <span class="va">expl_vaeac_without</span>,</span>
<span>    <span class="st">"Vaeac w. skip-con."</span> <span class="op">=</span> <span class="va">expl_vaeac_with</span></span>
<span>  <span class="op">)</span>,</span>
<span>  plot_type <span class="op">=</span> <span class="st">"criterion"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac%2Fvaeac-mixed-data-1.png"></p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># The vaeac model with skip connections have the lowest/best MSE_Frye evaluation criterion score</span></span>
<span><span class="fu"><a href="../reference/plot_MSEv_eval_crit.html">plot_MSEv_eval_crit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"Vaeac w.o. skip-con."</span> <span class="op">=</span> <span class="va">expl_vaeac_without</span>,</span>
<span>  <span class="st">"Vaeac w. skip-con."</span> <span class="op">=</span> <span class="va">expl_vaeac_with</span>,</span>
<span>  <span class="st">"Ctree"</span> <span class="op">=</span> <span class="va">expl_ctree</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac%2Fvaeac-mixed-data-2.png"></p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Can compare the Shapley values. Ctree and vaeac with skip connections produce similar explanations.</span></span>
<span><span class="fu"><a href="../reference/plot_SV_several_approaches.html">plot_SV_several_approaches</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"Vaeac w.o. skip-con."</span> <span class="op">=</span> <span class="va">expl_vaeac_without</span>,</span>
<span>    <span class="st">"Vaeac w. skip-con."</span> <span class="op">=</span> <span class="va">expl_vaeac_with</span>,</span>
<span>    <span class="st">"Ctree"</span> <span class="op">=</span> <span class="va">expl_ctree</span></span>
<span>  <span class="op">)</span>,</span>
<span>  index_explicands <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">6</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac%2Fvaeac-mixed-data-3.png"></p>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-torch" class="csl-entry">
Falbel, Daniel, and Javier Luraschi. 2023. <em>Torch: Tensors and Neural
Networks with ’GPU’ Acceleration</em>. <a href="https://CRAN.R-project.org/package=torch" class="external-link">https://CRAN.R-project.org/package=torch</a>.
</div>
<div id="ref-kingma2014autoencoding" class="csl-entry">
Kingma, Diederik P., and Max Welling. 2014. <span>“<span>Auto-Encoding
Variational Bayes</span>.”</span> In <em>2nd International Conference on
Learning Representations, <span>ICLR</span> 2014, Banff, AB, Canada,
April 14-16, 2014, Conference Track Proceedings</em>.
</div>
<div id="ref-olsen2022using" class="csl-entry">
Olsen, Lars Henry Berge, Ingrid Kristine Glad, Martin Jullum, and
Kjersti Aas. 2022. <span>“Using Shapley Values and Variational
Autoencoders to Explain Predictive Models with Dependent Mixed
Features.”</span> <em>Journal of Machine Learning Research</em> 23
(213): 1–51.
</div>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Martin Jullum, Lars Henry Berge Olsen, Annabelle Redelmeier, Jon Lachmann, Nikolai Sellereite, Norsk Regnesentral.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
