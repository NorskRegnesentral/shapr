<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>More details and advanced usage of the `vaeac` approach â€¢ shapr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="More details and advanced usage of the `vaeac` approach">
<meta property="og:description" content="shapr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">shapr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.2.3.9200</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/understanding_shapr.html">General usage of shapr</a>
    </li>
    <li>
      <a href="../articles/understanding_shapr_vaeac.html">Advanced usage of the `vaeac` approach</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
<li>
  <a href="../reference/index.html">Manual</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/NorskRegnesentral/shapr/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>More details and advanced usage of the
<code>vaeac</code> approach</h1>
                        <h4 data-toc-skip class="author">Lars Henry
Berge Olsen</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/NorskRegnesentral/shapr/blob/HEAD/vignettes/understanding_shapr_vaeac.Rmd" class="external-link"><code>vignettes/understanding_shapr_vaeac.Rmd</code></a></small>
      <div class="hidden name"><code>understanding_shapr_vaeac.Rmd</code></div>

    </div>

    
    
<blockquote>
<p><a href="#vaeac">The vaeac method</a></p>
</blockquote>
<blockquote>
<p><a href="#Code">Code</a></p>
</blockquote>
<blockquote>
<p><a href="#basicexample">Basic Example</a></p>
</blockquote>
<blockquote>
<p><a href="#pretrained_vaeac">Pretrained vaeac</a></p>
</blockquote>
<blockquote>
<p><a href="#pretrained_vaeac_path">Pretrained vaeac (path)</a></p>
</blockquote>
<blockquote>
<p><a href="#n_combinations">Subset of coalitions</a></p>
</blockquote>
<blockquote>
<p><a href="#paired_sampling">Paired sampling</a></p>
</blockquote>
<blockquote>
<p><a href="#progress_bar">Progress bar</a></p>
</blockquote>
<blockquote>
<p><a href="#continue_training">Continue training</a></p>
</blockquote>
<blockquote>
<p><a href="#early_stopping">Early stopping</a></p>
</blockquote>
<blockquote>
<p><a href="#grouping_of_features">Grouping of features</a></p>
</blockquote>
<blockquote>
<p><a href="#mixed_data">Mixed data</a></p>
</blockquote>
<blockquote>
<p><a href="#cpu_vs_gpu">Comparing CPU and GPU</a></p>
</blockquote>
<p><a id="intro"></a></p>
<p>In this vignette, we elaborate and illustrate the <code>vaeac</code>
approach in more depth than in the main vignette. In the main vignette,
only a few basic examples of using <code>vaeac</code> is included, while
we here showcase more advanced usage. See the overview above for what
topics that are covered in this vignette.</p>
<div class="section level2">
<h2 id="vaeac">vaeac<a class="anchor" aria-label="anchor" href="#vaeac"></a>
</h2>
<p>An approach that supports mixed features is the Variational
AutoEncoder with Arbitrary Conditioning (<span class="citation">Olsen et
al. (2022)</span>), abbreviated to <code>vaeac</code>. The
<code>vaeac</code> is an extension of the regular variational
autoencoder (<span class="citation">Kingma and Welling (2014)</span>),
but instead of giving a probabilistic representation of the distribution
<span class="math inline">\(p(\boldsymbol{x})\)</span> it gives a
probabilistic representation of the conditional distribution <span class="math inline">\(p(\boldsymbol{x}_{\bar{\mathcal{S}}} \mid
\boldsymbol{x}_{\mathcal{S}})\)</span>, for all possible feature subsets
<span class="math inline">\(\mathcal{S}\subseteq\mathcal{M}\)</span>
simultaneously, where <span class="math inline">\(\mathcal{M}\)</span>
is the set of all features. That is, only a single <code>vaeac</code>
model is needed to model all conditional distributions.</p>
<p>The <code>vaeac</code> consists of three neural networks: a <em>full
encoder</em>, a <em>masked encoder</em>, and a <em>decoder</em>. The
encoders map the full and masked/conditional input representations,
i.e., <span class="math inline">\(\boldsymbol{x}\)</span> and <span class="math inline">\(\boldsymbol{x}_{\mathcal{S}}\)</span>,
respectively, to latent probabilistic representations. Sampled instances
from this latent probabilistic representations are sent to the decoder,
which maps them back to the feature space and provides a samplable
probabilistic representation for the unconditioned features <span class="math inline">\(\boldsymbol{x}_{\bar{\mathcal{S}}}\)</span>. The
full encoder is only used during the training phase of the
<code>vaeac</code> model to guide the training process of the masked
encoder, as the former relies on the full input sample <span class="math inline">\(\boldsymbol{x}\)</span>, which is not accessible
in the deployment phase (when we generate the Monte Carlo samples), as
we only have access to <span class="math inline">\(\boldsymbol{x}_{\mathcal{S}}\)</span>. The
networks are trained by minimizing a variational lower bound, and see
Section 3 in <span class="citation">Olsen et al. (2022)</span> for an
in-depth introduction to the <code>vaeac</code> methodology. We use the
<code>vaeac</code> model at the epoch which obtains the lowest
validation IWAE score to generate the Monte Carlo samples used in the
Shapley value computations.</p>
<p>We fit the <code>vaeac</code> model using the <em>torch</em> package
in <span class="math inline">\(\textsf{R}\)</span> (<span class="citation">Falbel and Luraschi (2023)</span>). The main parameters
are the the number of layers in the networks (<code>vaeac.depth</code>),
the width of the layers (<code>vaeac.width</code>), the number of
dimensions in the latent space (<code>vaeac.latent_dim</code>), the
activation function between the layers in the networks
(<code>vaeac.activation_function</code>), the learning rate in the ADAM
optimizer (<code>vaeac.lr</code>), the number of <code>vaeac</code>
models to initiate to remedy poorly initiated model parameter values
(<code>vaeac.n_vaeacs_initialize</code>), and the number of learning
epochs (<code>vaeac.epochs</code>). Call
<code><a href="../reference/setup_approach.html">?shapr::setup_approach.vaeac</a></code> for a more detailed
description of the parameters.</p>
<p>There are additional extra parameters which can be set by including a
named list in the call to the <code><a href="../reference/explain.html">explain()</a></code> function. For
example, we can the change the batch size to 32 by including
<code>vaeac.extra_parameters = list(vaeac.batch_size = 32)</code> as a
parameter in the call the <code><a href="../reference/explain.html">explain()</a></code> function. See
<code><a href="../reference/vaeac_get_extra_para_default.html">?shapr::vaeac_get_extra_para_default</a></code> for a description of
the possible extra parameters to the <code>vaeac</code> approach. We
strongly encourage the user to specify the main and extra parameters to
the <code>vaeac</code> approach at the correct place in the call to the
<code><a href="../reference/explain.html">explain()</a></code> function. That is, the main parameters are
directly entered to the <code><a href="../reference/explain.html">explain()</a></code> function, while the extra
parameters are included in a named list called
<code>vaeac.extra_parameters</code>. However, the <code>vaeac</code>
approach will try to correct for misplaced and duplicated parameters and
give warnings to the user.</p>
</div>
<div class="section level2">
<h2 id="code">Code Examples<a class="anchor" aria-label="anchor" href="#code"></a>
</h2>
<p>We now demonstrate the <code>vaeac</code> approach on several
different use cases. Note that this vignette runs on CPU, but all code
sections below can be run on GPU too. To enable GPU, we have to include
<code>vaeac.extra_parameters = list(vaeac.cuda = TRUE)</code> in the
calls to the <code><a href="../reference/explain.html">explain()</a></code> function. See <a href="#cpu_vs_gpu">CPU vs GPU</a> for more information.</p>
<div class="section level3">
<h3 id="basicexample">Basic Example<a class="anchor" aria-label="anchor" href="#basicexample"></a>
</h3>
<p>Here we go through how to use the <code>vaeac</code> approach on the
same data as in the main vignette</p>
<p>First we set up the model we want to explain.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/dmlc/xgboost" class="external-link">xgboost</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"airquality"</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html" class="external-link">complete.cases</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span><span class="va">x_var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Solar.R"</span>, <span class="st">"Wind"</span>, <span class="st">"Temp"</span>, <span class="st">"Month"</span><span class="op">)</span></span>
<span><span class="va">y_var</span> <span class="op">&lt;-</span> <span class="st">"Ozone"</span></span>
<span></span>
<span><span class="va">ind_x_explain</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">6</span></span>
<span><span class="va">x_train</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="op">-</span><span class="va">ind_x_explain</span>, <span class="va">..x_var</span><span class="op">]</span></span>
<span><span class="va">y_train</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="op">-</span><span class="va">ind_x_explain</span>, <span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">y_var</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">x_explain</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="va">ind_x_explain</span>, <span class="va">..x_var</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Fitting a basic xgboost model to the training data</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.train.html" class="external-link">xgboost</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">x_train</span><span class="op">)</span>,</span>
<span>  label <span class="op">=</span> <span class="va">y_train</span>,</span>
<span>  nround <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Specifying the phi_0, i.e. the expected prediction without any features</span></span>
<span><span class="va">prediction_zero</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">y_train</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="first-vaeac-example">First vaeac example<a class="anchor" aria-label="anchor" href="#first-vaeac-example"></a>
</h3>
<p>We are now going to explain predictions made by the model using the
<code>vaeac</code> approach.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_samples</span> <span class="op">&lt;-</span> <span class="fl">25</span> <span class="co"># Low number of MC samples to make the vignette build faster</span></span>
<span><span class="va">n_batches</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="co"># Do all coalitions in one batch</span></span>
<span><span class="va">vaeac.n_vaeacs_initialize</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="co"># Initialize several vaeacs to counteract bad initialization values</span></span>
<span><span class="va">vaeac.epochs</span> <span class="op">&lt;-</span> <span class="fl">4</span> <span class="co"># The number of training epochs</span></span>
<span></span>
<span><span class="va">explanation</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>  prediction_zero <span class="op">=</span> <span class="va">prediction_zero</span>,</span>
<span>  n_samples <span class="op">=</span> <span class="va">n_samples</span>,</span>
<span>  n_batches <span class="op">=</span> <span class="va">n_batches</span>,</span>
<span>  vaeac.epochs <span class="op">=</span> <span class="va">vaeac.epochs</span>,</span>
<span>  vaeac.n_vaeacs_initialize <span class="op">=</span> <span class="va">vaeac.n_vaeacs_initialize</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span></code></pre></div>
<p>We can look at the Shapley values.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Printing and ploting the Shapley values.</span></span>
<span><span class="co"># See ?shapr::explain for interpretation of the values.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">explanation</span><span class="op">$</span><span class="va">shapley_values</span><span class="op">)</span></span>
<span><span class="co">#&gt;      none Solar.R    Wind     Temp    Month</span></span>
<span><span class="co">#&gt;     &lt;num&gt;   &lt;num&gt;   &lt;num&gt;    &lt;num&gt;    &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: 43.086  6.1207  3.1430 -18.6779 -2.88614</span></span>
<span><span class="co">#&gt; 2: 43.086 -2.0779 -2.5548 -20.1182  0.69569</span></span>
<span><span class="co">#&gt; 3: 43.086  3.0385 -5.5121 -18.2575 -2.55871</span></span>
<span><span class="co">#&gt; 4: 43.086  3.0009 -4.7220  -8.9452 -3.92486</span></span>
<span><span class="co">#&gt; 5: 43.086 -1.1022 -4.4319 -13.5459 -5.29567</span></span>
<span><span class="co">#&gt; 6: 43.086  3.9320 -9.8445 -11.9489 -3.56018</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">explanation</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac/first-vaeac-plots-1.png"></p>
</div>
<div class="section level3">
<h3 id="pretrained_vaeac">Pre-trained vaeac<a class="anchor" aria-label="anchor" href="#pretrained_vaeac"></a>
</h3>
<p>If the user has a pre-trained <code>vaeac</code> model (from a
previous run), the user can send that to the <code><a href="../reference/explain.html">explain()</a></code>
function and <code>shapr</code> will skip the training of a new
<code>vaeac</code> model and rather use the provided <code>vaeac</code>
model. This is useful if we want to explain new predictions using the
same combinations/coalitions as previously, i.e., we have a new
<code>x_explain</code>. Note that the new <code>x_explain</code> must
have the same features as before.</p>
<p>The <code>vaeac</code> model is accessible via
<code>explanation$internal$parameters$vaeac</code>. Note that if we set
<code>verbose = 2</code> in <code><a href="../reference/explain.html">explain()</a></code>, then
<code>shapr</code> will give a message that it loads a pretrained
<code>vaeac</code> model instead of training it from scratch.</p>
<p>In this example, we extract the trained <code>vaeac</code> model from
the previous example and send it to <code><a href="../reference/explain.html">explain()</a></code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Send the pre-trained vaeac model</span></span>
<span><span class="va">expl_pretrained_vaeac</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>  prediction_zero <span class="op">=</span> <span class="va">prediction_zero</span>,</span>
<span>  n_batches <span class="op">=</span> <span class="va">n_batches</span>,</span>
<span>  n_samples <span class="op">=</span> <span class="va">n_samples</span>,</span>
<span>  vaeac.extra_parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    vaeac.pretrained_vaeac_model <span class="op">=</span> <span class="va">explanation</span><span class="op">$</span><span class="va">internal</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">vaeac</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span></span>
<span><span class="co"># Check that this version provides the same Shapley values</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">explanation</span><span class="op">$</span><span class="va">shapley_values</span>, <span class="va">expl_pretrained_vaeac</span><span class="op">$</span><span class="va">shapley_values</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="pretrained_vaeac_path">Pre-trained vaeac (path)<a class="anchor" aria-label="anchor" href="#pretrained_vaeac_path"></a>
</h3>
<p>We can also just provide a path to the stored <code>vaeac</code>
model. This is beneficial if we have only stored the <code>vaeac</code>
model on the computer but not the whole <code>explanation</code> object.
The possible save paths are stored in
<code>explanation$internal$parameters$vaeac$model</code>. Note that if
we set <code>verbose = 2</code> in <code><a href="../reference/explain.html">explain()</a></code>, then
<code>shapr</code> will give a message that it loads a pretrained
<code>vaeac</code> model instead of training it from scratch.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Call `explanation$internal$parameters$vaeac$model` to see possible vaeac models. We use `best` below.</span></span>
<span><span class="co"># send the pre-trained vaeac path</span></span>
<span><span class="va">expl_pretrained_vaeac_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>  prediction_zero <span class="op">=</span> <span class="va">prediction_zero</span>,</span>
<span>  n_batches <span class="op">=</span> <span class="va">n_batches</span>,</span>
<span>  n_samples <span class="op">=</span> <span class="va">n_samples</span>,</span>
<span>  vaeac.extra_parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    vaeac.pretrained_vaeac_model <span class="op">=</span> <span class="va">explanation</span><span class="op">$</span><span class="va">internal</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">vaeac</span><span class="op">$</span><span class="va">models</span><span class="op">$</span><span class="va">best</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span></span>
<span><span class="co"># Check that this version provides the same Shapley values</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">explanation</span><span class="op">$</span><span class="va">shapley_values</span>, <span class="va">expl_pretrained_vaeac_path</span><span class="op">$</span><span class="va">shapley_values</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="n_combinations">Specified n_combinations and more batches<a class="anchor" aria-label="anchor" href="#n_combinations"></a>
</h3>
<p>In this section, we discuss two general <code>shapr</code> parameters
in the <code><a href="../reference/explain.html">explain()</a></code> function that are method independent,
namely, <code>n_combinations</code> and <code>n_batches</code>. The user
can limit the Shapley value computations to only a subset of coalitions
by setting the <code>n_combinations</code> parameter to a value lower
than <span class="math inline">\(2^{n_\text{features}}\)</span>. To
lower the memory usage, the user can split the coalitions into several
batches by setting <code>n_batches</code> to a desired number. In this
example, we set <code>n_batches = 5</code> and
<code>n_combinations = 10</code> which is less than the maximum of
<code>16</code>.</p>
<p>Note that we do not need to train a new <code>vaeac</code> model as
we can use the one above trained on all <code>16</code> coalitions as we
are now only using a subset of them. This is not applicable the other
way around.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># send the pre-trained vaeac path</span></span>
<span><span class="va">expl_batches_combinations</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>  prediction_zero <span class="op">=</span> <span class="va">prediction_zero</span>,</span>
<span>  n_combinations <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  n_batches <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  n_samples <span class="op">=</span> <span class="va">n_samples</span>,</span>
<span>  vaeac.extra_parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    vaeac.pretrained_vaeac_model <span class="op">=</span> <span class="va">explanation</span><span class="op">$</span><span class="va">internal</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">vaeac</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span></span>
<span><span class="co"># Gives different Shapley values as the latter one are only based on a subset of coalitions</span></span>
<span><span class="fu"><a href="../reference/plot_SV_several_approaches.html">plot_SV_several_approaches</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Original"</span> <span class="op">=</span> <span class="va">explanation</span>, <span class="st">"Other combi."</span> <span class="op">=</span> <span class="va">expl_batches_combinations</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac/check-n_combinations-and-more-batches-1.png"></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Here we can see that the samples coalitions are in different batches and have different weights</span></span>
<span><span class="va">expl_batches_combinations</span><span class="op">$</span><span class="va">internal</span><span class="op">$</span><span class="va">objects</span><span class="op">$</span><span class="va">X</span></span>
<span><span class="co">#&gt; Key: &lt;id_combination&gt;</span></span>
<span><span class="co">#&gt; Index: &lt;approach&gt;</span></span>
<span><span class="co">#&gt;     id_combination features n_features     N shapley_weight approach batch</span></span>
<span><span class="co">#&gt;              &lt;int&gt;   &lt;list&gt;      &lt;int&gt; &lt;int&gt;          &lt;int&gt;   &lt;char&gt; &lt;num&gt;</span></span>
<span><span class="co">#&gt;  1:              1                   0     1        1000000     &lt;NA&gt;    NA</span></span>
<span><span class="co">#&gt;  2:              2        3          1     4              1    vaeac     1</span></span>
<span><span class="co">#&gt;  3:              3        4          1     4              1    vaeac     3</span></span>
<span><span class="co">#&gt;  4:              4        2          1     4              1    vaeac     2</span></span>
<span><span class="co">#&gt;  5:              5      2,3          2     6              2    vaeac     5</span></span>
<span><span class="co">#&gt;  6:              6      1,4          2     6              1    vaeac     2</span></span>
<span><span class="co">#&gt;  7:              7    1,3,4          3     4              2    vaeac     5</span></span>
<span><span class="co">#&gt;  8:              8    2,3,4          3     4              1    vaeac     4</span></span>
<span><span class="co">#&gt;  9:              9    1,2,3          3     4              1    vaeac     4</span></span>
<span><span class="co">#&gt; 10:             10  1,2,3,4          4     1        1000000     &lt;NA&gt;     1</span></span>
<span></span>
<span><span class="co"># Can compare that to the situation where we have exact computations (i.e., include all coalitions)</span></span>
<span><span class="va">explanation</span><span class="op">$</span><span class="va">internal</span><span class="op">$</span><span class="va">objects</span><span class="op">$</span><span class="va">X</span></span>
<span><span class="co">#&gt; Key: &lt;id_combination&gt;</span></span>
<span><span class="co">#&gt;     id_combination features n_features     N shapley_weight approach batch</span></span>
<span><span class="co">#&gt;              &lt;int&gt;   &lt;list&gt;      &lt;int&gt; &lt;int&gt;          &lt;num&gt;   &lt;char&gt; &lt;num&gt;</span></span>
<span><span class="co">#&gt;  1:              1                   0     1       1.00e+06     &lt;NA&gt;    NA</span></span>
<span><span class="co">#&gt;  2:              2        1          1     4       2.50e-01    vaeac     1</span></span>
<span><span class="co">#&gt;  3:              3        2          1     4       2.50e-01    vaeac     1</span></span>
<span><span class="co">#&gt;  4:              4        3          1     4       2.50e-01    vaeac     1</span></span>
<span><span class="co">#&gt;  5:              5        4          1     4       2.50e-01    vaeac     1</span></span>
<span><span class="co">#&gt;  6:              6      1,2          2     6       1.25e-01    vaeac     1</span></span>
<span><span class="co">#&gt;  7:              7      1,3          2     6       1.25e-01    vaeac     1</span></span>
<span><span class="co">#&gt;  8:              8      1,4          2     6       1.25e-01    vaeac     1</span></span>
<span><span class="co">#&gt;  9:              9      2,3          2     6       1.25e-01    vaeac     1</span></span>
<span><span class="co">#&gt; 10:             10      2,4          2     6       1.25e-01    vaeac     1</span></span>
<span><span class="co">#&gt; 11:             11      3,4          2     6       1.25e-01    vaeac     1</span></span>
<span><span class="co">#&gt; 12:             12    1,2,3          3     4       2.50e-01    vaeac     1</span></span>
<span><span class="co">#&gt; 13:             13    1,2,4          3     4       2.50e-01    vaeac     1</span></span>
<span><span class="co">#&gt; 14:             14    1,3,4          3     4       2.50e-01    vaeac     1</span></span>
<span><span class="co">#&gt; 15:             15    2,3,4          3     4       2.50e-01    vaeac     1</span></span>
<span><span class="co">#&gt; 16:             16  1,2,3,4          4     1       1.00e+06     &lt;NA&gt;     1</span></span></code></pre></div>
<p>Note that if we train a <code>vaeac</code> model from scratch with
the setup above, then the <code>vaeac</code> model will not use a
missing completely as random (MCAR) mask generator, but rather a mask
generator that ensures that the <code>vaeac</code> model is only trained
on the specified set of coalitions. In this case, it will be the set of
the <code>n_combinations - 2</code> sampled coalitions. The minus two is
because the <code>vaeac</code> model will not train on the empty and
grand coalitions as they are not needed in the Shapley value
computations.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">expl_batches_combinations_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>  prediction_zero <span class="op">=</span> <span class="va">prediction_zero</span>,</span>
<span>  n_combinations <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  n_batches <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  n_samples <span class="op">=</span> <span class="va">n_samples</span>,</span>
<span>  vaeac.n_vaeacs_initialize <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  vaeac.epochs <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  verbose <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Setting up the `vaeac` approach.</span></span>
<span><span class="co">#&gt; Training the `vaeac` model with the provided parameters from scratch on CPU.</span></span>
<span><span class="co">#&gt; Using 'specified_masks_mask_generator' with '8' coalitions.</span></span>
<span><span class="co">#&gt; The vaeac model contains 17032 trainable parameters.</span></span>
<span><span class="co">#&gt; Initializing vaeac number 1 of 1.</span></span>
<span><span class="co">#&gt; Best vaeac inititalization was number 1 (of 1) with a training VLB = -6.451 after 2 epochs. Continue to train this inititalization.</span></span>
<span><span class="co">#&gt; Saving `best` vaeac model at epoch 3.</span></span>
<span><span class="co">#&gt; Saving `best_running` vaeac model at epoch 3.</span></span>
<span><span class="co">#&gt; Saving `last` vaeac model at epoch 3.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Results of the `vaeac` training process:</span></span>
<span><span class="co">#&gt; Best epoch:             3.   VLB = -4.824    IWAE = -3.252   IWAE_running = -3.540</span></span>
<span><span class="co">#&gt; Best running avg epoch: 3.   VLB = -4.824    IWAE = -3.252   IWAE_running = -3.540</span></span>
<span><span class="co">#&gt; Last epoch:             3.   VLB = -4.824    IWAE = -3.252   IWAE_running = -3.540</span></span>
<span><span class="co">#&gt; Done with setting up the `vaeac` approach.</span></span>
<span><span class="co">#&gt; Generating Monte Carlo samples using `vaeac` for batch 1 of 1.</span></span>
<span><span class="co">#&gt; Preprocessing the explicands.</span></span>
<span><span class="co">#&gt; Generating the MC samples.</span></span>
<span><span class="co">#&gt; Postprocessing the Monte Carlo samples.</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="paired_sampling">Paired sampling<a class="anchor" aria-label="anchor" href="#paired_sampling"></a>
</h3>
<p>The <code>vaeac</code> approach can use paired sampling to improve
the stability of the training procedure. When using paired sampling,
each observation in the training batches will be duplicated, but the
first version will be masked by <span class="math inline">\(S\)</span>
and the second verion will be masked by the complement <span class="math inline">\(\bar{S}\)</span>. The mask are taken from the
<code>explanation$internal$objects$S</code> matrix. Note that
<code>vaeac</code> does not check if the complement is also in said
matrix. This means that if the Shapley value explanations are computed
based on a subset of coalitions, i.e., <code>n_combinations</code> is
less than <span class="math inline">\(2^{n_\text{features}}\)</span>,
then the <code>vaeac</code> model might be trained on coalitions which
are not used when computing the Shapley values. This should not be
considered as redundant training as it increases the stablility and
performance of the <code>vaeac</code> model as a whole, hence, we
reccomend to use paried samping (default). Furthermore, the masks are
randomly selected for each observation in the batch. The training time
when using paired sampling is higher in comparison to random sampling
due to more complex implementation.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">expl_paired_sampling_TRUE</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>  prediction_zero <span class="op">=</span> <span class="va">prediction_zero</span>,</span>
<span>  n_samples <span class="op">=</span> <span class="va">n_samples</span>,</span>
<span>  n_batches <span class="op">=</span> <span class="va">n_batches</span>,</span>
<span>  vaeac.epochs <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  vaeac.n_vaeacs_initialize <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  vaeac.extra_parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>vaeac.paired_sampling <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span></span>
<span><span class="va">expl_paired_sampling_FALSE</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>  prediction_zero <span class="op">=</span> <span class="va">prediction_zero</span>,</span>
<span>  n_samples <span class="op">=</span> <span class="va">n_samples</span>,</span>
<span>  n_batches <span class="op">=</span> <span class="va">n_batches</span>,</span>
<span>  vaeac.epochs <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  vaeac.n_vaeacs_initialize <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  vaeac.extra_parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>vaeac.paired_sampling <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span></code></pre></div>
<p>We can compare the results by looking at the training and validation
errors and by the <span class="math inline">\(MSE_v\)</span> evaluation
criterion. We do this by using the <code><a href="../reference/vaeac_plot_eval_crit.html">vaeac_plot_eval_crit()</a></code>
and <code><a href="../reference/plot_MSEv_eval_crit.html">plot_MSEv_eval_crit()</a></code> functions in the
<code>shapr</code> package, respectively.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">explanation_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Regular samp."</span> <span class="op">=</span> <span class="va">expl_paired_sampling_FALSE</span>,</span>
<span>                         <span class="st">"Paired samp."</span> <span class="op">=</span> <span class="va">expl_paired_sampling_TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/vaeac_plot_eval_crit.html">vaeac_plot_eval_crit</a></span><span class="op">(</span><span class="va">explanation_list</span>, plot_type <span class="op">=</span> <span class="st">"criterion"</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac/paired-sampling-plotting-1.png"></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_MSEv_eval_crit.html">plot_MSEv_eval_crit</a></span><span class="op">(</span><span class="va">explanation_list</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac/paired-sampling-plotting-2.png"></p>
<p>By looking at the time, we see that the paired version takes (a bit)
longer time in the <code>setup_computation</code> phase, that is, in the
training phase.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="st">"Paired"</span> <span class="op">=</span> <span class="va">expl_paired_sampling_TRUE</span><span class="op">$</span><span class="va">timing</span><span class="op">$</span><span class="va">timing_secs</span>,</span>
<span>  <span class="st">"Regular"</span> <span class="op">=</span> <span class="va">expl_paired_sampling_FALSE</span><span class="op">$</span><span class="va">timing</span><span class="op">$</span><span class="va">timing_secs</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;           setup test_prediction setup_computation compute_vS shapley_computation</span></span>
<span><span class="co">#&gt; Paired  0.10987        0.055879            7.1928    0.29876           0.0043712</span></span>
<span><span class="co">#&gt; Regular 0.05501        0.037705            6.2180    0.30362           0.0044370</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="progress_bar">Progressr<a class="anchor" aria-label="anchor" href="#progress_bar"></a>
</h3>
<p>As discussed in the main vignette, the <code>shapr</code> package
provides two ways for recieving information about the progress of the
approach. First, the <code>shapr</code> package provides progress
updates of the computation of the Shapley values through the
<code>progressr</code> package. Second, the user can also get
information by setting <code>verbose = 2</code> in
<code><a href="../reference/explain.html">explain()</a></code>, which will print out extra information related
to the <code>vaeac</code> approach. The <code>verbose</code> parameter
works independently of the <code>progressr</code> package. Meaning that
the user can chose to use none, either, or both options simultaneously.
We give two examples here, and refer the reader to the main vignette for
more detailed information.</p>
<p>By setting <code>verbose = 2</code>, we get messages about the
progress of the <code>vaeac</code> approach.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://progressr.futureverse.org/reference/handlers.html" class="external-link">handlers</a></span><span class="op">(</span><span class="st">"void"</span><span class="op">)</span> <span class="co"># To silence all progressr updates</span></span>
<span><span class="va">expl_with_messages</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>  prediction_zero <span class="op">=</span> <span class="va">prediction_zero</span>,</span>
<span>  n_samples <span class="op">=</span> <span class="va">n_samples</span>,</span>
<span>  n_batches <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  verbose <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  vaeac.epochs <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  vaeac.n_vaeacs_initialize <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Setting up the `vaeac` approach.</span></span>
<span><span class="co">#&gt; Training the `vaeac` model with the provided parameters from scratch on CPU.</span></span>
<span><span class="co">#&gt; Using 'mcar_mask_generator' with 'masking_ratio = 0.5'.</span></span>
<span><span class="co">#&gt; The vaeac model contains 17032 trainable parameters.</span></span>
<span><span class="co">#&gt; Initializing vaeac number 1 of 2.</span></span>
<span><span class="co">#&gt; Initializing vaeac number 2 of 2.</span></span>
<span><span class="co">#&gt; Best vaeac inititalization was number 2 (of 2) with a training VLB = -4.566 after 2 epochs. Continue to train this inititalization.</span></span>
<span><span class="co">#&gt; Saving `best` vaeac model at epoch 3.</span></span>
<span><span class="co">#&gt; Saving `best_running` vaeac model at epoch 3.</span></span>
<span><span class="co">#&gt; Saving `best_running` vaeac model at epoch 4.</span></span>
<span><span class="co">#&gt; Saving `best` vaeac model at epoch 5.</span></span>
<span><span class="co">#&gt; Saving `best_running` vaeac model at epoch 5.</span></span>
<span><span class="co">#&gt; Saving `last` vaeac model at epoch 5.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Results of the `vaeac` training process:</span></span>
<span><span class="co">#&gt; Best epoch:             5.   VLB = -3.318    IWAE = -3.049   IWAE_running = -3.149</span></span>
<span><span class="co">#&gt; Best running avg epoch: 5.   VLB = -3.318    IWAE = -3.049   IWAE_running = -3.149</span></span>
<span><span class="co">#&gt; Last epoch:             5.   VLB = -3.318    IWAE = -3.049   IWAE_running = -3.149</span></span>
<span><span class="co">#&gt; Done with setting up the `vaeac` approach.</span></span>
<span><span class="co">#&gt; Generating Monte Carlo samples using `vaeac` for batch 1 of 5.</span></span>
<span><span class="co">#&gt; Preprocessing the explicands.</span></span>
<span><span class="co">#&gt; Generating the MC samples.</span></span>
<span><span class="co">#&gt; Postprocessing the Monte Carlo samples.</span></span>
<span><span class="co">#&gt; Generating Monte Carlo samples using `vaeac` for batch 2 of 5.</span></span>
<span><span class="co">#&gt; Preprocessing the explicands.</span></span>
<span><span class="co">#&gt; Generating the MC samples.</span></span>
<span><span class="co">#&gt; Postprocessing the Monte Carlo samples.</span></span>
<span><span class="co">#&gt; Generating Monte Carlo samples using `vaeac` for batch 3 of 5.</span></span>
<span><span class="co">#&gt; Preprocessing the explicands.</span></span>
<span><span class="co">#&gt; Generating the MC samples.</span></span>
<span><span class="co">#&gt; Postprocessing the Monte Carlo samples.</span></span>
<span><span class="co">#&gt; Generating Monte Carlo samples using `vaeac` for batch 4 of 5.</span></span>
<span><span class="co">#&gt; Preprocessing the explicands.</span></span>
<span><span class="co">#&gt; Generating the MC samples.</span></span>
<span><span class="co">#&gt; Postprocessing the Monte Carlo samples.</span></span>
<span><span class="co">#&gt; Generating Monte Carlo samples using `vaeac` for batch 5 of 5.</span></span>
<span><span class="co">#&gt; Preprocessing the explicands.</span></span>
<span><span class="co">#&gt; Generating the MC samples.</span></span>
<span><span class="co">#&gt; Postprocessing the Monte Carlo samples.</span></span></code></pre></div>
<p>For more visual information, we can use the <code>progressr</code>
package. This can help us see the progress of the training step for the
final <code>vaeac</code> model. Note that one can set
<code>verbose = 0</code> to not get any messages from the
<code>vaeac</code> approach and only get the progress bars. See the main
vignette for examples for how to change the progress bar.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://progressr.futureverse.org" class="external-link">progressr</a></span><span class="op">)</span></span>
<span><span class="fu">progressr</span><span class="fu">::</span><span class="fu"><a href="https://progressr.futureverse.org/reference/handlers.html" class="external-link">handlers</a></span><span class="op">(</span><span class="st">"cli"</span><span class="op">)</span></span>
<span><span class="fu">progressr</span><span class="fu">::</span><span class="fu"><a href="https://progressr.futureverse.org/reference/with_progress.html" class="external-link">with_progress</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">expl_with_progressr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>    model <span class="op">=</span> <span class="va">model</span>,</span>
<span>    x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>    x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>    approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>    prediction_zero <span class="op">=</span> <span class="va">prediction_zero</span>,</span>
<span>    n_samples <span class="op">=</span> <span class="va">n_samples</span>,</span>
<span>    n_batches <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    verbose <span class="op">=</span> <span class="fl">2</span>,</span>
<span>    vaeac.epochs <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    vaeac.n_vaeacs_initialize <span class="op">=</span> <span class="fl">2</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Setting up the `vaeac` approach.</span></span>
<span><span class="co">#&gt; Training the `vaeac` model with the provided parameters from scratch on CPU.</span></span>
<span><span class="co">#&gt; Using 'mcar_mask_generator' with 'masking_ratio = 0.5'.</span></span>
<span><span class="co">#&gt; The vaeac model contains 17032 trainable parameters.</span></span>
<span><span class="co">#&gt; Initializing vaeac number 1 of 2.</span></span>
<span><span class="co">#&gt; Initializing vaeac number 2 of 2.</span></span>
<span><span class="co">#&gt; Best vaeac inititalization was number 2 (of 2) with a training VLB = -4.566 after 2 epochs. Continue to train this inititalization.</span></span>
<span><span class="co">#&gt; Saving `best` vaeac model at epoch 3.</span></span>
<span><span class="co">#&gt; Saving `best_running` vaeac model at epoch 3.</span></span>
<span><span class="co">#&gt; Saving `best_running` vaeac model at epoch 4.</span></span>
<span><span class="co">#&gt; Saving `best` vaeac model at epoch 5.</span></span>
<span><span class="co">#&gt; Saving `best_running` vaeac model at epoch 5.</span></span>
<span><span class="co">#&gt; Saving `last` vaeac model at epoch 5.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Results of the `vaeac` training process:</span></span>
<span><span class="co">#&gt; Best epoch:             5.   VLB = -3.318    IWAE = -3.049   IWAE_running = -3.149</span></span>
<span><span class="co">#&gt; Best running avg epoch: 5.   VLB = -3.318    IWAE = -3.049   IWAE_running = -3.149</span></span>
<span><span class="co">#&gt; Last epoch:             5.   VLB = -3.318    IWAE = -3.049   IWAE_running = -3.149</span></span>
<span><span class="co">#&gt; Done with setting up the `vaeac` approach.</span></span>
<span><span class="co">#&gt; Generating Monte Carlo samples using `vaeac` for batch 1 of 5.</span></span>
<span><span class="co">#&gt; Preprocessing the explicands.</span></span>
<span><span class="co">#&gt; Generating the MC samples.</span></span>
<span><span class="co">#&gt; Postprocessing the Monte Carlo samples.</span></span>
<span><span class="co">#&gt; Generating Monte Carlo samples using `vaeac` for batch 2 of 5.</span></span>
<span><span class="co">#&gt; Preprocessing the explicands.</span></span>
<span><span class="co">#&gt; Generating the MC samples.</span></span>
<span><span class="co">#&gt; Postprocessing the Monte Carlo samples.</span></span>
<span><span class="co">#&gt; Generating Monte Carlo samples using `vaeac` for batch 3 of 5.</span></span>
<span><span class="co">#&gt; Preprocessing the explicands.</span></span>
<span><span class="co">#&gt; Generating the MC samples.</span></span>
<span><span class="co">#&gt; Postprocessing the Monte Carlo samples.</span></span>
<span><span class="co">#&gt; Generating Monte Carlo samples using `vaeac` for batch 4 of 5.</span></span>
<span><span class="co">#&gt; Preprocessing the explicands.</span></span>
<span><span class="co">#&gt; Generating the MC samples.</span></span>
<span><span class="co">#&gt; Postprocessing the Monte Carlo samples.</span></span>
<span><span class="co">#&gt; Generating Monte Carlo samples using `vaeac` for batch 5 of 5.</span></span>
<span><span class="co">#&gt; Preprocessing the explicands.</span></span>
<span><span class="co">#&gt; Generating the MC samples.</span></span>
<span><span class="co">#&gt; Postprocessing the Monte Carlo samples.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">expl_with_messages</span><span class="op">$</span><span class="va">shapley_values</span>, <span class="va">expl_with_progressr</span><span class="op">$</span><span class="va">shapley_values</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="continue_training">Continue the training of the vaeac approach<a class="anchor" aria-label="anchor" href="#continue_training"></a>
</h3>
<p>In the case the user has set a too low number of training epochs and
sees that the network is still learning, then the user can continue to
train the network from where it stopped. Thus, a good workflow can
therefore be to call the <code><a href="../reference/explain.html">explain()</a></code> function with a
<code>n_samples = 1</code> (to not waste to much time to generate MC
samples), then look at the training and evaluation plots of the
<code>vaeac</code>. If not satisfied, then train more. If satisfied,
then call the <code><a href="../reference/explain.html">explain()</a></code> function again but this time by
using the extra parameter <code>vaeac.pretrained_vaeac_model</code>, as
illustrated above. Note that we have set the number of
<code>vaeac.epochs</code> to be very low in this example and we
recommend to use many more epochs.</p>
<p>We can compare the results by looking at the training and validation
errors and by the <span class="math inline">\(MSE_v\)</span> evaluation
criterion. We do this by using the <code><a href="../reference/vaeac_plot_eval_crit.html">vaeac_plot_eval_crit()</a></code>
and <code><a href="../reference/plot_MSEv_eval_crit.html">plot_MSEv_eval_crit()</a></code> functions in the
<code>shapr</code> package, respectively. We also use the
<code><a href="../reference/vaeac_plot_imputed_ggpairs.html">vaeac_plot_imputed_ggpairs()</a></code> function which generates
samples from <span class="math inline">\(p(x)\)</span>, this is ment as
a sanity check to see that the <code>vaeac</code> model is able to
follow the general structure/distribution of the data. However, recall
that the <code>vaeac</code> model is never trained on the empty
coalition, so the produces sampled should be taken with a grain of
salt.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">expl_little_training</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>  prediction_zero <span class="op">=</span> <span class="va">prediction_zero</span>,</span>
<span>  n_samples <span class="op">=</span> <span class="fl">250</span>,</span>
<span>  n_batches <span class="op">=</span> <span class="va">n_batches</span>,</span>
<span>  vaeac.epochs <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  vaeac.n_vaeacs_initialize <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Look at the training and validation errors. Not happy and want to train more.</span></span>
<span><span class="fu"><a href="../reference/vaeac_plot_eval_crit.html">vaeac_plot_eval_crit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Original"</span> <span class="op">=</span> <span class="va">expl_little_training</span><span class="op">)</span>, plot_type <span class="op">=</span> <span class="st">"method"</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac/continue-training-1.png"></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Can also see how well vaeac generates data from the full joint distribution. Quite good.</span></span>
<span><span class="fu"><a href="../reference/vaeac_plot_imputed_ggpairs.html">vaeac_plot_imputed_ggpairs</a></span><span class="op">(</span></span>
<span>  explanation <span class="op">=</span> <span class="va">expl_little_training</span>,</span>
<span>  which_vaeac_model <span class="op">=</span> <span class="st">"best"</span>,</span>
<span>  x_true <span class="op">=</span> <span class="va">x_train</span></span>
<span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac/continue-training-2.png"></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Make a copy of the explanation object and continue to train the vaeac model some more epochs</span></span>
<span><span class="va">expl_train_more</span> <span class="op">&lt;-</span> <span class="va">expl_little_training</span></span>
<span><span class="va">expl_train_more</span><span class="op">$</span><span class="va">internal</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">vaeac</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/vaeac_train_model_continue.html">vaeac_train_model_continue</a></span><span class="op">(</span></span>
<span>    explanation <span class="op">=</span> <span class="va">expl_train_more</span>,</span>
<span>    epochs_new <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    x_train <span class="op">=</span> <span class="va">x_train</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute the Shapley values again but this time using the extra trained vaeac model</span></span>
<span><span class="va">expl_train_more_vaeac</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>  prediction_zero <span class="op">=</span> <span class="va">prediction_zero</span>,</span>
<span>  n_batches <span class="op">=</span> <span class="va">n_batches</span>,</span>
<span>  n_samples <span class="op">=</span> <span class="fl">250</span>,</span>
<span>  vaeac.extra_parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    vaeac.pretrained_vaeac_model <span class="op">=</span> <span class="va">expl_train_more</span><span class="op">$</span><span class="va">internal</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">vaeac</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Look at the training and validation errors and conclude that we want to train some more</span></span>
<span><span class="fu"><a href="../reference/vaeac_plot_eval_crit.html">vaeac_plot_eval_crit</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Original"</span> <span class="op">=</span> <span class="va">expl_little_training</span>, <span class="st">"More epochs"</span> <span class="op">=</span> <span class="va">expl_train_more</span><span class="op">)</span>,</span>
<span>  plot_type <span class="op">=</span> <span class="st">"method"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac/continue-training-3.png"></p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Continue to train the vaeac model some more epochs</span></span>
<span><span class="va">expl_train_even_more</span> <span class="op">&lt;-</span> <span class="va">expl_train_more</span></span>
<span><span class="va">expl_train_even_more</span><span class="op">$</span><span class="va">internal</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">vaeac</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/vaeac_train_model_continue.html">vaeac_train_model_continue</a></span><span class="op">(</span></span>
<span>    explanation <span class="op">=</span> <span class="va">expl_train_even_more</span>,</span>
<span>    epochs_new <span class="op">=</span> <span class="fl">10</span>,</span>
<span>    x_train <span class="op">=</span> <span class="va">x_train</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute the Shapley values again but this time using the even more trained vaeac model</span></span>
<span><span class="va">expl_train_even_more_vaeac</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>  prediction_zero <span class="op">=</span> <span class="va">prediction_zero</span>,</span>
<span>  n_batches <span class="op">=</span> <span class="va">n_batches</span>,</span>
<span>  n_samples <span class="op">=</span> <span class="fl">250</span>,</span>
<span>  vaeac.extra_parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    vaeac.pretrained_vaeac_model <span class="op">=</span> <span class="va">expl_train_even_more</span><span class="op">$</span><span class="va">internal</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">vaeac</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Look at the training and validation errors.</span></span>
<span><span class="fu"><a href="../reference/vaeac_plot_eval_crit.html">vaeac_plot_eval_crit</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"Original"</span> <span class="op">=</span> <span class="va">expl_little_training</span>,</span>
<span>    <span class="st">"More epochs"</span> <span class="op">=</span> <span class="va">expl_train_more</span>,</span>
<span>    <span class="st">"Even more epochs"</span> <span class="op">=</span> <span class="va">expl_train_even_more</span></span>
<span>  <span class="op">)</span>,</span>
<span>  plot_type <span class="op">=</span> <span class="st">"method"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac/continue-training-4.png"></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Can also see how well vaeac generates data from the full joint distribution</span></span>
<span><span class="fu"><a href="../reference/vaeac_plot_imputed_ggpairs.html">vaeac_plot_imputed_ggpairs</a></span><span class="op">(</span></span>
<span>  explanation <span class="op">=</span> <span class="va">expl_train_even_more</span>,</span>
<span>  which_vaeac_model <span class="op">=</span> <span class="st">"best"</span>,</span>
<span>  x_true <span class="op">=</span> <span class="va">x_train</span></span>
<span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac/continue-training-5.png"></p>
<p>We can see that the extra training has decreased the MSEv score. The
Shapley value explanations have also changed, but they are often
comparable.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_MSEv_eval_crit.html">plot_MSEv_eval_crit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"Few epochs"</span> <span class="op">=</span> <span class="va">expl_little_training</span>,</span>
<span>  <span class="st">"More epochs"</span> <span class="op">=</span> <span class="va">expl_train_more_vaeac</span>,</span>
<span>  <span class="st">"Even more epochs"</span> <span class="op">=</span> <span class="va">expl_train_even_more_vaeac</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac/continue-training-2-1.png"></p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># We see that the Shapley values have changed, but they are often comparable</span></span>
<span><span class="fu"><a href="../reference/plot_SV_several_approaches.html">plot_SV_several_approaches</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"Few epochs"</span> <span class="op">=</span> <span class="va">expl_little_training</span>,</span>
<span>  <span class="st">"More epochs"</span> <span class="op">=</span> <span class="va">expl_train_more_vaeac</span>,</span>
<span>  <span class="st">"Even more epochs"</span> <span class="op">=</span> <span class="va">expl_train_even_more_vaeac</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac/continue-training-2-2.png"></p>
</div>
<div class="section level3">
<h3 id="early_stopping">Vaeac with early stopping<a class="anchor" aria-label="anchor" href="#early_stopping"></a>
</h3>
<p>If we do not want to specify the number of <code>epochs</code>, as we
are uncertain how many <code>epochs</code> it will take before the
<code>vaeac</code> model is properly trained, a good choice is to rather
use early stopping. This means that we can set <code>vaeac.epochs</code>
to a large number and let <code>vaeac.epochs_early_stopping</code> be
for example <code>5</code>. This means that the <code>vaeac</code> model
will stop the training procedure if there has been no improvement in the
validation score for <code>5</code> epochs.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Low value for `vaeac.epochs_early_stopping` here to build the vignette faster</span></span>
<span><span class="va">expl_early_stopping</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>  prediction_zero <span class="op">=</span> <span class="va">prediction_zero</span>,</span>
<span>  n_samples <span class="op">=</span> <span class="fl">250</span>,</span>
<span>  n_batches <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  verbose <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  vaeac.epochs <span class="op">=</span> <span class="fl">1000</span>, <span class="co"># Set it to a big number</span></span>
<span>  vaeac.n_vaeacs_initialize <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  vaeac.extra_parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>vaeac.epochs_early_stopping <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Setting up the `vaeac` approach.</span></span>
<span><span class="co">#&gt; Training the `vaeac` model with the provided parameters from scratch on CPU.</span></span>
<span><span class="co">#&gt; Using 'mcar_mask_generator' with 'masking_ratio = 0.5'.</span></span>
<span><span class="co">#&gt; The vaeac model contains 17032 trainable parameters.</span></span>
<span><span class="co">#&gt; Initializing vaeac number 1 of 2.</span></span>
<span><span class="co">#&gt; Initializing vaeac number 2 of 2.</span></span>
<span><span class="co">#&gt; Best vaeac inititalization was number 2 (of 2) with a training VLB = -4.566 after 2 epochs. Continue to train this inititalization.</span></span>
<span><span class="co">#&gt; Saving `best` vaeac model at epoch 3.</span></span>
<span><span class="co">#&gt; Saving `best_running` vaeac model at epoch 3.</span></span>
<span><span class="co">#&gt; Saving `best_running` vaeac model at epoch 4.</span></span>
<span><span class="co">#&gt; Saving `best` vaeac model at epoch 5.</span></span>
<span><span class="co">#&gt; Saving `best_running` vaeac model at epoch 5.</span></span>
<span><span class="co">#&gt; Saving `best_running` vaeac model at epoch 6.</span></span>
<span><span class="co">#&gt; Saving `best` vaeac model at epoch 7.</span></span>
<span><span class="co">#&gt; Saving `best_running` vaeac model at epoch 7.</span></span>
<span><span class="co">#&gt; Saving `best` vaeac model at epoch 8.</span></span>
<span><span class="co">#&gt; Saving `best_running` vaeac model at epoch 8.</span></span>
<span><span class="co">#&gt; Saving `best_running` vaeac model at epoch 9.</span></span>
<span><span class="co">#&gt; Saving `best` vaeac model at epoch 10.</span></span>
<span><span class="co">#&gt; Saving `best_running` vaeac model at epoch 10.</span></span>
<span><span class="co">#&gt; Saving `best_running` vaeac model at epoch 11.</span></span>
<span><span class="co">#&gt; Saving `best` vaeac model at epoch 12.</span></span>
<span><span class="co">#&gt; Saving `best_running` vaeac model at epoch 12.</span></span>
<span><span class="co">#&gt; No IWAE improvment in 2 epochs. Apply early stopping at epoch 14.</span></span>
<span><span class="co">#&gt; Saving `last` vaeac model at epoch 14.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Results of the `vaeac` training process:</span></span>
<span><span class="co">#&gt; Best epoch:             12.  VLB = -2.958    IWAE = -2.930   IWAE_running = -2.991</span></span>
<span><span class="co">#&gt; Best running avg epoch: 12.  VLB = -2.958    IWAE = -2.930   IWAE_running = -2.991</span></span>
<span><span class="co">#&gt; Last epoch:             14.  VLB = -2.971    IWAE = -2.955   IWAE_running = -2.996</span></span>
<span><span class="co">#&gt; Done with setting up the `vaeac` approach.</span></span>
<span><span class="co">#&gt; Generating Monte Carlo samples using `vaeac` for batch 1 of 1.</span></span>
<span><span class="co">#&gt; Preprocessing the explicands.</span></span>
<span><span class="co">#&gt; Generating the MC samples.</span></span>
<span><span class="co">#&gt; Postprocessing the Monte Carlo samples.</span></span>
<span></span>
<span><span class="co"># Look at the training and validation errors. We are quite happy with it.</span></span>
<span><span class="fu"><a href="../reference/vaeac_plot_eval_crit.html">vaeac_plot_eval_crit</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Vaeac early stopping"</span> <span class="op">=</span> <span class="va">expl_early_stopping</span><span class="op">)</span>,</span>
<span>  plot_type <span class="op">=</span> <span class="st">"method"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac/early-stopping-1-1.png"></p>
<p>However, we can train it further for a fixed amount of epochs if
desired. This can be in a setting where we are not happy with the IWAE
curve or we feel that we set <code>vaeac.epochs_early_stopping</code> to
a too low value or if the max number of epochs
(<code>vaeac.epochs</code>) were reached.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Make a copy of the explanation object which we are to train further.</span></span>
<span><span class="va">expl_early_stopping_train_more</span> <span class="op">&lt;-</span> <span class="va">expl_early_stopping</span></span>
<span></span>
<span><span class="co"># Continue to train the vaeac model some more epochs</span></span>
<span><span class="va">expl_early_stopping_train_more</span><span class="op">$</span><span class="va">internal</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">vaeac</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/vaeac_train_model_continue.html">vaeac_train_model_continue</a></span><span class="op">(</span></span>
<span>    explanation <span class="op">=</span> <span class="va">expl_early_stopping_train_more</span>,</span>
<span>    epochs_new <span class="op">=</span> <span class="fl">15</span>,</span>
<span>    x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>    verbose <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Can even do it twice if desired</span></span>
<span><span class="va">expl_early_stopping_train_more</span><span class="op">$</span><span class="va">internal</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">vaeac</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/vaeac_train_model_continue.html">vaeac_train_model_continue</a></span><span class="op">(</span></span>
<span>    explanation <span class="op">=</span> <span class="va">expl_early_stopping_train_more</span>,</span>
<span>    epochs_new <span class="op">=</span> <span class="fl">10</span>,</span>
<span>    x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>    verbose <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Look at the training and validation errors. We see some improvement</span></span>
<span><span class="fu"><a href="../reference/vaeac_plot_eval_crit.html">vaeac_plot_eval_crit</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"Vaeac early stopping"</span> <span class="op">=</span> <span class="va">expl_early_stopping</span>,</span>
<span>    <span class="st">"Vaeac early stopping more epochs"</span> <span class="op">=</span> <span class="va">expl_early_stopping_train_more</span></span>
<span>  <span class="op">)</span>,</span>
<span>  plot_type <span class="op">=</span> <span class="st">"method"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac/early-stopping-2-1.png"></p>
<p>We can then use the extra trained version to compute the Shapley
value explanations and compare it with the previous version that used
early stopping. We see a non-significant difference.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Use extra trained vaeac model to compute Shapley values again.</span></span>
<span><span class="va">expl_early_stopping_train_more</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>  prediction_zero <span class="op">=</span> <span class="va">prediction_zero</span>,</span>
<span>  n_batches <span class="op">=</span> <span class="va">n_batches</span>,</span>
<span>  n_samples <span class="op">=</span> <span class="fl">250</span>,</span>
<span>  vaeac.extra_parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    vaeac.pretrained_vaeac_model <span class="op">=</span> <span class="va">expl_early_stopping_train_more</span><span class="op">$</span><span class="va">internal</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">vaeac</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span></span>
<span><span class="co"># We can compare their MSEv scores</span></span>
<span><span class="fu"><a href="../reference/plot_MSEv_eval_crit.html">plot_MSEv_eval_crit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"Vaeac early stopping"</span> <span class="op">=</span> <span class="va">expl_early_stopping</span>,</span>
<span>  <span class="st">"Vaeac early stopping more epochs"</span> <span class="op">=</span> <span class="va">expl_early_stopping_train_more</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac/early-stopping-3-1.png"></p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># We see that the Shapley values have changed, but only slightly</span></span>
<span><span class="fu"><a href="../reference/plot_SV_several_approaches.html">plot_SV_several_approaches</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"Vaeac early stopping"</span> <span class="op">=</span> <span class="va">expl_early_stopping</span>,</span>
<span>  <span class="st">"Vaeac early stopping more epochs"</span> <span class="op">=</span> <span class="va">expl_early_stopping_train_more</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac/early-stopping-3-2.png"></p>
</div>
<div class="section level3">
<h3 id="grouping_of_features">Grouping of features<a class="anchor" aria-label="anchor" href="#grouping_of_features"></a>
</h3>
<p>When we train a <code>vaeac</code> model to explain groups of
features, then the <code>vaeac</code> model will use the
â€œSpecified_masks_mask_generatorâ€ which ensures that the
<code>vaeac</code> model only train on a specified set of coalitions. In
this case, it will ensure that all features in group A will always
either be conditioned on or be unconditioned. The same goes for group B.
Note that in this setup, there are only <code>4</code> possible
coalitions, but <code>vaeac</code> only train on <code>2</code>
coalitions as the empty and grand coalitions as they are not needed in
the Shapley value computations.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">expl_group</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>  prediction_zero <span class="op">=</span> <span class="va">prediction_zero</span>,</span>
<span>  group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>A <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Temp"</span>, <span class="st">"Month"</span><span class="op">)</span>, B <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Wind"</span>, <span class="st">"Solar.R"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  n_batches <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  n_samples <span class="op">=</span> <span class="va">n_samples</span>,</span>
<span>  verbose <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  vaeac.epochs <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  vaeac.n_vaeacs_initialize <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span><span class="co">#&gt; Setting up the `vaeac` approach.</span></span>
<span><span class="co">#&gt; Training the `vaeac` model with the provided parameters from scratch on CPU.</span></span>
<span><span class="co">#&gt; Using 'specified_masks_mask_generator' with '2' coalitions.</span></span>
<span><span class="co">#&gt; The vaeac model contains 17032 trainable parameters.</span></span>
<span><span class="co">#&gt; Initializing vaeac number 1 of 2.</span></span>
<span><span class="co">#&gt; Initializing vaeac number 2 of 2.</span></span>
<span><span class="co">#&gt; Best vaeac inititalization was number 2 (of 2) with a training VLB = -4.814 after 2 epochs. Continue to train this inititalization.</span></span>
<span><span class="co">#&gt; Saving `best` vaeac model at epoch 3.</span></span>
<span><span class="co">#&gt; Saving `best_running` vaeac model at epoch 3.</span></span>
<span><span class="co">#&gt; Saving `best_running` vaeac model at epoch 4.</span></span>
<span><span class="co">#&gt; Saving `last` vaeac model at epoch 4.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Results of the `vaeac` training process:</span></span>
<span><span class="co">#&gt; Best epoch:             3.   VLB = -3.935    IWAE = -3.124   IWAE_running = -3.267</span></span>
<span><span class="co">#&gt; Best running avg epoch: 4.   VLB = -3.619    IWAE = -3.138   IWAE_running = -3.235</span></span>
<span><span class="co">#&gt; Last epoch:             4.   VLB = -3.619    IWAE = -3.138   IWAE_running = -3.235</span></span>
<span><span class="co">#&gt; Done with setting up the `vaeac` approach.</span></span>
<span><span class="co">#&gt; Generating Monte Carlo samples using `vaeac` for batch 1 of 2.</span></span>
<span><span class="co">#&gt; Preprocessing the explicands.</span></span>
<span><span class="co">#&gt; Generating the MC samples.</span></span>
<span><span class="co">#&gt; Postprocessing the Monte Carlo samples.</span></span>
<span><span class="co">#&gt; Generating Monte Carlo samples using `vaeac` for batch 2 of 2.</span></span>
<span><span class="co">#&gt; Preprocessing the explicands.</span></span>
<span><span class="co">#&gt; Generating the MC samples.</span></span>
<span><span class="co">#&gt; Postprocessing the Monte Carlo samples.</span></span>
<span></span>
<span><span class="co"># Plot the resulting explanations</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">expl_group</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac/vaeac-grouping-of-features-1.png"></p>
</div>
<div class="section level3">
<h3 id="mixed_data">Mixed Data<a class="anchor" aria-label="anchor" href="#mixed_data"></a>
</h3>
<p>Here we look at a setup with mixed data, i.e., the data contains both
categorical and continuous features. First we set up the data and the
model.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://imbs-hl.github.io/ranger/" class="external-link">ranger</a></span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html" class="external-link">complete.cases</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co"># convert the month variable to a factor</span></span>
<span><span class="va">data</span><span class="op">[</span>, <span class="va">Month_factor</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">Month</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">x_var_cat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Solar.R"</span>, <span class="st">"Wind"</span>, <span class="st">"Temp"</span>, <span class="st">"Month_factor"</span><span class="op">)</span></span>
<span><span class="va">y_var</span> <span class="op">&lt;-</span> <span class="st">"Ozone"</span></span>
<span></span>
<span><span class="va">ind_x_explain</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">6</span></span>
<span></span>
<span><span class="va">data_train_cat</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="op">-</span><span class="va">ind_x_explain</span>, <span class="op">]</span></span>
<span><span class="va">x_train_cat</span> <span class="op">&lt;-</span> <span class="va">data_train_cat</span><span class="op">[</span>, <span class="va">..x_var_cat</span><span class="op">]</span></span>
<span><span class="va">x_explain_cat</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="va">ind_x_explain</span>, <span class="op">]</span><span class="op">[</span>, <span class="va">..x_var_cat</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Fit a random forest model to the training data</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://imbs-hl.github.io/ranger/reference/ranger.html" class="external-link">ranger</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">y_var</span>, <span class="st">" ~ "</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">x_var_cat</span>, collapse <span class="op">=</span> <span class="st">" + "</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">data_train_cat</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Specifying the phi_0, i.e. the expected prediction without any features</span></span>
<span><span class="va">prediction_zero</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">data_train_cat</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">y_var</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>Then we compute explanations using the <code>ctree</code> and
<code>vaeac</code> approaches. For the <code>vaeac</code> approach, we
consider two setups: the default architecture, and a simpler one without
skip connections. We do this to illustrate that the skip connections
improve the <code>vaeac</code> method. We use <code>ctree</code> with
default parameters.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Here we use the ctree approach</span></span>
<span><span class="va">expl_ctree</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain_cat</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train_cat</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"ctree"</span>,</span>
<span>  prediction_zero <span class="op">=</span> <span class="va">prediction_zero</span>,</span>
<span>  n_batches <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  n_samples <span class="op">=</span> <span class="fl">250</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span></span>
<span><span class="co"># Then we use the vaeac approach</span></span>
<span><span class="va">expl_vaeac_with</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain_cat</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train_cat</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>  prediction_zero <span class="op">=</span> <span class="va">prediction_zero</span>,</span>
<span>  n_batches <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  n_samples <span class="op">=</span> <span class="fl">250</span>,</span>
<span>  vaeac.epochs <span class="op">=</span> <span class="fl">50</span>,</span>
<span>  vaeac.n_vaeacs_initialize <span class="op">=</span> <span class="fl">4</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span></span>
<span><span class="co"># Then we use the vaeac approach</span></span>
<span><span class="va">expl_vaeac_without</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model</span>,</span>
<span>  x_explain <span class="op">=</span> <span class="va">x_explain_cat</span>,</span>
<span>  x_train <span class="op">=</span> <span class="va">x_train_cat</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>  prediction_zero <span class="op">=</span> <span class="va">prediction_zero</span>,</span>
<span>  n_batches <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  n_samples <span class="op">=</span> <span class="fl">250</span>,</span>
<span>  vaeac.epochs <span class="op">=</span> <span class="fl">50</span>,</span>
<span>  vaeac.n_vaeacs_initialize <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  vaeac.extra_parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    vaeac.skip_conn_layer <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    vaeac.skip_conn_masked_enc_dec <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: Feature classes extracted from the model contains NA.</span></span>
<span><span class="co">#&gt; Assuming feature classes from the data are correct.</span></span>
<span></span>
<span><span class="co"># We see that the `vaeac` model without the skip connections perform worse</span></span>
<span><span class="fu"><a href="../reference/vaeac_plot_eval_crit.html">vaeac_plot_eval_crit</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"Vaeac w.o. skip-con."</span> <span class="op">=</span> <span class="va">expl_vaeac_without</span>,</span>
<span>    <span class="st">"Vaeac w. skip-con."</span> <span class="op">=</span> <span class="va">expl_vaeac_with</span></span>
<span>  <span class="op">)</span>,</span>
<span>  plot_type <span class="op">=</span> <span class="st">"criterion"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac/vaeac-mixed-data-1.png"></p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># The vaeac model with skip connections have the lowest/best MSE_Frye evaluation criterion score</span></span>
<span><span class="fu"><a href="../reference/plot_MSEv_eval_crit.html">plot_MSEv_eval_crit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"Vaeac w.o. skip-con."</span> <span class="op">=</span> <span class="va">expl_vaeac_without</span>,</span>
<span>  <span class="st">"Vaeac w. skip-con."</span> <span class="op">=</span> <span class="va">expl_vaeac_with</span>,</span>
<span>  <span class="st">"Ctree"</span> <span class="op">=</span> <span class="va">expl_ctree</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac/vaeac-mixed-data-2.png"></p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Can compare the Shapley values. Ctree and vaeac with skip connections produce similar explanations.</span></span>
<span><span class="fu"><a href="../reference/plot_SV_several_approaches.html">plot_SV_several_approaches</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"Vaeac w.o. skip-con."</span> <span class="op">=</span> <span class="va">expl_vaeac_without</span>,</span>
<span>    <span class="st">"Vaeac w. skip-con."</span> <span class="op">=</span> <span class="va">expl_vaeac_with</span>,</span>
<span>    <span class="st">"Ctree"</span> <span class="op">=</span> <span class="va">expl_ctree</span></span>
<span>  <span class="op">)</span>,</span>
<span>  index_explicands <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">6</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac/vaeac-mixed-data-3.png"></p>
</div>
<div class="section level3">
<h3 id="cpu_vs_gpu">CPU vs GPU<a class="anchor" aria-label="anchor" href="#cpu_vs_gpu"></a>
</h3>
<p>In this section, we create a small setup for comparing the efficiency
of using GPU and CPU. For small tabular data sets, there are often no
benefit of using a GPU. However, this depends on what kind of CPU and
GPU the user has access to. As our CPU, we use a 13th Gen Intel(R)
Core(TM) i7-13700H 2.40 GHz and 32.0 GB 4800 MHz RAM. While for the GPU,
we use a NVIDIA GeForce RTX 4050 Laptop with 6 GB dedicated memory and
16 GB shared. Furthermore, the times depends on several factors, e.g.,
the number of training observations, explicands, features, and
batches.</p>
<p>Finally, note that if the user specifies
<code>vaeac.cuda = TRUE</code>, but there is no available GPU, then
<code>vaeac</code> provides a warning and falls back to use CPU
instead.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load necessary library</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://mvtnorm.R-forge.R-project.org" class="external-link">mvtnorm</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set seed for reproducibility</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Number of observations</span></span>
<span><span class="va">n_train</span> <span class="op">&lt;-</span> <span class="fl">250</span></span>
<span><span class="va">n_explain</span> <span class="op">&lt;-</span> <span class="fl">25</span></span>
<span></span>
<span><span class="co"># Number of variables</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">8</span></span>
<span></span>
<span><span class="co"># Generate random data from a multivariate normal distribution</span></span>
<span><span class="va">mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">p</span><span class="op">)</span> <span class="co"># mean vector</span></span>
<span><span class="va">rho</span> <span class="op">&lt;-</span> <span class="fl">0.7</span></span>
<span><span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">rho</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">p</span>, ncol <span class="op">=</span> <span class="va">p</span><span class="op">)</span> <span class="co"># covariance matrix</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">x_train</span> <span class="op">&lt;-</span> <span class="fu">mvtnorm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mvtnorm/man/Mvnorm.html" class="external-link">rmvnorm</a></span><span class="op">(</span><span class="va">n_train</span>, <span class="va">mean</span>, <span class="va">sigma</span><span class="op">)</span></span>
<span><span class="va">x_explain</span> <span class="op">&lt;-</span> <span class="fu">mvtnorm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mvtnorm/man/Mvnorm.html" class="external-link">rmvnorm</a></span><span class="op">(</span><span class="va">n_explain</span>, <span class="va">mean</span>, <span class="va">sigma</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create response variable based on linear combinations of variables</span></span>
<span><span class="va">coefficients</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">p</span><span class="op">)</span></span>
<span><span class="va">y_train</span> <span class="op">&lt;-</span> <span class="va">x_train</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">coefficients</span></span>
<span><span class="va">y_explain</span> <span class="op">&lt;-</span> <span class="va">x_explain</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">coefficients</span></span>
<span></span>
<span><span class="co"># Combine data and response into a data table</span></span>
<span><span class="va">dt_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span><span class="va">y_train</span>, <span class="va">x_train</span><span class="op">)</span></span>
<span><span class="va">dt_explain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span><span class="va">y_explain</span>, <span class="va">x_explain</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">dt_train</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">dt_explain</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"y"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x_train</span> <span class="op">&lt;-</span> <span class="va">dt_train</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">x_explain</span> <span class="op">&lt;-</span> <span class="va">dt_explain</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Create model</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">.</span>, <span class="va">dt_train</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Specifying the phi_0, i.e. the expected prediction without any features</span></span>
<span><span class="va">prediction_zero</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">y_train</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fit vaeac model using the CPU</span></span>
<span><span class="va">time_cpu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">explanation_cpu</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>    model <span class="op">=</span> <span class="va">model</span>,</span>
<span>    x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>    x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>    approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>    prediction_zero <span class="op">=</span> <span class="va">prediction_zero</span>,</span>
<span>    n_samples <span class="op">=</span> <span class="fl">100</span>,</span>
<span>    n_batches <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    vaeac.epochs <span class="op">=</span> <span class="fl">50</span>,</span>
<span>    vaeac.n_vaeacs_initialize <span class="op">=</span> <span class="fl">2</span>,</span>
<span>    vaeac.extra_parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>vaeac.cuda <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fit vaeac model using the GPU</span></span>
<span><span class="va">time_cuda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">explanation_cuda</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span></span>
<span>    model <span class="op">=</span> <span class="va">model</span>,</span>
<span>    x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span>
<span>    x_train <span class="op">=</span> <span class="va">x_train</span>,</span>
<span>    approach <span class="op">=</span> <span class="st">"vaeac"</span>,</span>
<span>    prediction_zero <span class="op">=</span> <span class="va">prediction_zero</span>,</span>
<span>    n_samples <span class="op">=</span> <span class="fl">100</span>,</span>
<span>    n_batches <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    vaeac.epochs <span class="op">=</span> <span class="fl">50</span>,</span>
<span>    vaeac.n_vaeacs_initialize <span class="op">=</span> <span class="fl">2</span>,</span>
<span>    vaeac.extra_parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>vaeac.cuda <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Look at the internal and external timing. See that the times comparable.</span></span>
<span><span class="co"># Note that these times highly depend on the CPU/GPU version.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="st">"Vaeac CPU"</span> <span class="op">=</span> <span class="va">explanation_cpu</span><span class="op">$</span><span class="va">timing</span><span class="op">$</span><span class="va">timing_secs</span>,</span>
<span>      <span class="st">"Vaeac GPU"</span> <span class="op">=</span> <span class="va">explanation_cuda</span><span class="op">$</span><span class="va">timing</span><span class="op">$</span><span class="va">timing_secs</span><span class="op">)</span></span>
<span><span class="co">#&gt;                setup test_prediction setup_computation compute_vS shapley_computation</span></span>
<span><span class="co">#&gt; Vaeac CPU 0.04163814      0.02751589          54.46604   7.096326         0.005872011</span></span>
<span><span class="co">#&gt; Vaeac GPU 0.03711700      0.02697015          72.71818   7.599831         0.010197163</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="st">"Vaeac CPU"</span> <span class="op">=</span> <span class="va">time_cpu</span>, <span class="st">"Vaeac GPU"</span> <span class="op">=</span> <span class="va">time_cuda</span><span class="op">)</span></span>
<span><span class="co">#&gt;           user.self sys.self elapsed user.child sys.child</span></span>
<span><span class="co">#&gt; Vaeac CPU     57.61     2.69   61.64         NA        NA</span></span>
<span><span class="co">#&gt; Vaeac GPU     73.79     6.37   80.39         NA        NA</span></span></code></pre></div>
<p>It is no possible to set same random state on the CPU and GPU, hence,
the results are not equivalent. The difference is due to different
initialization values.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/vaeac_plot_eval_crit.html">vaeac_plot_eval_crit</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Vaeac CPU"</span> <span class="op">=</span> <span class="va">explanation_cpu</span>, <span class="st">"Vaeac GPU"</span> <span class="op">=</span> <span class="va">explanation_cuda</span><span class="op">)</span>,</span>
<span>  plot_type <span class="op">=</span> <span class="st">"criterion"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac/vaeac-cpu-gpu-1-1.png"></p>
<p>We also get almost identical <span class="math inline">\(\text{MSE}_v\)</span> values.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_MSEv_eval_crit.html">plot_MSEv_eval_crit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Vaeac CPU"</span> <span class="op">=</span> <span class="va">explanation_cpu</span>,</span>
<span><span class="st">"Vaeac GPU"</span> <span class="op">=</span> <span class="va">explanation_cuda</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac/vaeac-cpu-gpu-2-1.png"></p>
<p>We can also compare the Shapley values and see that we get comparable
explanations.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_SV_several_approaches.html">plot_SV_several_approaches</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Vaeac CPU"</span> <span class="op">=</span> <span class="va">explanation_cpu</span>, <span class="st">"Vaeac GPU"</span> <span class="op">=</span> <span class="va">explanation_cuda</span><span class="op">)</span>,</span>
<span>  index_explicands <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,</span>
<span>  facet_ncol <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  digits <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="figure_vaeac/vaeac-cpu-gpu-3-1.png"></p>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-torch" class="csl-entry">
Falbel, Daniel, and Javier Luraschi. 2023. <em>Torch: Tensors and Neural
Networks with â€™GPUâ€™ Acceleration</em>. <a href="https://CRAN.R-project.org/package=torch" class="external-link">https://CRAN.R-project.org/package=torch</a>.
</div>
<div id="ref-kingma2014autoencoding" class="csl-entry">
Kingma, Diederik P., and Max Welling. 2014. <span>â€œ<span>Auto-Encoding
Variational Bayes</span>.â€</span> In <em>2nd International Conference on
Learning Representations, <span>ICLR</span> 2014, Banff, AB, Canada,
April 14-16, 2014, Conference Track Proceedings</em>.
</div>
<div id="ref-olsen2022using" class="csl-entry">
Olsen, Lars Henry Berge, Ingrid Kristine Glad, Martin Jullum, and
Kjersti Aas. 2022. <span>â€œUsing Shapley Values and Variational
Autoencoders to Explain Predictive Models with Dependent Mixed
Features.â€</span> <em>Journal of Machine Learning Research</em> 23
(213): 1â€“51.
</div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Nikolai Sellereite, Martin Jullum, Lars Henry Berge Olsen, Annabelle Redelmeier, Jon Lachmann, Norsk Regnesentral.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
